<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>è®¸å˜‰åçš„åšå®¢</title>
    <link>https://xujiahua.github.io/</link>
    <description>Recent content on è®¸å˜‰åçš„åšå®¢</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Tue, 21 Apr 2020 09:01:38 +0800</lastBuildDate>
    
        <atom:link href="https://xujiahua.github.io/index.xml" rel="self" type="application/rss+xml" />
    
    
    
        <item>
        <title>consul å°ç»“</title>
        <link>https://xujiahua.github.io/posts/20200421-use-consul/</link>
        <pubDate>Tue, 21 Apr 2020 09:01:38 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200421-use-consul/</guid>
        <description>è®¸å˜‰åçš„åšå®¢ https://xujiahua.github.io/posts/20200421-use-consul/ -&lt;h2 id=&#34;ç®€å•ä»‹ç»&#34;&gt;ç®€å•ä»‹ç»&lt;/h2&gt;
&lt;p&gt;hashicorp å¯¹ Consul çš„å®šä½æ˜¯æœåŠ¡é—´ç½‘ç»œæ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Consul is a service networking solution to connect and secure services across any runtime platform and public or private cloud. &lt;a href=&#34;https://www.consul.io/&#34;&gt;https://www.consul.io/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å®˜æ–¹çš„ä¸¤ä¸ª use case å°±æ˜¯ service discovery, service meshã€‚&lt;/p&gt;
&lt;h3 id=&#34;service-discovery&#34;&gt;service discovery&lt;/h3&gt;
&lt;p&gt;ä¸ etcd æ¯”èµ·æ¥ï¼ŒConsul çš„æœåŠ¡å‘ç°æ˜¯å¼€ç®±å³ç”¨çš„ã€‚ä¼˜ç‚¹å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;First class çš„æœåŠ¡æ³¨å†Œå’Œè·å–æ¥å£ã€‚ä¸éœ€è¦åƒ etcd é‚£æ ·åœ¨ kv å­˜å‚¨åŸºç¡€ä¸ŠåšåŒ…è£…ã€‚&lt;/li&gt;
&lt;li&gt;æœåŠ¡æ³¨å†Œï¼Œå¯ä»¥æ˜¯consul å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥æ˜¯HTTP APIã€‚&lt;/li&gt;
&lt;li&gt;è·å–æœåŠ¡æ³¨å†Œè¡¨ï¼Œé™¤äº† HTTP æ¥å£ï¼Œè¿˜å¯ä»¥ä½¿ç”¨  DNS æŸ¥è¯¢æ¥å£ã€‚&lt;/li&gt;
&lt;li&gt;å¥åº·æ£€æŸ¥ã€‚æœåŠ¡æ³¨å†Œçš„æ—¶å€™å¯ä»¥æä¾›å¥åº·æ£€æŸ¥é¡¹ã€‚å¥åº·æ£€æŸ¥æœºåˆ¶ä¿è¯äº†æ‹¿åˆ°çš„æœåŠ¡æ³¨å†Œè¡¨æ˜¯â€œå¥åº·â€çš„ã€‚å¥åº·æ£€æŸ¥ä¹ŸåŒ…æ‹¬èŠ‚ç‚¹çš„æ£€æŸ¥ã€‚å•çº¯åˆ©ç”¨ consul å¥åº·æ£€æŸ¥è¿™ä¸ªåŠŸèƒ½ï¼Œconsul å°±æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç›‘æ§å·¥å…·ã€‚&lt;/li&gt;
&lt;li&gt;Web ç®¡ç†ç•Œé¢ã€‚èŠ‚ç‚¹ã€æœåŠ¡ã€å¥åº·ä¸å¦ä¸€ç›®äº†ç„¶ã€‚&lt;/li&gt;
&lt;li&gt;Watch åŠŸèƒ½ã€‚é€šè¿‡ blocking queries/ long-polling HTTP API çš„æ–¹å¼å¾—åˆ°æœåŠ¡æ³¨å†Œè¡¨çš„æ”¹å˜çš„é€šçŸ¥ã€‚&lt;/li&gt;
&lt;li&gt;è·¨æ•°æ®ä¸­å¿ƒï¼ˆå–èµ„æºï¼‰ã€‚When a request is made for a resource in another datacenter, the local Consul servers forward an RPC request to the remote Consul servers for that resource and return the results. &lt;a href=&#34;https://learn.hashicorp.com/consul/security-networking/datacenters#data-replication&#34;&gt;https://learn.hashicorp.com/consul/security-networking/datacenters#data-replication&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;service-mesh&#34;&gt;service mesh&lt;/h3&gt;
&lt;p&gt;service discovery åªæ˜¯å¾®æœåŠ¡æ²»ç†çš„åˆçº§é˜¶æ®µã€‚ä½œä¸ºæœåŠ¡è¯·æ±‚æ–¹ï¼Œé€šè¿‡ consul/ etcd è·å–åˆ°æœåŠ¡æ³¨å†Œè¡¨ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯é€‰æ‹©å…¶ä¸­ä¸€ä¸ªæœåŠ¡å®ä¾‹ï¼Œå‘é€è¯·æ±‚ã€‚è¿™ä¸ªæ­¥éª¤å«åšè´Ÿè½½å‡è¡¡ã€‚å¯ä»¥æƒ³è±¡ï¼Œå®¢æˆ·ç«¯çš„ä»£ç ä¼šè¶Šæ¥è¶Šé‡äº†ã€‚&lt;/p&gt;
&lt;p&gt;service meshå¯ä»¥ç†è§£ä¸º service discoveryçš„å‡çº§ç‰ˆã€‚ä¸ºæ¯ä¸ªæœåŠ¡å®ä¾‹å¼•å…¥ sidecar proxyï¼Œæ¥ç®¡æœåŠ¡å®ä¾‹çš„å…¥ã€å‡ºæµé‡ã€‚å°† service discoveryï¼Œload balancer ä» service æœ¬èº«æŠ½ç¦»å‡ºæ¥ï¼Œä¸‹æ²‰åˆ°åŸºç¡€è®¾æ–½ï¼Œä¹Ÿå°±æ˜¯ sidecar proxyã€‚&lt;/p&gt;
&lt;p&gt;sidecar proxy ä¸Šçš„åŠŸèƒ½è¿˜æœ‰æ›´å¤šæ‰©å±•ï¼Œæ¯”å¦‚ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è“ç»¿éƒ¨ç½²ï¼ŒA/B æµ‹è¯•ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼Œä¸€ä¸ªæœåŠ¡å­˜åœ¨ä¸¤ä¸ªç‰ˆæœ¬v1, v2ï¼Œç»™v1åˆ†é…80%çš„æµé‡ï¼Œç»™v2åˆ†é…20%çš„æµé‡ã€‚&lt;/li&gt;
&lt;li&gt;æµé‡åŠ å¯†ã€‚authentication and authorizationã€‚&lt;/li&gt;
&lt;li&gt;æœåŠ¡æŒ‡æ ‡çš„æ”¶é›†ã€‚æ¯”å¦‚HTTPåè®®çš„è¿”å›çŠ¶æ€ç ã€‚&lt;/li&gt;
&lt;li&gt;è°ƒç”¨é“¾è¿½è¸ªã€‚&lt;/li&gt;
&lt;li&gt;Intentionã€‚å¯ä»¥è®¾ç½®æœåŠ¡ä¸æœåŠ¡ä¹‹é—´æ˜¯å¦å…è®¸è¿æ¥ã€‚Intentions define service based access control for services in the Consul service mesh and are used to control which services are allowed or not allowed to establish connections.&lt;/li&gt;
&lt;li&gt;è¿™ä¸€åˆ‡æœåŠ¡æœ¬èº«æ˜¯æ— æ„ŸçŸ¥çš„ã€‚è¿™ä¹Ÿç®€åŒ–äº†åº”ç”¨çš„å¼€å‘ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è¿™å°±æ˜¯ Consul Connect çš„åŠŸèƒ½ã€‚ä¸ä¹‹å¯¹åº”çš„ç«å“æ˜¯ Istioã€‚&lt;/p&gt;
&lt;p&gt;å½“ç„¶ï¼Œä¸€åˆ‡éƒ½æœ‰ä»£ä»·ã€‚&lt;strong&gt;ç»™æ¯ä¸ªæœåŠ¡å®ä¾‹åˆ›å»ºä¸€ä¸ªsidecar proxyï¼Œè¿™åœ¨éƒ¨ç½²ä¸Šéœ€è¦åšå¥½å‡†å¤‡ã€‚ä½¿ç”¨ Kubernetes å¯ä»¥æé«˜æ•ˆç‡ï¼Œä¼šå¸®åŠ©è‡ªåŠ¨åˆ›å»º sidecar proxyã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&#34;key-value-store&#34;&gt;key value store&lt;/h3&gt;
&lt;p&gt;consul ä¹Ÿèƒ½å½“ kv store ä½¿ç”¨ï¼Œè¿™æ˜¯æœåŠ¡å‘ç°çš„åº•å­ã€‚ä½¿ç”¨æ–¹å¼è·Ÿ etcd å·®ä¸å¤šã€‚&lt;/p&gt;
&lt;p&gt;etcd å®˜æ–¹ä¸ consul åšäº†æ¯”è¾ƒã€‚consul åœ¨å­˜å‚¨æ‰©å±•æ€§ä¸Šä¸å¤Ÿå¥½ã€‚ä¹Ÿç¼ºå°‘KEYå¤šç‰ˆæœ¬å­˜å‚¨ï¼Œä¸æ–¹ä¾¿è¿½æº¯å†å²ã€‚key value store è¿™ä¸ªåœºæ™¯ï¼Œetcd æ˜¯æ›´åˆé€‚çš„ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/coreos/dbtester/tree/master/test-results/2018Q1-02-etcd-zookeeper-consul&#34;&gt;As it stands in Consul 1.0&lt;/a&gt;, the storage system does not scale as well as other systems like etcd or Zookeeper in key-value operations; systems requiring millions of keys will suffer from high latencies and memory pressure. The key value API is missing, most notably, multi-version keys, conditional transactions, and reliable streaming watches.&lt;/p&gt;
&lt;p&gt;etcd and Consul solve different problems. If looking for a distributed consistent key value store, etcd is a better choice over Consul. If looking for end-to-end cluster service discovery, etcd will not have enough features; choose Kubernetes, Consul, or SmartStack.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/etcd-io/etcd/blob/master/Documentation/learning/why.md#consul&#34;&gt;https://github.com/etcd-io/etcd/blob/master/Documentation/learning/why.md#consul&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;consul client agentçš„ä¸»è¦å·¥ä½œæ˜¯å¥åº·æ£€æŸ¥ï¼Œæ‰€ä»¥å¦‚æœåªæ˜¯key value storeçš„ä½¿ç”¨åœºæ™¯ï¼Œå¯ä»¥ç›´æ¥ä¸ consul server agent äº¤äº’ï¼Œå°±åƒä½¿ç”¨ etcd é‚£æ ·ã€‚&lt;/p&gt;
&lt;h3 id=&#34;distributed-system-coordinate&#34;&gt;distributed system coordinate&lt;/h3&gt;
&lt;p&gt;åˆ†å¸ƒå¼é”ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„åè°ƒ &lt;a href=&#34;https://www.consul.io/docs/internals/sessions.html&#34;&gt;https://www.consul.io/docs/internals/sessions.html&lt;/a&gt; ã€‚ä½¿ç”¨åœºæ™¯æ¯”å¦‚Hadoopç³»ç»Ÿçš„é€‰ä¸»ã€‚ä¸è¿‡å¤§éƒ¨åˆ†å¼€æºåˆ†å¸ƒå¼ç³»ç»ŸåŸºæœ¬ä¸Šä½¿ç”¨zookeeperå’Œetcdã€‚&lt;/p&gt;
&lt;h2 id=&#34;æ ¸å¿ƒæ¦‚å¿µ&#34;&gt;æ ¸å¿ƒæ¦‚å¿µ&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;../../images/consul-arch-420ce04a.png&#34; alt=&#34;Consul Architecture&#34;&gt;&lt;/p&gt;
&lt;p&gt;Consul æ¶æ„å›¾&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;åç§°&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;node&lt;/td&gt;
&lt;td&gt;æ¯ä¸ª node å®‰è£…å¹¶è¿è¡Œ consul agentã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;consul server agent&lt;/td&gt;
&lt;td&gt;1ï¼‰ç»´æŠ¤æ ¸å¿ƒçŠ¶æ€å¹¶åŸºäºå…±è¯†ç®—æ³• consensus protocol raft å‚ä¸leaderé€‰ä¸¾ã€‚2ï¼‰serverèŠ‚ç‚¹ä¸€èˆ¬å»ºè®®3ä¸ªæˆ–æ˜¯5ä¸ªã€‚å†™å‹åŠ›å¤§çš„é›†ç¾¤ï¼Œè€ƒè™‘å‡çº§æœåŠ¡å™¨å®ä¾‹çš„é…ç½®å’Œä½å»¶è¿Ÿçš„å­˜å‚¨ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;consul client agent&lt;/td&gt;
&lt;td&gt;1ï¼‰å½“å‰èŠ‚ç‚¹ã€å½“å‰èŠ‚ç‚¹ä¸Šçš„æœåŠ¡çš„å¥åº·æ£€æŸ¥ã€‚2ï¼‰RPCè¯·æ±‚è½¬å‘åˆ° consul server agentã€‚3ï¼‰æ¯ä¸ªä¸»æœºéƒ½æœ‰ä¸€ä¸ªagentçš„å¥½å¤„æ˜¯ï¼Œåªè¦ä¸æœ¬åœ°agenté€šä¿¡ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Datacenter&lt;/td&gt;
&lt;td&gt;å¯ä»¥ç†è§£ä¸ºä¸€ä¸ª consul é›†ç¾¤ã€‚ä¸€ä¸ªconsul é›†ç¾¤è‡³å°‘æœ‰ä¸€ä¸ª consul server agentã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;LAN gossip pool&lt;/td&gt;
&lt;td&gt;å•ä¸ª Datacenter å†…ï¼Œç”± consul server agent å’Œ consul client agent ç»„æˆã€‚poolå†…æˆå‘˜é€šè¿‡ gossip protocol é€šä¿¡ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WAN gossip pool&lt;/td&gt;
&lt;td&gt;è·¨ Datacenterï¼Œç”±æ‰€æœ‰ Datacenter å†…çš„ consul server agent ç»„æˆã€‚å¯ä»¥è·¨ç½‘ç»œé€šä¿¡ã€‚poolå†…æˆå‘˜é€šè¿‡ gossip protocol é€šä¿¡ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;service&lt;/td&gt;
&lt;td&gt;ä¸€ä¸ªserviceå¯¹åº”å¤šä¸ªserviceå®ä¾‹ï¼Œæ³¨å†Œæ—¶ä½¿ç”¨ç›¸åŒçš„service_nameï¼Œå¹¶ä½¿ç”¨ä¸åŒçš„service_idåŒºåˆ†å®ä¾‹ã€‚&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://www.consul.io/docs/internals/architecture.html&#34;&gt;https://www.consul.io/docs/internals/architecture.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.consul.io/docs/glossary.html&#34;&gt;https://www.consul.io/docs/glossary.html&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;consul-connect-ä½“éªŒ&#34;&gt;Consul Connect ä½“éªŒ&lt;/h2&gt;
&lt;h3 id=&#34;1-quickstart-consul-connect&#34;&gt;1. Quickstart: Consul Connect&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;../../images/consul_connect_demo_service_flow.png&#34; alt=&#34;Flow diagram showing end user traffic being sent to the Dashboard Service at port 9002. The dashboard service makes requests for the counting service to the local Connect Proxy at port 5000. This traffic then traverses the Connect mesh over dynamic ports. The traffic exits the Connect mesh from the counting service&amp;rsquo;s local proxy. The proxy sends this traffic to the counting service itself at port 9003.&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Secure Service-to-Service Communication &lt;a href=&#34;https://learn.hashicorp.com/consul/developer-mesh/connect-services&#34;&gt;https://learn.hashicorp.com/consul/developer-mesh/connect-services&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;code &lt;a href=&#34;https://github.com/hashicorp/demo-consul-101&#34;&gt;https://github.com/hashicorp/demo-consul-101&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ç®€å•è¯´æ˜ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;consul agent -dev -config-dir=&amp;quot;./demo-config-localhost&amp;quot; -node=laptop&lt;/code&gt; è¿™é‡Œå·²ç»å®Œæˆäº†serviceå’Œproxyçš„æ³¨å†Œã€‚è¿™ä¸ªå¯ä»¥åç»­è„šæœ¬åŒ–ï¼ŒæŒ‰éœ€æœåŠ¡æ³¨å†Œã€‚&lt;/li&gt;
&lt;li&gt;serviceæœ¬èº«éƒ½ä¸åšæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚è¿™äº›äº‹æƒ…äº¤ç»™äº† sidecar proxyã€‚ä»¥dashboard serviceä¸ºä¾‹ï¼Œ&lt;code&gt;countingServiceURL = getEnvOrDefault(&amp;quot;COUNTING_SERVICE_URL&amp;quot;, &amp;quot;http://localhost:9001&amp;quot;)&lt;/code&gt;ï¼Œé»˜è®¤è¯»çš„æ˜¯æœ¬åœ°çš„9001ç«¯å£ï¼Œä¹Ÿå°±æ˜¯sidecar proxyçš„ç»‘å®šç«¯å£ã€‚è¿™å°±æ˜¯åŠ«æŒæµé‡ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;consul connect proxy -sidecar-for counting-1&lt;/code&gt; éœ€è¦æ‰‹åŠ¨ä¸ºserviceåˆ›å»ºproxyã€‚è¿™ä¸ªå¯ä»¥åç»­è„šæœ¬åŒ–ã€‚&lt;/li&gt;
&lt;li&gt;èƒ½çœ‹å‡ºConsul Connect /Service Meshçš„å¥½å¤„äº†ï¼šä¸å†ä¾µå…¥ä¸šåŠ¡ä»£ç ã€‚é‡å¤çš„äº‹æƒ…å·²ä¸‹æ²‰åˆ°åŸºç¡€è®¾æ–½ï¼Œsidecar proxyå¤„ç†ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;2-use-envoy&#34;&gt;2. use Envoy&lt;/h3&gt;
&lt;p&gt;Use Envoy with Connect &lt;a href=&#34;https://learn.hashicorp.com/consul/developer-mesh/connect-envoy&#34;&gt;https://learn.hashicorp.com/consul/developer-mesh/connect-envoy&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;3-canary-deployments-using-traffic-splitting-and-resolution&#34;&gt;3. Canary deployments using traffic splitting and resolution&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;../../images/consul-splitting-architecture.png&#34; alt=&#34;Architecture diagram of the splitting demo. A web service directly connects to two different versions of the API service through proxies. Consul configures those proxies.&#34;&gt;&lt;/p&gt;
&lt;p&gt;Traffic Splitting for Service Deployments &lt;a href=&#34;https://learn.hashicorp.com/consul/developer-mesh/consul-splitting&#34;&gt;https://learn.hashicorp.com/consul/developer-mesh/consul-splitting&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;code &lt;a href=&#34;https://github.com/hashicorp/consul-demo-traffic-splitting&#34;&gt;https://github.com/hashicorp/consul-demo-traffic-splitting&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;4-zipkin-tracing&#34;&gt;4. Zipkin tracing&lt;/h3&gt;
&lt;p&gt;code &lt;a href=&#34;https://github.com/hashicorp/consul-demo-tracing/tree/master/jaeger&#34;&gt;https://github.com/hashicorp/consul-demo-tracing/tree/master/jaeger&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;åŸºäº-consul-å¾®æœåŠ¡æ”¹é€ &#34;&gt;åŸºäº Consul å¾®æœåŠ¡æ”¹é€ &lt;/h2&gt;
&lt;p&gt;ä¸ç”¨ Kubernetes å’Œ Dockerã€‚&lt;/p&gt;
&lt;h3 id=&#34;æœåŠ¡é—´é€šä¿¡&#34;&gt;æœåŠ¡é—´é€šä¿¡&lt;/h3&gt;
&lt;p&gt;ç›®çš„ï¼šåº”ç”¨å¯¹ consul æ— æ„ŸçŸ¥ï¼Œé™ä½åº”ç”¨å¼€å‘çš„å¤æ‚åº¦ã€‚&lt;/p&gt;
&lt;p&gt;éœ€è¦åšå¦‚ä¸‹å‡†å¤‡ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç‹¬ç«‹æœåŠ¡å™¨å®‰è£… consul server agent é›†ç¾¤ã€‚è´Ÿè´£ç»´æŠ¤é›†ç¾¤çŠ¶æ€ã€‚&lt;/li&gt;
&lt;li&gt;æ¯å°åº”ç”¨æœåŠ¡å™¨éƒ½æœ‰ consul client agent è¿è¡Œï¼Œå¹¶å·²ç»è¿å…¥ consul server agentã€‚è´Ÿè´£å¥åº·æ£€æŸ¥ï¼Œä¸è¯·æ±‚è½¬å‘ã€‚&lt;/li&gt;
&lt;li&gt;æ¯å°åº”ç”¨æœåŠ¡å™¨ä¸Šå®‰è£…æœ‰ envoy äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è´Ÿè´£sidecar proxyçš„åˆ›å»ºã€‚&lt;/li&gt;
&lt;li&gt;æœåŠ¡æ³¨å†Œã€æ³¨é”€çš„å·¥ä½œäº¤ç»™åº”ç”¨çš„ä¼™ä¼´è„šæœ¬ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ä¼™ä¼´è„šæœ¬çš„å·¥ä½œï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¯åŠ¨åº”ç”¨ã€‚&lt;/li&gt;
&lt;li&gt;æœåŠ¡æ³¨å†Œå’Œå¥åº·æ£€æŸ¥ã€‚æ‰€éœ€çš„ä¿¡æ¯ï¼Œæ¯”å¦‚IPå¯ä»¥é€šè¿‡å‘½ä»¤å–ã€ç«¯å£å¯ä»¥ä»åº”ç”¨å¯åŠ¨ä¿¡æ¯å–ã€æœåŠ¡åæ˜¯å›ºå®šçš„ã€‚&lt;/li&gt;
&lt;li&gt;å¯åŠ¨ sidecar proxy è¿›ç¨‹ã€‚&lt;/li&gt;
&lt;li&gt;ä¼™ä¼´è„šæœ¬è¿˜éœ€è¦ç›‘æµ‹åº”ç”¨çš„çŠ¶æ€ï¼Œåº”ç”¨ä¸å­˜åœ¨åï¼Œå‘èµ·æœåŠ¡æ³¨é”€ã€‚&lt;/li&gt;
&lt;li&gt;consulçš„å¥åº·æ£€æŸ¥æœºåˆ¶ä¼šè‡ªåŠ¨æŠŠä¸å¥åº·çš„æœåŠ¡è¿‡æ»¤æ‰ï¼Œå¯¹ä¼™ä¼´è„šæœ¬çš„è¦æ±‚æ²¡é‚£ä¹ˆé«˜äº†ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;å¯¹å¤–æœåŠ¡&#34;&gt;å¯¹å¤–æœåŠ¡&lt;/h3&gt;
&lt;p&gt;ç›®çš„ï¼šåŠ¨æ€æ›´æ–° nginx upstreamã€‚&lt;/p&gt;
&lt;p&gt;ç›®å‰ï¼Œæˆ‘ä»¬ä½¿ç”¨nginxä½œä¸ºå¯¹å¤–æœåŠ¡ã€‚ä½¿ç”¨ consul-templateï¼ŒåŠ¨æ€ç”Ÿæˆ nginx é…ç½®ï¼ˆupstreamsï¼‰å¹¶ reload nginxã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/consul-nginx-template-arch.png&#34; alt=&#34;NGINX and Consul template architecture&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;å‚è€ƒ-1&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;Load Balancing with NGINX and Consul Template &lt;a href=&#34;https://learn.hashicorp.com/consul/integrations/nginx-consul-template&#34;&gt;https://learn.hashicorp.com/consul/integrations/nginx-consul-template&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;consul-template &lt;a href=&#34;https://learn.hashicorp.com/consul/developer-configuration/consul-template&#34;&gt;https://learn.hashicorp.com/consul/developer-configuration/consul-template&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Manage local application configuration files using templates and data from etcd or consul ä¸consul-templateçš„æ€è·¯æ˜¯ä¸€æ ·çš„ &lt;a href=&#34;https://github.com/kelseyhightower/confd&#34;&gt;https://github.com/kelseyhightower/conf&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;ä¸€äº›èµ„æ–™&#34;&gt;ä¸€äº›èµ„æ–™&lt;/h2&gt;
&lt;p&gt;å¯èƒ½æœ‰å¸®åŠ©ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Getting Started &lt;a href=&#34;https://learn.hashicorp.com/consul?track=getting-started#getting-started&#34;&gt;https://learn.hashicorp.com/consul?track=getting-started#getting-started&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;åŸºäºconsulæ„å»ºgolangç³»ç»Ÿåˆ†å¸ƒå¼æœåŠ¡å‘ç°æœºåˆ¶ï¼ˆä½¿ç”¨Consul HTTP APIï¼‰ &lt;a href=&#34;https://segmentfault.com/a/1190000008471221&#34;&gt;https://segmentfault.com/a/1190000008471221&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Service registry bridge for Docker ç›‘å¬Dockerçš„Unixå¥—æ¥å­—æ¥è·å–Dockerå®¹å™¨å¯åŠ¨å’Œæ¶ˆäº¡æ—¶çš„äº‹ä»¶ï¼Œå¹¶ä¸”å®ƒä¼šé€šè¿‡åœ¨äº‹å…ˆé…ç½®å¥½çš„ä¸€ä¸ªå¯æ’æ‹”çš„åç«¯æœåŠ¡ä¸­åˆ›å»ºæ–°è®°å½•çš„å½¢å¼è‡ªåŠ¨å®Œæˆå®¹å™¨çš„æœåŠ¡æ³¨å†Œ &lt;a href=&#34;https://gliderlabs.github.io/registrator/latest/&#34;&gt;https://gliderlabs.github.io/registrator/latest/&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
- https://xujiahua.github.io/posts/20200421-use-consul/ - </description>
        </item>
    
    
    
        <item>
        <title>etcd å°ç»“</title>
        <link>https://xujiahua.github.io/posts/20200420-use_etcd/</link>
        <pubDate>Mon, 20 Apr 2020 14:12:38 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200420-use_etcd/</guid>
        <description>è®¸å˜‰åçš„åšå®¢ https://xujiahua.github.io/posts/20200420-use_etcd/ -&lt;h2 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;å–åæœ‰æ„æ€ã€‚Linuxä¸‹çš„/etcç›®å½•æ”¾çš„æ˜¯é…ç½®æ–‡ä»¶ã€‚etcdï¼Œetcä»£è¡¨é…ç½®ï¼Œdä»£è¡¨distributedï¼Œä»£è¡¨åˆ†å¸ƒå¼é…ç½®ã€‚&lt;/p&gt;
&lt;p&gt;ç‰¹ç‚¹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;designed to reliably store infrequently updated data and provide reliable watch queries &lt;a href=&#34;https://etcd.io/docs/v3.4.0/learning/data_model/&#34;&gt;https://etcd.io/docs/v3.4.0/learning/data_model/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;KV æ ¸å¿ƒç”¨æˆ·æ¥å£&lt;/li&gt;
&lt;li&gt;MVCC Multi-version Concurrency Control ä¹Ÿç¡®å®èƒ½è¯»å†å²ç‰ˆæœ¬&lt;/li&gt;
&lt;li&gt;Raft consensus algorithms å…±è¯†ç®—æ³•&lt;/li&gt;
&lt;li&gt;Watch é…ç½®æ›´æ–°èƒ½åŠæ—¶&amp;quot;é€šçŸ¥&amp;quot;åº”ç”¨&lt;/li&gt;
&lt;li&gt;RBAC ç”¨æˆ·ã€è§’è‰²ã€æƒé™&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;åŸºäº etcd å¯ä»¥åšå“ªäº›äº‹æƒ…ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;é…ç½®ä¸­å¿ƒã€‚å…ƒæ•°æ®å­˜å‚¨ã€‚åº”ç”¨çš„é…ç½®é›†ä¸­å­˜å‚¨åœ¨é…ç½®ä¸­å¿ƒã€‚&lt;/li&gt;
&lt;li&gt;æœåŠ¡å‘ç°ã€‚é…ç½®ä¸­å¿ƒçš„ä¸€ä¸ªç‰¹ä¾‹ã€‚ç›¸æ¯”èµ·æ¥ï¼Œconsulçš„æœåŠ¡å‘ç°æ˜¯å¼€ç®±å³ç”¨çš„ã€‚&lt;/li&gt;
&lt;li&gt;åˆ†å¸ƒå¼é”ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿåè°ƒã€‚é€‰ä¸»ã€‚åƒæ˜¯Hadoopä½¿ç”¨ZookeeperåšNamenodeçš„é€‰ä¸»ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;vs. Consulã€‚Consul å®˜æ–¹ï¼ˆhttps://www.consul.io/ï¼‰å®šä¹‰çš„usecaseæ˜¯ service discoveryå’Œ service meshã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;etcd and Consul solve different problems. If looking for a distributed consistent key value store, etcd is a better choice over Consul. If looking for end-to-end cluster service discovery, etcd will not have enough features; choose Kubernetes, Consul, or SmartStack. &lt;a href=&#34;https://github.com/etcd-io/etcd/blob/master/Documentation/learning/why.md#consul&#34;&gt;https://github.com/etcd-io/etcd/blob/master/Documentation/learning/why.md#consul&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¦‚æœæ˜¯åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œetcdæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;etcd versus other key-value stores &lt;a href=&#34;https://github.com/etcd-io/etcd/blob/master/Documentation/learning/why.md&#34;&gt;https://github.com/etcd-io/etcd/blob/master/Documentation/learning/why.md&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;etcdé›†ç¾¤å®‰è£…&#34;&gt;etcdé›†ç¾¤å®‰è£…&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/XUJiahua/linux_scripts/tree/master/etcd&#34;&gt;https://github.com/XUJiahua/linux_scripts/tree/master/etcd&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;å¸¸ç”¨æ“ä½œ&#34;&gt;å¸¸ç”¨æ“ä½œ&lt;/h2&gt;
&lt;p&gt;etcdctlçš„å‘½ä»¤ä¸»è¦æ˜¯kvæ“ä½œï¼Œä»¥åŠé›†ç¾¤ç®¡ç†ï¼Œå’ŒRBACç”¨æˆ·æƒé™ç®¡ç†ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://etcd.io/docs/v3.4.0/demo/&#34;&gt;https://etcd.io/docs/v3.4.0/demo/&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;kvç›¸å…³&#34;&gt;KVç›¸å…³&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;put foo &amp;quot;Hello World&amp;quot;&lt;/code&gt;  KVå†™&lt;/li&gt;
&lt;li&gt;&lt;code&gt;get foo&lt;/code&gt; KVè¯»ï¼Œè¿˜å¯ä»¥è¯»å†å²ç‰ˆæœ¬çš„å€¼&lt;/li&gt;
&lt;li&gt;&lt;code&gt;get web --prefix&lt;/code&gt; KVå‰ç¼€è¯»ï¼Œé€‚ç”¨äºæœåŠ¡å‘ç°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;del key&lt;/code&gt; KVåˆ é™¤&lt;/li&gt;
&lt;li&gt;&lt;code&gt;del k --prefix&lt;/code&gt; KVå‰ç¼€åˆ é™¤&lt;/li&gt;
&lt;li&gt;&lt;code&gt;txn --interactive&lt;/code&gt; KVäº‹åŠ¡&lt;/li&gt;
&lt;li&gt;&lt;code&gt;watch stock1&lt;/code&gt; KVå…³æ³¨valueå˜åŒ–ï¼Œé€‚ç”¨äºæœåŠ¡å‘ç°ï¼ŒæœåŠ¡å‘ç”Ÿå˜åŠ¨&lt;/li&gt;
&lt;li&gt;&lt;code&gt;watch stock --prefix&lt;/code&gt;  watchä¹Ÿæ”¯æŒå‰ç¼€åŒ¹é…&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;lease&#34;&gt;Lease&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;lease grant 300&lt;/code&gt; åˆ›å»º300sçš„lease&lt;/li&gt;
&lt;li&gt;&lt;code&gt;put sample value --lease=2be7547fbc6a5afa&lt;/code&gt; æœ‰æ•ˆæœŸ300sçš„keyã€‚ä¸è®¾ç½® leaseçš„putæ“ä½œï¼Œå€¼æ˜¯æ°¸ä¹…å­˜å‚¨çš„ã€‚&lt;/li&gt;
&lt;li&gt;keep-alive åˆ·æ–°TTL, list, revokeã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;åˆ†å¸ƒå¼é”&#34;&gt;åˆ†å¸ƒå¼é”&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;lock mutex1&lt;/code&gt; è·å–é”åï¼Œå…¶ä»–è¯·æ±‚è¢«block&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;é›†ç¾¤ç®¡ç†&#34;&gt;é›†ç¾¤ç®¡ç†&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;member list&lt;/code&gt; list etcd memberï¼Œmemberå‘½ä»¤è¿˜å¯ä»¥å¢åŠ æ–°nodeï¼Œnodeä¹ŸåŒ…å«ä¸æŠ•ç¥¨çš„ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;endpoint status&lt;/code&gt; é›†ç¾¤çŠ¶æ€ï¼Œèƒ½çœ‹åˆ°leader server&lt;/li&gt;
&lt;li&gt;&lt;code&gt;endpoint health&lt;/code&gt; å¥åº·æ£€æŸ¥&lt;/li&gt;
&lt;li&gt;&lt;code&gt;snapshot save my.db&lt;/code&gt; æ•°æ®å¿«ç…§å­˜å‚¨åˆ°æœ¬åœ°&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;ç”¨æˆ·æƒé™role-based-access-control&#34;&gt;ç”¨æˆ·æƒé™ï¼ˆrole based access controlï¼‰&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;role add root&lt;/code&gt; åˆ›å»ºrole&lt;/li&gt;
&lt;li&gt;&lt;code&gt;role grant-permission root readwrite foo&lt;/code&gt; roleä¸Šèµ‹äºˆæƒé™ï¼Œè¿™é‡Œèµ‹äºˆfooçš„è¯»å†™æƒé™&lt;/li&gt;
&lt;li&gt;&lt;code&gt;user add root&lt;/code&gt; åˆ›å»ºç”¨æˆ·ï¼Œå¹¶æŒ‡å®šå¯†ç &lt;/li&gt;
&lt;li&gt;&lt;code&gt;user grant-role root root&lt;/code&gt; èµ‹äºˆç”¨æˆ·role&lt;/li&gt;
&lt;li&gt;&lt;code&gt;auth enable&lt;/code&gt; å¼€å¯è®¤è¯ï¼Œdisable å³å…³é—­authã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;--user=root:root put foo bar&lt;/code&gt; æ“ä½œæ—¶æŒ‡å®šç”¨æˆ·å¯†ç &lt;/li&gt;
&lt;/ol&gt;
- https://xujiahua.github.io/posts/20200420-use_etcd/ - </description>
        </item>
    
    
    
        <item>
        <title>k8s configmap ä¸çƒ­æ›´æ–°</title>
        <link>https://xujiahua.github.io/posts/20200417-kubernetes-configmap/</link>
        <pubDate>Fri, 17 Apr 2020 16:09:28 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200417-kubernetes-configmap/</guid>
        <description>è®¸å˜‰åçš„åšå®¢ https://xujiahua.github.io/posts/20200417-kubernetes-configmap/ -&lt;h2 id=&#34;configmap-ç®€ä»‹&#34;&gt;configmap ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;å®˜æ–¹ä»‹ç»ï¼šä½¿ç”¨ ConfigMap é…ç½® Pod  &lt;a href=&#34;https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-pod-configmap/&#34;&gt;https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-pod-configmap/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä»–äººæ€»ç»“ï¼šConfigMap &lt;a href=&#34;https://jimmysong.io/kubernetes-handbook/concepts/configmap.html&#34;&gt;https://jimmysong.io/kubernetes-handbook/concepts/configmap.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ç¨å¾®æ€»ç»“ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ¯ä¸ªconfigmapéƒ½æœ‰ä¸€ä¸ªåå­—ï¼Œåå­—å…¨å±€å”¯ä¸€ï¼ˆå‘½åç©ºé—´å†…ï¼‰ï¼Œé‡å¤åˆ›å»ºä¼šæŠ¥é”™ã€‚&lt;/li&gt;
&lt;li&gt;æ¯ä¸ªconfigmapæœ¬èº«æ˜¯é”®å€¼å¯¹ã€‚&lt;/li&gt;
&lt;li&gt;configmapå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼è®©Podå†…å®¹å™¨è¯»å–ã€‚&lt;/li&gt;
&lt;li&gt;configmapå¯ä»¥é€šè¿‡æŒ‚è½½æ–‡ä»¶çš„æ–¹å¼è®©Podå†…å®¹å™¨è¯»å–ã€‚k8sæ¯éš”ä¸€æ®µæ—¶é—´åŒæ­¥configmapï¼Œå¦‚æœæœ‰æ›´æ–°çš„è¯ã€‚å½“ç„¶ï¼Œåº”ç”¨æœ¬èº«æ˜¯ä¸çŸ¥é“çš„ã€‚è¿™ä¸ªå®šæ—¶æ›´æ–°æ„Ÿè§‰æœ‰ç‚¹é¸¡è‚‹ã€‚&lt;/li&gt;
&lt;li&gt;configmapæ›´æ–°ï¼Œä¸ä¼šè‡ªåŠ¨é‡å¯åº”ç”¨ã€‚åªèƒ½äººå·¥æ–¹å¼ï¼Œæ»šåŠ¨é‡å¯åº”ç”¨ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æŠŠé…ç½®æ›´æ–°ä¹Ÿå½“ä½œä¸€æ¬¡åº”ç”¨å˜æ›´çœ‹å¾…ï¼Œå¿ƒæƒ…å°±å¥½å¾ˆå¤šäº†ã€‚&lt;/p&gt;
&lt;p&gt;å®˜æ–¹ä¸æ”¯æŒçƒ­æ›´æ–°ï¼Œæ‰€ä»¥æœ‰äº†å„ç§æŠ€å·§ï¼Œæé«˜æ•ˆç‡ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;create a new ConfigMap with the changes you want to make, and point your deployment at the new ConfigMap &lt;a href=&#34;https://stackoverflow.com/a/40624029/820682&#34;&gt;https://stackoverflow.com/a/40624029/820682&lt;/a&gt; å› ä¸º deployment æ–‡ä»¶å˜åŒ–äº†ï¼Œè§¦å‘æ»šåŠ¨é‡å¯ã€‚&lt;/li&gt;
&lt;li&gt;è¿˜æœ‰deployment æ–‡ä»¶ä¸­é…ç½® configmap hashå€¼çš„ã€‚é…ç½®å˜åŒ–ï¼Œhashå€¼å˜åŒ–ï¼Œdeploymentå˜åŒ–ï¼Œæ»šåŠ¨é‡å¯ï¼Œä¸€çº§çº§è”åŠ¨ã€‚ &lt;a href=&#34;https://blog.questionable.services/article/kubernetes-deployments-configmap-change/&#34;&gt;https://blog.questionable.services/article/kubernetes-deployments-configmap-change/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;è¿˜æœ‰ä½¿ç”¨sidecarçš„æ–¹å¼åšçƒ­æ›´æ–°çš„ï¼Œå¤ªå¤æ‚äº† &lt;a href=&#34;https://zhuanlan.zhihu.com/p/57570231&#34;&gt;https://zhuanlan.zhihu.com/p/57570231&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;å…³äºçƒ­æ›´æ–°&#34;&gt;å…³äºçƒ­æ›´æ–°&lt;/h2&gt;
&lt;p&gt;configmapçš„æ›´æ–°ï¼Œå®¹å™¨åŒ–åº”ç”¨æ˜¯æ— æ„ŸçŸ¥çš„ã€‚configmapè¿™ç§æ–¹å¼æ²¡æœ‰æ¨é€æ›´æ–°åˆ°åº”ç”¨å†…çš„æœºåˆ¶ï¼Œè¦å®ç°çƒ­æ›´æ–°è¿‡äºå¤æ‚ã€‚&lt;/p&gt;
&lt;p&gt;k8sæœ€æ ¸å¿ƒçš„åŠŸèƒ½è¿˜æ˜¯è‡ªåŠ¨éƒ¨ç½²ã€ä¼¸ç¼©ã€å®¹å™¨ç®¡ç†ä»¥åŠèµ„æºåˆ†é…ã€‚å¾®æœåŠ¡æ¶æ„è¿˜æ˜¯å¾—éœ€è¦å…¶ä»–æ¡†æ¶æ¥è¾…åŠ©çš„ã€‚&lt;/p&gt;
&lt;p&gt;é…ç½®çƒ­æ›´æ–°åº”ç”¨ï¼Œå°±é€‰æ‹© etcd, consul å§ï¼Œæœ‰ watch åŠŸèƒ½ã€‚&lt;/p&gt;
- https://xujiahua.github.io/posts/20200417-kubernetes-configmap/ - </description>
        </item>
    
    
    
        <item>
        <title>etcd api client è¯·æ±‚é‡è¯•é€»è¾‘</title>
        <link>https://xujiahua.github.io/posts/20200417-etcd_client/</link>
        <pubDate>Fri, 17 Apr 2020 15:05:51 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200417-etcd_client/</guid>
        <description>è®¸å˜‰åçš„åšå®¢ https://xujiahua.github.io/posts/20200417-etcd_client/ -&lt;p&gt;ä½¿ç”¨ Consul ä½œä¸ºé…ç½®ä¸­å¿ƒï¼ŒæŒ‰ç…§å®˜æ–¹çš„è¯´æ³•ï¼Œæ²¡å¿…è¦åˆ›å»º &lt;code&gt;consul client&lt;/code&gt; èŠ‚ç‚¹ã€‚é‚£ä¹ˆç›´æ¥è¿ &lt;code&gt;consul server&lt;/code&gt; å°±å¥½äº†ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Running an agent is not required for discovering other services or getting/setting key/value data. The agent is responsible for health checking the services on the node as well as the node itself.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.consul.io/intro/index.html#basic-architecture-of-consul&#34;&gt;https://www.consul.io/intro/index.html#basic-architecture-of-consul&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Consul api client (&lt;a href=&#34;https://github.com/hashicorp/consul/tree/master/api&#34;&gt;https://github.com/hashicorp/consul/tree/master/api&lt;/a&gt;) ç›®å‰åªèƒ½æ¥æ”¶ä¸€ä¸ªserveråœ°å€ã€‚é‚£ä¹ˆè¿™ä¸ªserveråœ°å€å¾—ä¿è¯é«˜å¯ç”¨æ‰è¡Œå•Šã€‚&lt;/p&gt;
&lt;p&gt;etcd api client (&lt;a href=&#34;https://github.com/etcd-io/etcd/tree/master/client&#34;&gt;https://github.com/etcd-io/etcd/tree/master/client&lt;/a&gt;) å€’æ˜¯èƒ½æ¥æ”¶å¤šä¸ªserveråœ°å€ï¼Œçœ‹çœ‹ etcd æ˜¯æ€ä¹ˆåšçš„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;etcd-api-client&#34;&gt;etcd api client&lt;/h3&gt;
&lt;p&gt;åˆ›å»ºäº† httpClusterClientã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200417151856806.png&#34; alt=&#34;image-20200417151856806&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¤šä¸ª endpoint çš„å¤„ç†æ ¸å¿ƒé€»è¾‘ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200417152639174.png&#34; alt=&#34;image-20200417152639174&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;pinned ç”¨äºè®°å½•å¥½ç”¨çš„è¿æ¥åœ°å€çš„indexï¼Œä¼˜å…ˆä½¿ç”¨è¿™ä¸ªåœ°å€ã€‚&lt;/li&gt;
&lt;li&gt;context ç±»é”™è¯¯ï¼Œæ¯”å¦‚å–æ¶ˆè¯·æ±‚ï¼Œç›´æ¥é€€å‡ºã€‚&lt;/li&gt;
&lt;li&gt;é‡åˆ° 5xx ç±»é”™è¯¯ï¼ŒæœåŠ¡ç«¯é”™è¯¯ã€‚éœ€è¦è€ƒè™‘æ˜¯å¦é‡è¯•äº†ã€‚&lt;/li&gt;
&lt;li&gt;isOneShot æ ‡è®°ï¼Œtrue ä»£è¡¨æ˜¯ Set/Delete æ“ä½œï¼Œè¯·æ±‚å¤±è´¥ä¸å†é‡è¯•ã€‚åº”è¯¥è·Ÿè¯·æ±‚æ˜¯å¦å¹‚ç­‰æœ‰å…³ã€‚&lt;/li&gt;
&lt;li&gt;å¯ä»¥é‡è¯•çš„è¯·æ±‚ï¼Œé‡è¯•ç›´åˆ°æˆåŠŸæˆ–æ˜¯å¾ªç¯ç»“æŸã€‚&lt;/li&gt;
&lt;/ol&gt;
- https://xujiahua.github.io/posts/20200417-etcd_client/ - </description>
        </item>
    
    
    
        <item>
        <title>æœºå™¨å­¦ä¹ åœ¨çº¿æ¨ç†éƒ¨ç½²æ–¹æ¡ˆï¼šCortex</title>
        <link>https://xujiahua.github.io/posts/20200416-cortex/</link>
        <pubDate>Thu, 16 Apr 2020 11:33:18 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200416-cortex/</guid>
        <description>è®¸å˜‰åçš„åšå®¢ https://xujiahua.github.io/posts/20200416-cortex/ -&lt;h2 id=&#34;cortex-ä»‹ç»&#34;&gt;Cortex ä»‹ç»&lt;/h2&gt;
&lt;p&gt;å®˜æ–¹ç½‘ç«™ï¼šDeploy machine learning models in production &lt;a href=&#34;https://www.cortex.dev/&#34;&gt;https://www.cortex.dev/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;GitHub &lt;a href=&#34;https://github.com/cortexlabs/cortex&#34;&gt;https://github.com/cortexlabs/cortex&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The CLI sends configuration and code to the cluster every time you run &lt;code&gt;cortex deploy&lt;/code&gt;. Each model is loaded into a Docker container, along with any Python packages and request handling code. The model is exposed as a web service using Elastic Load Balancing (ELB), TensorFlow Serving, and ONNX Runtime. The containers are orchestrated on Elastic Kubernetes Service (EKS) while logs and metrics are streamed to CloudWatch.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;CLIå·¥å…·å°†é…ç½®æ–‡ä»¶å’Œä»£ç æ¨é€åˆ°é›†ç¾¤ã€‚æ¨¡å‹è¿åŒPythonä¾èµ–åŒ…å’Œè¯·æ±‚å¤„ç†çš„ä»£ç è¢«Dockerå®¹å™¨æ‰“åŒ…ã€‚ä½¿ç”¨AWS ELBç­‰æš´éœ²å‡ºWebæœåŠ¡ã€‚å®¹å™¨ä½¿ç”¨AWS EKSç¼–æ’ï¼Œæ—¥å¿—å’ŒæŒ‡æ ‡ä¼šæ¨é€åˆ°AWS CloudWatchã€‚&lt;/p&gt;
&lt;h3 id=&#34;key-features&#34;&gt;Key Features&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Multi framework:&lt;/strong&gt; Cortex supports TensorFlow, PyTorch, scikit-learn, XGBoost, and more. æ”¯æŒä¸»æµçš„æœºå™¨å­¦ä¹ ã€æ·±åº¦å­¦ä¹ æ¡†æ¶&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Autoscaling:&lt;/strong&gt; Cortex automatically scales APIs to handle production workloads.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;CPU / GPU support:&lt;/strong&gt; Cortex can run inference on CPU or GPU infrastructure. CPU/GPUéƒ½æ”¯æŒã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Spot instances:&lt;/strong&gt; Cortex supports EC2 spot instances.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Rolling updates:&lt;/strong&gt; Cortex updates deployed APIs without any downtime. ä¾èµ–k8sçš„èƒ½åŠ›ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Log streaming:&lt;/strong&gt; Cortex streams logs from deployed models to your CLI. ä¾èµ–CloudWatchçš„èƒ½åŠ›ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Prediction monitoring:&lt;/strong&gt; Cortex monitors network metrics and tracks predictions.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Minimal configuration:&lt;/strong&gt; Cortex deployments are defined in a single &lt;code&gt;cortex.yaml&lt;/code&gt; file.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;æˆ‘çš„ä½“éªŒ&#34;&gt;æˆ‘çš„ä½“éªŒ&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;ä¸AWSæ·±åº¦ç»‘å®šã€‚å¯¹ç§æœ‰äº‘ã€å›½å†…å…¬æœ‰äº‘ä¸å¤Ÿå‹å¥½äº†ã€‚&lt;/li&gt;
&lt;li&gt;ä¾èµ–KubernetesæœåŠ¡ã€‚&lt;/li&gt;
&lt;li&gt;ä¾èµ–äº‘å­˜å‚¨æœåŠ¡ï¼Œæ¯”å¦‚S3ã€OSSã€‚cortex deployçš„å»ºè®®ï¼šcortex will zip files and upload them to the cluster; we recommend that you upload large files/directories (e.g. models) to s3 and download them in your api&amp;rsquo;s &lt;strong&gt;init&lt;/strong&gt; function,&lt;/li&gt;
&lt;li&gt;æœ‰ä¸€å¥—Python APIæœåŠ¡çš„æ¨¡æ¿ï¼Œå¹¶ä½¿ç”¨Dockerå°è£…ã€‚æ¯”å¦‚ &lt;a href=&#34;https://github.com/cortexlabs/cortex/blob/master/images/python-serve/Dockerfile&#34;&gt;https://github.com/cortexlabs/cortex/blob/master/images/python-serve/Dockerfile&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;æ¨ç†Predictorç±»æŒ‰ç…§Cortexå®šä¹‰çš„æ¥å£è§„èŒƒå®ç°ï¼Œæ‰€åœ¨ç›®å½•æŒ‚è½½åˆ° /mnt/project ç›®å½•ã€‚&lt;/li&gt;
&lt;li&gt;å¯åŠ¨å®¹å™¨ï¼Œé¢„ç½®è„šæœ¬ä¼šå®‰è£…&lt;code&gt;requirement.txt&lt;/code&gt;ï¼Œå¹¶åŠ¨æ€åŠ è½½Predictorç±»ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨è€…åªéœ€è¦å¤„ç†æ¨¡å‹è®­ç»ƒå’ŒæŒ‰ç…§è§„èŒƒå®šä¹‰Predictorç±»ã€‚é‡å¤çš„APIå®šä¹‰ã€éƒ¨ç½²ã€æ‰©å®¹ï¼Œéƒ½å·²ç»è¢«éšè—æ‰äº†ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;ä»£ç ç»“æ„&#34;&gt;ä»£ç ç»“æ„&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;cli ç›®å½•ï¼šå®¢æˆ·ç«¯ã€‚deployæ“ä½œï¼Œå°±æ˜¯æŠŠæœ¬åœ°çš„é…ç½®æ–‡ä»¶å‹ç¼©æˆzipåŒ…ä¸Šä¼ ã€‚&lt;/li&gt;
&lt;li&gt;pkg/operator ç›®å½•ï¼šæœåŠ¡ç«¯ã€‚deployæ¥å£åœ¨æ­¤ï¼šzipåŒ…ä¼šä¸Šä¼ åˆ°S3ï¼Œç¼–ç¨‹çš„æ–¹å¼ç”³è¯·k8sèµ„æºï¼ˆdeployment, service, virtualServiceï¼‰ï¼Œç›´æ¥å‘k8s API serverå‘é€è¯·æ±‚ã€‚&lt;/li&gt;
&lt;li&gt;pkg/lib ç›®å½•ï¼šæ¯”è¾ƒæ ¸å¿ƒçš„Goä»£ç ã€‚&lt;/li&gt;
&lt;li&gt;pkg/workloads/cortex/downloader ç›®å½•ï¼šåœ¨k8sä¸­ä½œä¸ºInitContainerï¼Œç”¨äºä¸‹è½½é…ç½®æ–‡ä»¶åˆ°Podä¸­ã€‚&lt;/li&gt;
&lt;li&gt;pkg/workloads ç›®å½•ï¼šæ¨ç†æœåŠ¡çš„ä»£ç ï¼Œæ¯”è¾ƒé€šç”¨ã€‚pkg/workloads/cortex/serve/run.sh ç•™äº†ä¸ªå£å­ &lt;code&gt;/mnt/project&lt;/code&gt;ï¼Œæ¯ä¸ªæœåŠ¡ä¸ªæ€§åŒ–çš„éƒ¨åˆ†ç•™ç»™å¼€å‘è€…ï¼ˆéµä»è§„èŒƒï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;images ç›®å½•ï¼šé•œåƒæ–‡ä»¶ã€‚åŒ…æ‹¬ operator çš„é•œåƒæ–‡ä»¶ï¼Œä¹ŸåŒ…æ‹¬æ¨ç†æœåŠ¡çš„ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å…·ä½“çœ‹çœ‹åˆ›å»ºæ¨ç†æœåŠ¡å®¹å™¨çš„è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;ç”³è¯· K8s Deploymentã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200416151230669.png&#34; alt=&#34;image-20200416151230669&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œåˆ†ä¸ºä¸‰å¤§ç±»ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200416151318515.png&#34; alt=&#34;image-20200416151318515&#34;&gt;&lt;/p&gt;
&lt;p&gt;å…³æ³¨PythonPredictorTypeã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200416151537448.png&#34; alt=&#34;image-20200416151537448&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¼ å…¥ InitContainer ï¼ˆä»£ç è§ pkg/workloads/cortex/downloaderï¼‰çš„å‚æ•°å¦‚ä¸‹ï¼Œå°†S3ä¸Šå­˜å‚¨çš„é…ç½®ä¿¡æ¯å’Œpredictoræ–‡ä»¶ç­‰ä¸‹è½½åˆ°Podä¸­çš„ &lt;code&gt;/mnt/project&lt;/code&gt;ç›®å½•ï¼ˆ&lt;code&gt;_emptyDirMountPath = &amp;quot;/mnt&amp;quot;&lt;/code&gt;ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200416152324873.png&#34; alt=&#34;image-20200416152324873&#34;&gt;&lt;/p&gt;
&lt;p&gt;å› ä¸ºPodå†…å®¹å™¨å…±äº«å­˜å‚¨ç©ºé—´ï¼Œè¿™æ ·æ¨ç†æœåŠ¡å®¹å™¨å°±èƒ½è¯»å–åˆ° &lt;code&gt;/mnt/project&lt;/code&gt;äº†ã€‚&lt;/p&gt;
&lt;h2 id=&#34;cortex-é•œåƒä½“éªŒ&#34;&gt;cortex é•œåƒä½“éªŒ&lt;/h2&gt;
&lt;p&gt;ä¸‹è½½åœ°å€ &lt;a href=&#34;https://hub.docker.com/r/cortexlabs/python-serve/tags&#34;&gt;https://hub.docker.com/r/cortexlabs/python-serve/tags&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å®¹å™¨å†…ä»£ç ä¹Ÿæ˜¯ä¾èµ–S3çš„ï¼Œä¸ä¿®æ”¹è¿˜ä¸èƒ½ç›´æ¥ä½¿ç”¨ğŸ¤£ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200416161622829.png&#34; alt=&#34;image-20200416161622829&#34;&gt;&lt;/p&gt;
&lt;p&gt;åˆ°æ­¤ä¸ºæ­¢å§ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;docker run -e CORTEX_SERVING_PORT&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;5000&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_WORKERS_PER_REPLICA&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_MAX_WORKER_CONCURRENCY&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_THREADS_PER_WORKER&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_SO_MAX_CONN&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2048&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_CACHE_DIR&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;/mnt/spec &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_VERSION&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;0.15.1 &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -v &lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;pwd&lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;:/mnt/project &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -v &lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;pwd&lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;:/mnt/spec &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -p 5000:5000 cortexlabs/python-serve:0.15.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;- https://xujiahua.github.io/posts/20200416-cortex/ - </description>
        </item>
    
    
    
        <item>
        <title>k8s åº”ç”¨æ—¥å¿—æ”¶é›†</title>
        <link>https://xujiahua.github.io/posts/20200414-k8s-logging/</link>
        <pubDate>Tue, 14 Apr 2020 09:53:35 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200414-k8s-logging/</guid>
        <description>è®¸å˜‰åçš„åšå®¢ https://xujiahua.github.io/posts/20200414-k8s-logging/ -&lt;h2 id=&#34;k8s-æ—¥å¿—æ”¶é›†æ¶æ„&#34;&gt;k8s æ—¥å¿—æ”¶é›†æ¶æ„&lt;/h2&gt;
&lt;p&gt;ä»¥ä¸‹æ˜¯æ¯”è¾ƒä¸€èˆ¬ã€æ™®é€‚çš„æ¶æ„ã€‚æ›´å¤šå‚è€ƒï¼šKubernetes æ—¥å¿—æ¶æ„ &lt;a href=&#34;https://kubernetes.io/zh/docs/concepts/cluster-administration/logging/&#34;&gt;https://kubernetes.io/zh/docs/concepts/cluster-administration/logging/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/logging-with-node-agent.png&#34; alt=&#34;ä½¿ç”¨èŠ‚ç‚¹æ—¥å¿—è®°å½•ä»£ç†&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å®¹å™¨åŒ–åº”ç”¨å°†æ—¥å¿—å†™å…¥&lt;code&gt;stdout&lt;/code&gt;ã€&lt;code&gt;stderr&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;Dockerå®¹å™¨å¼•æ“å°†&lt;code&gt;stdout&lt;/code&gt;ã€&lt;code&gt;stderr&lt;/code&gt;æµé‡å®šå‘åˆ°æ—¥å¿—é©±åŠ¨ï¼Œæ¯”å¦‚é»˜è®¤çš„json-fileã€‚&lt;/li&gt;
&lt;li&gt;json-fileæ—¥å¿—é©±åŠ¨å°†æ—¥å¿—å†™å…¥åˆ°ï¼ˆå®¿ä¸»æœºä¸Šçš„ï¼‰æ–‡ä»¶ã€‚&lt;/li&gt;
&lt;li&gt;æ—¥å¿—æ”¶é›†å·¥å…·ä»¥DaemonSetçš„å½¢å¼å®‰è£…åœ¨æ¯ä¸ªèŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;æ—¥å¿—æ”¶é›†å·¥å…·ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œå¹¶å°†æ—¥å¿—å†™å…¥åˆ°æ—¥å¿—ä¸­å¿ƒæœåŠ¡ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;k8s-æ—¥å¿—æ”¶é›†ç»†èŠ‚&#34;&gt;k8s æ—¥å¿—æ”¶é›†ç»†èŠ‚&lt;/h2&gt;
&lt;h3 id=&#34;å®æˆ˜&#34;&gt;å®æˆ˜&lt;/h3&gt;
&lt;p&gt;å¯ä»¥ç›´æ¥å‚è€ƒä»¥ä¸‹æ•™ç¨‹ï¼šminikubeåˆ›å»ºäº†ä¸€ä¸ªKubernetesé›†ç¾¤ï¼ŒFluentdæ”¶é›†æ—¥å¿—ï¼Œå­˜å…¥ElasticSearchï¼Œä½¿ç”¨KibanaæŸ¥çœ‹æ—¥å¿—ã€‚å…¸å‹çš„EFKæŠ€æœ¯æ ˆã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Logging in Kubernetes with Elasticsearch, Kibana, and Fluentd &lt;a href=&#34;https://mherman.org/blog/logging-in-kubernetes-with-elasticsearch-Kibana-fluentd/&#34;&gt;https://mherman.org/blog/logging-in-kubernetes-with-elasticsearch-Kibana-fluentd/&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;åœ¨Kibanaä¸Šçœ‹æ”¶é›†åˆ°çš„æ—¥å¿—ã€‚èƒ½çœ‹åˆ°æ—¥å¿—æ”¶é›†å·¥å…·ä¹Ÿé‡‡é›†äº†å®¹å™¨ã€é•œåƒã€Podæœ‰å…³çš„ä¿¡æ¯ã€‚è¿™äº›ä¸Šä¸‹æ–‡ä¿¡æ¯èƒ½è®©äººå®šä½åˆ°æ˜¯å“ªä¸ªåº”ç”¨åœ¨ç”Ÿäº§æ—¥å¿—ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200414104511399.png&#34; alt=&#34;image-20200414104511399&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;fluentd-æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯&#34;&gt;fluentd æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯&lt;/h3&gt;
&lt;p&gt;Docker &lt;code&gt;json-file&lt;/code&gt; æ—¥å¿—é©±åŠ¨å†™æ–‡ä»¶ï¼Œå¹¶ä¸è®°å½•ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ &lt;a href=&#34;https://docs.docker.com/config/containers/logging/json-file/&#34;&gt;https://docs.docker.com/config/containers/logging/json-file/&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{&amp;quot;log&amp;quot;:&amp;quot;Log line is here\n&amp;quot;,&amp;quot;stream&amp;quot;:&amp;quot;stdout&amp;quot;,&amp;quot;time&amp;quot;:&amp;quot;2019-01-01T11:11:11.111111111Z&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ä¸Šæ–‡ä¸­ä½¿ç”¨çš„æ—¥å¿—æ”¶é›†é•œåƒæ˜¯ &lt;code&gt;fluent/fluentd-kubernetes-daemonset:v1.3-debian-elasticsearch&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“ä»£ç è·¯å¾„åœ¨æ­¤ &lt;a href=&#34;https://github.com/fluent/fluentd-kubernetes-daemonset/tree/master/docker-image/v1.3/debian-elasticsearch&#34;&gt;https://github.com/fluent/fluentd-kubernetes-daemonset/tree/master/docker-image/v1.3/debian-elasticsearch&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ”¶é›†å®¹å™¨ç›®å½•ä¸‹çš„æ—¥å¿—ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200414105706563.png&#34; alt=&#34;image-20200414105706563&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨&lt;code&gt;kubernetes_metadata&lt;/code&gt;è¿™ä¸ªç¬¬ä¸‰æ–¹æ’ä»¶è·å–å®¹å™¨ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚è¿™é‡Œæ˜¯é€šè¿‡è¯·æ±‚API serverå¾—åˆ°metadataçš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200414105752287.png&#34; alt=&#34;image-20200414105752287&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;kubernetes_metadata&lt;/code&gt; æ’ä»¶åœ°å€ &lt;a href=&#34;https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter&#34;&gt;https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ’ä»¶ä¸­æœ‰ç¼“å­˜metadataçš„é€‰é¡¹ï¼Œä¸ç”¨æ‹…å¿ƒæ¯å¤„ç†ä¸€æ¡æ—¥å¿—ï¼Œå°±è¦å‘API serverå‘é€è¯·æ±‚ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200414111028867.png&#34; alt=&#34;image-20200414111028867&#34;&gt;&lt;/p&gt;
- https://xujiahua.github.io/posts/20200414-k8s-logging/ - </description>
        </item>
    
    
    
        <item>
        <title>Metabase &#43; Spark SQL</title>
        <link>https://xujiahua.github.io/posts/20200410-metabase-spark-sql/</link>
        <pubDate>Fri, 10 Apr 2020 16:41:53 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200410-metabase-spark-sql/</guid>
        <description>è®¸å˜‰åçš„åšå®¢ https://xujiahua.github.io/posts/20200410-metabase-spark-sql/ -&lt;p&gt;è¿™æ˜¯å¤§æ•°æ® BI å¹³å°çš„ç¬¬äºŒæ­¥ï¼ŒBI å·¥å…·çš„æ­å»ºã€‚å‡è®¾å·²ç»é…ç½®å¥½ Spark SQL JDBC Serverï¼Œå¹¶å¯ç”¨äº†Kerberosã€‚å‚è€ƒ  &lt;a href=&#34;https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/&#34;&gt;https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œï¼Œæˆ‘ä»¬é€‰æ‹©äº†å¼€æºäº§å“ Metabaseã€‚&lt;/p&gt;
&lt;p&gt;æœ€ç»ˆï¼Œå¤§æ•°æ® BI å¹³å°ï¼Œæ˜¯ç”± 1) ä»¥Metabaseä½œä¸ºBIå¯è§†åŒ–ï¼Œ2) ç”±HDFSï¼ˆåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ï¼‰ + parquetï¼ˆåˆ—å¼æ•°æ®å­˜å‚¨æ ¼å¼ï¼‰+ Hive metastoreï¼ˆSQLè¡¨ç»“æ„ä¿¡æ¯ç»´æŠ¤ï¼‰ + Spark SQLï¼ˆæ‰¹å¤„ç†å¼•æ“ï¼‰ç»„åˆçš„OLAPæ•°æ®åº“ç»„æˆã€‚&lt;/p&gt;
&lt;h2 id=&#34;metabase-ç®€ä»‹&#34;&gt;Metabase ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;Metabase is the easy, open source way for everyone in your company to ask questions and learn from data.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.metabase.com/&#34;&gt;https://www.metabase.com/&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ•°æ®åº“æ”¯æŒ&#34;&gt;æ•°æ®åº“æ”¯æŒ&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;BigQuery&lt;/li&gt;
&lt;li&gt;Druid&lt;/li&gt;
&lt;li&gt;Google Analytics&lt;/li&gt;
&lt;li&gt;H2&lt;/li&gt;
&lt;li&gt;MongoDB&lt;/li&gt;
&lt;li&gt;MySQL/MariaDB&lt;/li&gt;
&lt;li&gt;PostgreSQL&lt;/li&gt;
&lt;li&gt;Presto&lt;/li&gt;
&lt;li&gt;Amazon Redshift&lt;/li&gt;
&lt;li&gt;Snowflake&lt;/li&gt;
&lt;li&gt;Spark SQL&lt;/li&gt;
&lt;li&gt;SQLite&lt;/li&gt;
&lt;li&gt;SQL Server&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a href=&#34;https://www.metabase.com/docs/latest/faq/setup/which-databases-does-metabase-support.html&#34;&gt;https://www.metabase.com/docs/latest/faq/setup/which-databases-does-metabase-support.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæœ‰æˆ‘ä»¬éœ€è¦çš„Spark SQLï¼Œæˆ‘ä»¬çš„å¤§æ•°æ®é›†ç¾¤å¯ä»¥æ”¯æŒã€‚æ¯”è¾ƒé—æ†¾çš„æ˜¯æ²¡æœ‰Impalaã€‚&lt;/p&gt;
&lt;h2 id=&#34;metabase-å®‰è£…&#34;&gt;Metabase å®‰è£…&lt;/h2&gt;
&lt;h3 id=&#34;mysql&#34;&gt;MySQL&lt;/h3&gt;
&lt;p&gt;ä½¿ç”¨MySQLä½œä¸ºå…ƒæ•°æ®å­˜å‚¨ã€‚å¤ç”¨ä¹‹å‰CDHçš„MySQLå®ä¾‹ã€‚&lt;/p&gt;
&lt;p&gt;åˆ›å»ºæ•°æ®åº“ã€ç”¨æˆ·ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-SQL&#34; data-lang=&#34;SQL&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;-- é€‚åˆMySQL5.7åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œæ”¯æŒæ›´å¤§çš„max key lengthã€‚ä¸€ä¸ªå­—ç¬¦ä½¿ç”¨å››ä¸ªå­—èŠ‚ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;CREATE&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;DATABASE&lt;/span&gt; metabase CHARACTER &lt;span style=&#34;color:#66d9ef&#34;&gt;SET&lt;/span&gt; utf8mb4 &lt;span style=&#34;color:#66d9ef&#34;&gt;COLLATE&lt;/span&gt; utf8mb4_unicode_ci;
&lt;span style=&#34;color:#75715e&#34;&gt;-- é€‚åˆMySQL5.6åŠä»¥ä¸‹ç‰ˆæœ¬ã€‚ä¸€ä¸ªå­—ç¬¦ä½¿ç”¨3ä¸ªå­—èŠ‚ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;CREATE&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;DATABASE&lt;/span&gt; metabase CHARACTER &lt;span style=&#34;color:#66d9ef&#34;&gt;SET&lt;/span&gt; utf8 &lt;span style=&#34;color:#66d9ef&#34;&gt;COLLATE&lt;/span&gt; utf8_unicode_ci;

&lt;span style=&#34;color:#75715e&#34;&gt;-- % è¡¨ç¤ºä¸é™åˆ¶host
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;CREATE&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;USER&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;metabase&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;@&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;%&amp;#39;&lt;/span&gt; IDENTIFIED &lt;span style=&#34;color:#66d9ef&#34;&gt;BY&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;metabase&amp;#39;&lt;/span&gt;;
&lt;span style=&#34;color:#66d9ef&#34;&gt;GRANT&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ALL&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ON&lt;/span&gt; metabase.&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;TO&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;metabase&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;@&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;%&amp;#39;&lt;/span&gt;;

FLUSH &lt;span style=&#34;color:#66d9ef&#34;&gt;PRIVILEGES&lt;/span&gt;;
&lt;span style=&#34;color:#75715e&#34;&gt;-- https://dev.mysql.com/doc/refman/5.7/en/grant.html
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;å¸¸è§é—®é¢˜&#34;&gt;å¸¸è§é—®é¢˜&lt;/h4&gt;
&lt;p&gt;mysql 5.7ä¸5.6çš„åŒºåˆ«ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;767 bytes is the &lt;a href=&#34;http://dev.mysql.com/doc/refman/5.1/en/create-index.html&#34;&gt;stated prefix limitation&lt;/a&gt; for InnoDB tables in MySQL version 5.6 (and prior versions). It&amp;rsquo;s 1,000 bytes long for MyISAM tables. In MySQL version 5.7 and upwards this limit has been increased to 3072 bytes.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Caused by: java.sql.SQLException: Specified key was too long; max key length is 767 bytes&lt;/p&gt;
&lt;p&gt;Caused by: liquibase.exception.DatabaseException: (conn=175553) Specified key was too long; max key length is 767 bytes [Failed SQL: CREATE TABLE &lt;code&gt;metabase&lt;/code&gt;.&lt;code&gt;core_organization&lt;/code&gt; (&lt;code&gt;id&lt;/code&gt; INT AUTO_INCREMENT NOT NULL, &lt;code&gt;slug&lt;/code&gt; VARCHAR(254) NOT NULL, &lt;code&gt;name&lt;/code&gt; VARCHAR(254) NOT NULL, &lt;code&gt;description&lt;/code&gt; TEXT NULL, &lt;code&gt;logo_url&lt;/code&gt; VARCHAR(254) NULL, &lt;code&gt;inherits&lt;/code&gt; BIT(1) NOT NULL, CONSTRAINT &lt;code&gt;PK_CORE_ORGANIZATION&lt;/code&gt; PRIMARY KEY (&lt;code&gt;id&lt;/code&gt;), UNIQUE (&lt;code&gt;slug&lt;/code&gt;))]&lt;/p&gt;
&lt;h3 id=&#34;metabase&#34;&gt;Metabase&lt;/h3&gt;
&lt;p&gt;ä¸‹è½½metabaseã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# ä»¥ /opt/metabase ä¸ºå·¥ä½œç›®å½•&lt;/span&gt;
mkdir /opt/metabase &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; cd /opt/metabase
&lt;span style=&#34;color:#75715e&#34;&gt;# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„metabaseï¼Œå‚è€ƒ https://www.metabase.com/start/jar.html&lt;/span&gt;
wget https://downloads.metabase.com/v0.35.1/metabase.jar
&lt;span style=&#34;color:#75715e&#34;&gt;# åˆ›å»ºæ’ä»¶ç›®å½•&lt;/span&gt; 
mkdir plugins
&lt;span style=&#34;color:#75715e&#34;&gt;# Spark SQLçš„é©±åŠ¨ï¼ŒjaråŒ…å†…ç½®çš„æœ‰é—®é¢˜&lt;/span&gt;
wget https://s3.amazonaws.com/sparksql-deps/metabase-sparksql-deps-1.2.1.spark2-standalone.jar -O plugins/metabase-sparksql-deps-1.2.1.spark2-standalone.jar
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯åŠ¨è„šæœ¬ start.shã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#!/usr/bin/bash
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
export MB_DB_TYPE&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;mysql
export MB_DB_DBNAME&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;metabase
export MB_DB_PORT&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3306&lt;/span&gt;
export MB_DB_USER&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;metabase
export MB_DB_PASS&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;metabase
export MB_DB_HOST&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;172.31.0.100

kinit -kt hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003@PEGGY.LING

mkdir -p logs

nohup java -Djavax.security.auth.useSubjectCredsOnly&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;false -jar metabase.jar  &amp;gt;&amp;gt; logs/metabase.log 2&amp;gt;&amp;amp;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &amp;amp;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœæ­¢è„šæœ¬ stop.shã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#!/usr/bin/bash
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
ps -ef | grep &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;metabase.jar&amp;#39;&lt;/span&gt; | grep -v &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;grep&amp;#39;&lt;/span&gt; | awk &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;{print $2}&amp;#39;&lt;/span&gt; | xargs kill -9

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;webapp@xh-hd2-peggy-dost000003 metabase&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;$ tree
â”œâ”€â”€ hive.xh-hd2-peggy-dost000003.keytab
â”œâ”€â”€ logs
â”‚Â Â  â””â”€â”€ metabase.log
â”œâ”€â”€ metabase.jar
â”œâ”€â”€ plugins
â”‚Â Â  â”œâ”€â”€ metabase-sparksql-deps-1.2.1.spark2-standalone.jar
â”‚Â Â  â”œâ”€â”€ sparksql.metabase-driver.jar
â”‚Â Â  â”œâ”€â”€ ...
â”œâ”€â”€ start.sh
â””â”€â”€ stop.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Metabaseæ­å»ºæ‰‹å†Œï¼šä½¿ç”¨SparkSQLè¿æ¥Hive &lt;a href=&#34;https://webcache.googleusercontent.com/search?q=cache:DcmHXWOc9woJ:https://immm.in/archives/24.html+&amp;amp;cd=5&amp;amp;hl=zh-CN&amp;amp;ct=clnk&amp;amp;gl=hk&#34;&gt;https://webcache.googleusercontent.com/search?q=cache:DcmHXWOc9woJ:https://immm.in/archives/24.html+&amp;amp;cd=5&amp;amp;hl=zh-CN&amp;amp;ct=clnk&amp;amp;gl=hk&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;é…ç½®-spark-sql-è¿æ¥&#34;&gt;é…ç½® Spark SQL è¿æ¥&lt;/h4&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200410180255501.png&#34; alt=&#34;image-20200410180255501&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¿å­˜æ²¡æœ‰æŠ¥é”™ï¼Œå°±æ˜¯æˆåŠŸäº†ã€‚&lt;/p&gt;
&lt;h4 id=&#34;å¸¸è§é—®é¢˜-1&#34;&gt;å¸¸è§é—®é¢˜&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;ä½¿ç”¨å†…ç½®çš„é©±åŠ¨æŠ¥é”™ï¼šUnrecognized Hadoop major version number: 3.1.1&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨metabase-sparksql-deps-1.2.1.spark2-standalone.jarè¿™ä¸ªé©±åŠ¨æŠ¥é”™ï¼Œç„¶è€Œbeelineè¿æ¥æ˜¯æ²¡é—®é¢˜çš„ï¼š transport.TSaslTransport :: SASL negotiation failure
javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæš‚æ—¶å¿½ç•¥ï¼Œä½¿ç”¨å…¶ä»–é©±åŠ¨ã€‚&lt;/p&gt;
&lt;p&gt;æŒ‰ç†è¯´ï¼Œhttps://github.com/metabase/sparksql-deps å·²ç»åˆå¹¶åˆ° &lt;a href=&#34;https://github.com/metabase/metabase/tree/v0.35.1/modules/drivers/sparksql&#34;&gt;https://github.com/metabase/metabase/tree/v0.35.1/modules/drivers/sparksql&lt;/a&gt; äº†ã€‚å†…ç½®é©±åŠ¨å°±èƒ½ç”¨æ‰å¯¹ã€‚&lt;/p&gt;
&lt;p&gt;èƒ½çœ‹åˆ°ä¾èµ–hadoop-commonåŒ…çš„ç‰ˆæœ¬å·®å¼‚ã€‚TODO: è¿˜å¾—ç»†çœ‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200411071918161.png&#34; alt=&#34;image-20200411071918161&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¾èµ–çš„hadoopç‰ˆæœ¬æ˜¯3.1.0ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200411072135265.png&#34; alt=&#34;image-20200411072135265&#34;&gt;&lt;/p&gt;
&lt;p&gt;å†…ç½®Driverä¾èµ–3.1.1ã€‚æŠ¥é”™ä¿¡æ¯ä¹Ÿæ˜¯åŒ…å«3.1.1ï¼Œæ˜¯å¦åˆ‡åˆ°3.1.0ï¼Œé‡æ–°æ‰“åŒ…å°±å¯ä»¥äº†ï¼Ÿ&lt;/p&gt;
&lt;p&gt;ç¬¬äºŒä¸ªé—®é¢˜éœ€è¦è®¾ç½®Javaå‚æ•° &lt;code&gt;-Djavax.security.auth.useSubjectCredsOnly=false&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡åº•å±‚æœºåˆ¶è·å–å‡­è¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¯é€šè¿‡åº”ç”¨æ‰§è¡Œè®¤è¯æ“ä½œã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200410173734177.png&#34; alt=&#34;image-20200410173734177&#34;&gt;&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;How to connnect sparksql in Kerberos enviroment &lt;a href=&#34;https://discourse.metabase.com/t/how-to-connnect-sparksql-in-kerberos-enviroment/8290/2&#34;&gt;https://discourse.metabase.com/t/how-to-connnect-sparksql-in-kerberos-enviroment/8290/2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided https://stackoverflow.com/questions/32205087/javax-security-sasl-saslexception-gss-initiate-failed-caused-by-gssexception&lt;/li&gt;
&lt;li&gt;Below are listed some problems that may occur when attempting a login, and suggestions for solving them. &lt;a href=&#34;https://docs.oracle.com/javase/7/docs/technotes/guides/security/jgss/tutorials/Troubleshooting.html&#34;&gt;https://docs.oracle.com/javase/7/docs/technotes/guides/security/jgss/tutorials/Troubleshooting.html&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;ä¸-superset-æ¯”è¾ƒ&#34;&gt;ä¸ Superset æ¯”è¾ƒ&lt;/h2&gt;
&lt;p&gt;Supersetæ˜¯å¦å¤–ä¸€ä¸ªå¼€æºçš„BIå·¥å…·ã€‚ä½†æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­ä½“éªŒä¸ä½³ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸æ”¯æŒå¤šè¡¨JOINã€‚è¿™ä¸ªä¸èƒ½å¿ã€‚&lt;/li&gt;
&lt;li&gt;ç›´æ¥å†™SQLï¼Œæ•°æ®æ²¡æ³•å¯è§†åŒ–ã€‚æ•ˆç‡æœ‰ç‚¹ä½ä¸‹ã€‚&lt;/li&gt;
&lt;li&gt;å¤–è§‚ä¸‘é™‹ã€‚FlaskAppbuilderç”Ÿæˆçš„å‰åç«¯æ¶å­ã€‚&lt;/li&gt;
&lt;li&gt;Tableæºå¦‚æœæ”¹äº†ï¼Œå»ºè®®åˆ æ‰å†æ·»åŠ ï¼Œä¸ç„¶ä¼šæœ‰å„ç§æ„å¤–ã€‚&lt;/li&gt;
&lt;li&gt;äº¤äº’ä½“éªŒå·®ã€‚è‡ªå®šä¹‰SELECT COUNT(cookie) as pvï¼Œæ­»æ´»æä¸å®šã€‚æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼æ˜¯è®¾ç½®labelï¼Œä½“éªŒä¸ç›´è§‚ã€‚&lt;/li&gt;
&lt;li&gt;å°bugå¤šã€‚ç”¨èµ·æ¥å¤ªå®¹æ˜“çƒ¦èºäº†ã€‚å¯¹èº«å¿ƒå¥åº·ä¸å¥½ã€‚&lt;/li&gt;
&lt;/ol&gt;
- https://xujiahua.github.io/posts/20200410-metabase-spark-sql/ - </description>
        </item>
    
    
    
        <item>
        <title>CDH6 å¯ç”¨ Spark Thrift Server</title>
        <link>https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/</link>
        <pubDate>Fri, 10 Apr 2020 10:07:16 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/</guid>
        <description>è®¸å˜‰åçš„åšå®¢ https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/ -&lt;p&gt;å¾ˆé—æ†¾ï¼ŒCDHç‰ˆæœ¬çš„Sparké˜‰å‰²äº†Thrift Serverã€‚ï¼ˆå¯èƒ½ä¸è‡ªå®¶äº§å“Impalaæœ‰ç«äº‰å…³ç³»çš„åŸå› ã€‚ï¼‰&lt;/p&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/spark.html#spark__d99299e107&#34;&gt;https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/spark.html#spark__d99299e107&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ll /opt/cloudera/parcels/CDH/lib/spark/sbin/
total 84
-rwxr-xr-x 1 root root 2803 Nov  9 00:05 slaves.sh
-rwxr-xr-x 1 root root 1429 Nov  9 00:05 spark-config.sh
-rwxr-xr-x 1 root root 5689 Nov  9 00:05 spark-daemon.sh
-rwxr-xr-x 1 root root 1262 Nov  9 00:05 spark-daemons.sh
-rwxr-xr-x 1 root root 1190 Nov  9 00:05 start-all.sh
-rwxr-xr-x 1 root root 1274 Nov  9 00:05 start-history-server.sh
-rwxr-xr-x 1 root root 2050 Nov  9 00:05 start-master.sh
-rwxr-xr-x 1 root root 1877 Nov  9 00:05 start-mesos-dispatcher.sh
-rwxr-xr-x 1 root root 1423 Nov  9 00:05 start-mesos-shuffle-service.sh
-rwxr-xr-x 1 root root 1279 Nov  9 00:05 start-shuffle-service.sh
-rwxr-xr-x 1 root root 3151 Nov  9 00:05 start-slave.sh
-rwxr-xr-x 1 root root 1527 Nov  9 00:05 start-slaves.sh
-rwxr-xr-x 1 root root 1478 Nov  9 00:05 stop-all.sh
-rwxr-xr-x 1 root root 1056 Nov  9 00:05 stop-history-server.sh
-rwxr-xr-x 1 root root 1080 Nov  9 00:05 stop-master.sh
-rwxr-xr-x 1 root root 1227 Nov  9 00:05 stop-mesos-dispatcher.sh
-rwxr-xr-x 1 root root 1084 Nov  9 00:05 stop-mesos-shuffle-service.sh
-rwxr-xr-x 1 root root 1067 Nov  9 00:05 stop-shuffle-service.sh
-rwxr-xr-x 1 root root 1557 Nov  9 00:05 stop-slave.sh
-rwxr-xr-x 1 root root 1064 Nov  9 00:05 stop-slaves.sh
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¯è§ï¼Œæ²¡æœ‰Thrift Serverçš„å¯åŠ¨è„šæœ¬ã€‚&lt;/p&gt;
&lt;p&gt;å€Ÿé‰´ç½‘ä¸Šèµ„æ–™ï¼ˆCDH 6æˆåŠŸå¯åŠ¨spark-thriftæœåŠ¡ &lt;a href=&#34;https://blog.csdn.net/qq_34864753/article/details/102729859&#34;&gt;https://blog.csdn.net/qq_34864753/article/details/102729859&lt;/a&gt;ï¼‰ï¼Œåœ¨ä¸ä¿®æ”¹CDH Sparkçš„å‰æä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å¯åŠ¨ä¸€ä¸ªç‹¬ç«‹çš„Spark Thrift Serverã€‚&lt;/p&gt;
&lt;p&gt;è¿˜éœ€è¦è€ƒè™‘CDH Kerberosè®¤è¯çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;h2 id=&#34;spark-thrift-server-ç®€ä»‹&#34;&gt;Spark Thrift Server ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;../../images/sparksqlthriftserver.png&#34; alt=&#34;Spark SQL Thrift Server&#34;&gt;&lt;/p&gt;
&lt;p&gt;Spark Thrift Serveræ˜¯Sparkç¤¾åŒºåŸºäºHiveServer2å®ç°çš„ä¸€ä¸ªThriftæœåŠ¡ã€‚æ—¨åœ¨æ— ç¼å…¼å®¹HiveServer2ã€‚&lt;/p&gt;
&lt;p&gt;å› ä¸ºSpark Thrift Serverçš„æ¥å£å’Œåè®®éƒ½å’ŒHiveServer2å®Œå…¨ä¸€è‡´ï¼Œå› æ­¤æˆ‘ä»¬éƒ¨ç½²å¥½Spark Thrift Serveråï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨hiveçš„beelineè®¿é—®Spark Thrift Serveræ‰§è¡Œç›¸å…³è¯­å¥ã€‚&lt;/p&gt;
&lt;p&gt;Spark Thrift Serverçš„ç›®çš„ä¹Ÿåªæ˜¯å–ä»£HiveServer2ï¼Œå› æ­¤å®ƒä¾æ—§å¯ä»¥å’ŒHive Metastoreè¿›è¡Œäº¤äº’ï¼Œè·å–åˆ°hiveçš„å…ƒæ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://www.jianshu.com/p/b719c6415411&#34;&gt;https://www.jianshu.com/p/b719c6415411&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;apache-sparké…ç½®&#34;&gt;Apache Sparké…ç½®&lt;/h2&gt;
&lt;h3 id=&#34;ä¸‹è½½å®˜æ–¹ç‰ˆæœ¬&#34;&gt;ä¸‹è½½å®˜æ–¹ç‰ˆæœ¬&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;cd /opt
wget https://archive.apache.org/dist/spark/spark-2.4.0/spark-2.4.0-bin-hadoop2.7.tgz
cd spark-2.4.0-bin-hadoop2.7 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; ln -s &lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;pwd&lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt; /opt/spark
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;sparké…ç½®æ–‡ä»¶&#34;&gt;Sparké…ç½®æ–‡ä»¶&lt;/h3&gt;
&lt;p&gt;é€šè¿‡è½¯é“¾æ¥çš„æ–¹å¼å¤ç”¨Hiveçš„é…ç½®ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;ln -s /etc/hive/conf/hive-site.xml /opt/spark/conf/hive-site.xml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æœ€åé…ç½®æ–‡ä»¶å¤¹é•¿è¿™æ ·ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# ll /opt/spark/conf/&lt;/span&gt;
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp  &lt;span style=&#34;color:#ae81ff&#34;&gt;996&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; docker.properties.template
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp &lt;span style=&#34;color:#ae81ff&#34;&gt;1105&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; fairscheduler.xml.template
lrwxrwxrwx &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root   root     &lt;span style=&#34;color:#ae81ff&#34;&gt;28&lt;/span&gt; Apr  &lt;span style=&#34;color:#ae81ff&#34;&gt;9&lt;/span&gt; 11:05 hive-site.xml -&amp;gt; /etc/hive/conf/hive-site.xml
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp &lt;span style=&#34;color:#ae81ff&#34;&gt;2025&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; log4j.properties.template
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp &lt;span style=&#34;color:#ae81ff&#34;&gt;7801&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; metrics.properties.template
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp  &lt;span style=&#34;color:#ae81ff&#34;&gt;865&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; slaves.template
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp &lt;span style=&#34;color:#ae81ff&#34;&gt;1292&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; spark-defaults.conf.template
-rwxr-xr-x &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp &lt;span style=&#34;color:#ae81ff&#34;&gt;4221&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; spark-env.sh.template
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;sparké…ç½®æ–‡ä»¶é…ç½®æ–¹å¼&#34;&gt;Sparké…ç½®æ–‡ä»¶é…ç½®æ–¹å¼&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;é»˜è®¤é…ç½®è·¯å¾„ï¼š&lt;code&gt;$SPARK_HOME/conf&lt;/code&gt;ï¼Œå¦‚æœ&lt;code&gt;$SPARK_HOME&lt;/code&gt;ä¸å­˜åœ¨ï¼Œè„šæœ¬ä¸­ä¼šæŠŠè„šæœ¬ä¸Šå±‚ç›®å½•å½“åš&lt;code&gt;$SPARK_HOME&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;$SPARK_CONF_DIR&lt;/code&gt;ï¼Œå¯ä»¥æŒ‡å®šSPARKé…ç½®æ–‡ä»¶å¤¹ã€‚&lt;/li&gt;
&lt;li&gt;Spark classpathï¼Œå¦‚æœ&lt;code&gt;hdfs-site.xml&lt;/code&gt; &lt;code&gt;core-site.xml&lt;/code&gt;åœ¨classpathï¼ŒSparkå¯ä»¥è¯»å–ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;$HADOOP_CONF_DIR&lt;/code&gt;ï¼Œä¸€èˆ¬æ˜¯&lt;code&gt;/etc/hadoop/conf&lt;/code&gt;ç›®å½•ï¼Œè¯»Hadoopé…ç½®ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;$YARN_CONF_DIR&lt;/code&gt;ï¼Œä¸€èˆ¬ä¹Ÿæ˜¯&lt;code&gt;/etc/hadoop/conf&lt;/code&gt;ç›®å½•ã€‚&lt;/li&gt;
&lt;li&gt;å‘½ä»¤è¡Œä¸­å¯ä»¥è¦†ç›–ä»¥ä¸Šé…ç½®æ–‡ä»¶ä¸­çš„å…·ä½“å‚æ•°ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://spark.apache.org/docs/latest/configuration.html#inheriting-hadoop-cluster-configuration&#34;&gt;https://spark.apache.org/docs/latest/configuration.html#inheriting-hadoop-cluster-configuration&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;spark-libä¿®æ”¹&#34;&gt;Spark libä¿®æ”¹&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;cd /opt/spark
rm -rf jars/hadoop-yarn-*
cp /opt/cloudera/parcels/CDH-6.3.2-1.cdh6.3.2.p0.1605554/jars/hadoop-yarn-* jars/
cp /opt/cloudera/parcels/CDH-6.3.2-1.cdh6.3.2.p0.1605554/jars/hive-shims-scheduler-2.1.1-cdh6.3.2.jar jars/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;kerberos-è®¤è¯&#34;&gt;Kerberos è®¤è¯&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200410140136660.png&#34; alt=&#34;image-20200410140136660&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å›¾ä¸­çš„ä¸‰ä¸ªè§’è‰²ï¼Œåœ¨Kerkerosè®¤è¯ä½“ç³»ä¸‹éƒ½å¯¹åº”ä¸€ä¸ªprincipalã€‚Kerberos principalç›¸å½“äºç”¨æˆ·åï¼Œkeytabç›¸å½“äºå¯†ç ã€‚æƒé™é…ç½®ï¼Œä¾é hiveä¸hdfsæœ¬èº«ã€‚&lt;/li&gt;
&lt;li&gt;JDBCå®¢æˆ·ç«¯ä¸Spark JDBC Serveréœ€è¦ä½¿ç”¨Kerberosè®¤è¯ã€‚JDBCå®¢æˆ·ç«¯éœ€è¦æ‹¥æœ‰principal/keytabå¯¹ã€‚æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºã€‚&lt;/li&gt;
&lt;li&gt;Spark JDBC Serverä¸Hive metastoreéœ€è¦ä½¿ç”¨Kerberosè®¤è¯ã€‚JDBCæœåŠ¡ç«¯éœ€è¦æ‹¥æœ‰principal/keytabå¯¹ã€‚æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºã€‚&lt;/li&gt;
&lt;li&gt;Hive metastoreä¹Ÿæ‹¥æœ‰è‡ªå·±çš„principal/keytabå¯¹ï¼Œä¸è¿‡è¿™ä¸ªå·²ç»ç”±CDHæ‰˜ç®¡äº†ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¸¸è§Kerberosé”™è¯¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;org.apache.hive.service.ServiceException: Unable to login to kerberos with given principal/keytab / Caused by: java.io.IOException: HiveServer2 Kerberos principal or keytab is not correctly configured&lt;/li&gt;
&lt;li&gt;Caused by: java.io.IOException: Login failure for &lt;a href=&#34;mailto:hive/xh-hd2-peggy-dost000003@PEGGY.LING&#34;&gt;hive/xh-hd2-peggy-dost000003@PEGGY.LING&lt;/a&gt; from keytab hive.keytab: javax.security.auth.login.LoginException: Unable to obtain password from user&lt;/li&gt;
&lt;li&gt;SASL negotiation failure
javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;åˆ›å»º-spark-jdbc-server-çš„-principal&#34;&gt;åˆ›å»º Spark JDBC Server çš„ Principal&lt;/h3&gt;
&lt;p&gt;å› ä¸ºå¤ç”¨äº†Hiveçš„é…ç½®æ–‡ä»¶ï¼Œå¾…åˆ›å»ºçš„principalçš„åå­—éœ€è¦æ»¡è¶³é…ç½®ä¸­çš„è§„èŒƒã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;webapp@xh-hd2-peggy-dost000004 spark&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;$ cat conf/hive-site.xml
...
  &amp;lt;property&amp;gt;
    &amp;lt;name&amp;gt;hive.server2.authentication.kerberos.principal&amp;lt;/name&amp;gt;
    &amp;lt;value&amp;gt;hive/_HOST@PEGGY.LING&amp;lt;/value&amp;gt;
  &amp;lt;/property&amp;gt;
... 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨KerberosæœåŠ¡å™¨åˆ›å»º principalåŠå¯¼å‡º keytabï¼ŒåŒæ­¥åˆ°Spark JDBC Serveræ‰€åœ¨æœºå™¨ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# create principal&lt;/span&gt;
kadmin.local addprinc -randkey hive/xh-hd2-peggy-dost000004
&lt;span style=&#34;color:#75715e&#34;&gt;# export keytab&lt;/span&gt;
kadmin.local ktadd -k hive.xh-hd2-peggy-dost000004.keytab hive/xh-hd2-peggy-dost000004
&lt;span style=&#34;color:#75715e&#34;&gt;# éªŒè¯æ˜¯å¦OK&lt;/span&gt;
kinit -kt hive.xh-hd2-peggy-dost000004.keytab hive/xh-hd2-peggy-dost000004@PEGGY.LING
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;å¯åŠ¨-spark-jdbc-server&#34;&gt;å¯åŠ¨ Spark JDBC Server&lt;/h3&gt;
&lt;p&gt;å¯åŠ¨è„šæœ¬å¦‚ä¸‹ã€‚å› ä¸ºé…ç½®æ–‡ä»¶é‡Œæ²¡æœ‰æŒ‡å®škeytabçš„è·¯å¾„ï¼Œéœ€è¦é€šè¿‡&lt;code&gt;--hiveconf&lt;/code&gt;æŒ‡å®šã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#!/usr/bin/bash
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
export JAVA_HOME&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;/usr/java/jdk1.8.0_181-cloudera
export PATH&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;$PATH:$JAVA_HOME/bin
export HADOOP_CONF_DIR&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;/etc/hadoop/conf

kinit -kt hive.xh-hd2-peggy-dost000004.keytab hive/xh-hd2-peggy-dost000004@PEGGY.LING

sbin/start-thriftserver.sh &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;--hiveconf hive.server2.authentication.kerberos.keytab hive.xh-hd2-peggy-dost000004.keytab
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¹Ÿå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š&lt;/p&gt;
&lt;p&gt;Configuring Spark Thrift Server with Kerberos &lt;a href=&#34;https://mapr.com/docs/61/Spark/ConfiguringSparkSQLThriftServer_Kerberos.html&#34;&gt;https://mapr.com/docs/61/Spark/ConfiguringSparkSQLThriftServer_Kerberos.html&lt;/a&gt;&lt;/p&gt;
&lt;h4 id=&#34;kinit-ticketè¿‡æœŸé—®é¢˜&#34;&gt;kinit ticketè¿‡æœŸé—®é¢˜&lt;/h4&gt;
&lt;p&gt;Spark Thrift Server è¿›ç¨‹ä¼šè‡ªåŠ¨å¤„ç†Kerberos ticket renewalæ“ä½œã€‚&lt;/p&gt;
&lt;p&gt;é»˜è®¤çš„ticket_lifetime 1dï¼Œrenew_lifetime 7dã€‚ä¸Šæ¬¡kinitæ˜¯04/10ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[webapp@xh-hd2-peggy-dost000004 spark]$ klist
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: hive/xh-hd2-peggy-dost000004@PEGGY.LING

Valid starting       Expires              Service principal
04/13/2020 01:32:45  04/14/2020 01:32:45  krbtgt/PEGGY.LING@PEGGY.LING
	renew until 04/17/2020 15:56:45
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å°±çœ‹7å¤©åä¼šæ€ä¹ˆæ ·äº†ã€‚renewå‘¨æœŸè¿‡äº†ï¼Œä¼šé‡å»ºä¹ˆï¼Ÿç†è®ºä¸Šæ˜¯å¯ä»¥çš„ã€‚&lt;/p&gt;
&lt;p&gt;çœ‹åˆ°Sparkä»£ç ä¸­å·²ç»æœ‰kerberosé›†æˆäº†ï¼ŒåŒ…æ‹¬ç™»å½•å•¥çš„ã€‚&lt;/p&gt;
&lt;p&gt;spark/sql/hive-thriftserver/v2.3.5/src/main/java/org/apache/hive/service/auth/HiveAuthFactory.java&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200413110032646.png&#34; alt=&#34;image-20200413110032646&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200413105917167.png&#34; alt=&#34;image-20200413105917167&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;åˆ›å»º-jdbc-client-çš„-principal&#34;&gt;åˆ›å»º JDBC Client çš„ Principal&lt;/h3&gt;
&lt;p&gt;åœ¨KerberosæœåŠ¡å™¨åˆ›å»º principalåŠå¯¼å‡º keytabï¼ŒåŒæ­¥åˆ° JDBC Client æ‰€åœ¨æœºå™¨ã€‚è¿™é‡Œå¯¹principalçš„åç§°æ²¡æœ‰ä¸¥æ ¼è¦æ±‚ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# create principal&lt;/span&gt;
kadmin.local addprinc -randkey hive/xh-hd2-peggy-dost000003
&lt;span style=&#34;color:#75715e&#34;&gt;# export keytab&lt;/span&gt;
kadmin.local ktadd -k hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003 
&lt;span style=&#34;color:#75715e&#34;&gt;# éªŒè¯æ˜¯å¦OK&lt;/span&gt;
kinit -kt hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003@PEGGY.LING
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;å¯åŠ¨-jdbc-client&#34;&gt;å¯åŠ¨ JDBC Client&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;webapp@xh-hd2-peggy-dost000003 spark&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;$ kinit -kt hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003@PEGGY.LING

&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;webapp@xh-hd2-peggy-dost000003 spark&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;$ bin/beeline -u &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;jdbc:hive2://xh-hd2-peggy-dost000004:10000/default;principal=hive/xh-hd2-peggy-dost000004@PEGGY.LING&amp;#34;&lt;/span&gt;
Connecting to jdbc:hive2://xh-hd2-peggy-dost000004:10000/default;principal&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;hive/xh-hd2-peggy-dost000004@PEGGY.LING
2020-04-10 16:09:01 INFO  Utils:310 - Supplied authorities: xh-hd2-peggy-dost000004:10000
2020-04-10 16:09:01 INFO  Utils:397 - Resolved authority: xh-hd2-peggy-dost000004:10000
2020-04-10 16:09:01 INFO  HiveConnection:203 - Will try to open client transport with JDBC Uri: jdbc:hive2://xh-hd2-peggy-dost000004:10000/default;principal&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;hive/xh-hd2-peggy-dost000004@PEGGY.LING
Connected to: Spark SQL &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;version 2.4.0&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
Driver: Hive JDBC &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;version 1.2.1.spark2&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
Transaction isolation: TRANSACTION_REPEATABLE_READ
Beeline version 1.2.1.spark2 by Apache Hive
0: jdbc:hive2://xh-hd2-peggy-dost000004:10000&amp;gt; show databases;
+---------------+--+
| databaseName  |
+---------------+--+
| db1           |
| default       |
| product       |
+---------------+--+
&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt; rows selected &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;0.091 seconds&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è‡³æ­¤ï¼ŒThrift Serverçš„å¯ç”¨å°±å®Œæˆäº†ã€‚&lt;/p&gt;
&lt;h3 id=&#34;yarn-è¿è¡Œ&#34;&gt;YARN è¿è¡Œ&lt;/h3&gt;
&lt;p&gt;å¤±è´¥äº†ï¼ŒTODO&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;sbin/start-thriftserver.sh --hiveconf hive.server2.authentication.kerberos.keytab hive.keytab --hiveconf hive.server2.thrift.port=10001 --queue root.zm_yarn_pool.development  --master yarn --executor-memory 4g --executor-cores 2 --num-executors 20

2020-04-09 17:56:19 INFO  Client:54 - Requesting a new application from cluster with 5 NodeManagers
Exception in thread &amp;quot;main&amp;quot; java.lang.NoClassDefFoundError: org/apache/hadoop/util/FastNumberFormat
        at org.apache.hadoop.yarn.api.records.ApplicationId.toString(ApplicationId.java:104)
        at org.apache.spark.deploy.yarn.Client$.org$apache$spark$deploy$yarn$Client$$getAppStagingDir(Client.scala:1222)
        at org.apache.spark.deploy.yarn.Client.org$apache$spark$deploy$yarn$Client$$cleanupStagingDirInternal$1(Client.scala:206)
        at org.apache.spark.deploy.yarn.Client.cleanupStagingDir(Client.scala:226)
        at org.apache.spark.deploy.yarn.Client.submitApplication(Client.scala:191)
        at org.apache.spark.scheduler.cluster.YarnClientSchedulerBackend.start(YarnClientSchedulerBackend.scala:57)
        at org.apache.spark.scheduler.TaskSchedulerImpl.start(TaskSchedulerImpl.scala:178)
        at org.apache.spark.SparkContext.&amp;lt;init&amp;gt;(SparkContext.scala:501)
        at org.apache.spark.SparkContext$.getOrCreate(SparkContext.scala:2520)
        at org.apache.spark.sql.SparkSession$Builder$$anonfun$7.apply(SparkSession.scala:935)
        at org.apache.spark.sql.SparkSession$Builder$$anonfun$7.apply(SparkSession.scala:926)
        at scala.Option.getOrElse(Option.scala:121)
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;å¤–ä¼ cdhæ˜¯å¦‚ä½•ç®¡ç†hadoopé…ç½®æ–‡ä»¶çš„&#34;&gt;ã€å¤–ä¼ ã€‘CDHæ˜¯å¦‚ä½•ç®¡ç†Hadoopé…ç½®æ–‡ä»¶çš„&lt;/h2&gt;
&lt;p&gt;ä»¥ä¸‹ç»“æœéƒ½æ˜¯é€šè¿‡è§‚å¯Ÿå®è·µæ‰€å¾—ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥Hiveä¸ºä¾‹ï¼Œ&lt;code&gt;/etc/hive/conf&lt;/code&gt;ä¸‹çš„é…ç½®æ–‡ä»¶ç”±CDHç”Ÿæˆã€‚ï¼ˆCDHç®¡ç†ç•Œé¢ä¸Šå¯ä»¥ä¿®æ”¹è¿™äº›é…ç½®ã€‚ï¼‰&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# ll /etc/hive/conf/&lt;/span&gt;
total &lt;span style=&#34;color:#ae81ff&#34;&gt;64&lt;/span&gt;
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root   &lt;span style=&#34;color:#ae81ff&#34;&gt;21&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 __cloudera_generation__
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root   &lt;span style=&#34;color:#ae81ff&#34;&gt;70&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 __cloudera_metadata__
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root &lt;span style=&#34;color:#ae81ff&#34;&gt;3846&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 core-site.xml
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root  &lt;span style=&#34;color:#ae81ff&#34;&gt;617&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 hadoop-env.sh
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root &lt;span style=&#34;color:#ae81ff&#34;&gt;3839&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 hdfs-site.xml
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root &lt;span style=&#34;color:#ae81ff&#34;&gt;2655&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 hive-env.sh
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root &lt;span style=&#34;color:#ae81ff&#34;&gt;6925&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 hive-site.xml
...

&lt;span style=&#34;color:#75715e&#34;&gt;# head /etc/hive/conf/hive-site.xml&lt;/span&gt;
&amp;lt;?xml version&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;1.0&amp;#34;&lt;/span&gt; encoding&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;UTF-8&amp;#34;&lt;/span&gt;?&amp;gt;

&amp;lt;!--Autogenerated by Cloudera Manager--&amp;gt;
&amp;lt;configuration&amp;gt;
  &amp;lt;property&amp;gt;
    &amp;lt;name&amp;gt;hive.metastore.uris&amp;lt;/name&amp;gt;
    &amp;lt;value&amp;gt;thrift://xh-hd2-peggy-dost001:9083&amp;lt;/value&amp;gt;
  &amp;lt;/property&amp;gt;
  &amp;lt;property&amp;gt;
    &amp;lt;name&amp;gt;hive.metastore.client.socket.timeout&amp;lt;/name&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æˆ‘ä»¬çš„é›†ç¾¤æ˜¯å¼€å¯äº†Kerberosè®¤è¯çš„ã€‚ä½†æ˜¯ä¸Šè¿°é…ç½®æ–‡ä»¶é‡Œæ²¡è§principalçš„keytabè·¯å¾„é…ç½®ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# grep keytab /etc/hive/conf/hive-site.xml&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¹Ÿå°±æ˜¯è¯´ï¼Œ&lt;code&gt;/etc/hive/conf&lt;/code&gt;ä¸æ˜¯çœŸæ­£åœ¨è¢«ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;/var/run/cloudera-scm-agent/process/&lt;/code&gt; è¿™ä¸ªç›®å½•ä¸­æœ‰æ‰€æœ‰CDHç›‘æ§çš„è¿›ç¨‹ï¼ŒåŒ…æ‹¬æˆ‘ä»¬å…³æ³¨çš„Hiveè¿›ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://community.cloudera.com/t5/Support-Questions/Location-of-keytab-files/td-p/33716&#34;&gt;https://community.cloudera.com/t5/Support-Questions/Location-of-keytab-files/td-p/33716&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ls /var/run/cloudera-scm-agent/process/*hive*
/var/run/cloudera-scm-agent/process/954-hive-HIVEMETASTORE:
cloudera-monitor.properties        config.zip     creds.localjceks  hdfs-site.xml  hive-log4j2.properties  logs       redaction-rules.json  service-metrics.properties  supervisor_status
cloudera-stack-monitor.properties  core-site.xml  exit_code         hive.keytab    hive-site.xml           proc.json  sentry-site.xml       supervisor.conf             yarn-conf

/var/run/cloudera-scm-agent/process/955-hive-HIVESERVER2:
cloudera-monitor.properties        config.zip     exit_code           hdfs-site.xml  hive-log4j2.properties  logs                         navigator.lineage.client.properties  redaction-rules.json  service-metrics.properties  supervisor.conf    yarn-conf
cloudera-stack-monitor.properties  core-site.xml  fair-scheduler.xml  hive.keytab    hive-site.xml           navigator.client.properties  proc.json                            sentry-site.xml       spark-defaults.conf         supervisor_status

/var/run/cloudera-scm-agent/process/956-hive-WEBHCAT:
cloudera-monitor.properties        config.zip     exit_code      hive-site.xml  logs       redaction-rules.json        supervisor.conf    webhcat-default.xml       webhcat-site.xml
cloudera-stack-monitor.properties  core-site.xml  hdfs-site.xml  HTTP.keytab    proc.json  service-metrics.properties  supervisor_status  webhcat-log4j.properties  yarn-conf
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è¿™é‡ŒHiveæœ‰ä¸‰ä¸ªè¿›ç¨‹ï¼Œmetastoreï¼Œhiveserver2ï¼ŒWEBHCATã€‚å¯è§principalå¯¹åº”çš„keytabï¼Œè¿™é‡Œçš„ &lt;code&gt;hive.keytab&lt;/code&gt;ï¼Œä¹Ÿæ˜¯åœ¨è¿™é‡Œç»´æŠ¤ç€ã€‚é…ç½®æ–‡ä»¶ä¹Ÿæ˜¯åœ¨&lt;code&gt;/etc/hive/conf&lt;/code&gt;åŸºç¡€ä¸Šä½œäº†æ”¹åŠ¨ï¼Œæ¯”å¦‚keytabè·¯å¾„çš„è®¾ç½®ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;root 954-hive-HIVEMETASTORE&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# grep kerberos hive-site.xml&lt;/span&gt;
    &amp;lt;name&amp;gt;hive.metastore.kerberos.principal&amp;lt;/name&amp;gt;
    &amp;lt;name&amp;gt;hive.metastore.kerberos.keytab.file&amp;lt;/name&amp;gt;
    &amp;lt;value&amp;gt;kerberos&amp;lt;/value&amp;gt;
    
&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;root 955-hive-HIVESERVER2&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# grep kerberos hive-site.xml&lt;/span&gt;
    &amp;lt;value&amp;gt;kerberos&amp;lt;/value&amp;gt;
    &amp;lt;name&amp;gt;hive.metastore.kerberos.principal&amp;lt;/name&amp;gt;
    &amp;lt;name&amp;gt;hive.server2.authentication.kerberos.principal&amp;lt;/name&amp;gt;
    &amp;lt;name&amp;gt;hive.server2.authentication.kerberos.keytab&amp;lt;/name&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;HiveMetaStoreä¸HiveServer2ä½¿ç”¨çš„keytabæ˜¯ä¸åŒçš„ã€‚ä¸€ä¸ªprincipalå¯¹åº”å¤šä¸ªkeytabä¹ˆï¼ŸTODOï¼šå¯èƒ½æ˜¯å› ä¸ºåŠ å¯†éšæœºçš„åŸå› ï¼Ÿï¼Ÿï¼Ÿ&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;root@xh-hd2-peggy-dost001 955-hive-HIVESERVER2&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# md5sum hive.keytab&lt;/span&gt;
523357eec4f542b7b3df7ec52cee43b2  hive.keytab

&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;root@xh-hd2-peggy-dost001 954-hive-HIVEMETASTORE&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# md5sum hive.keytab&lt;/span&gt;
3c6f52333067518ae4bdce1e99878857  hive.keytab
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;TODOï¼šå®éªŒå‘ç°ï¼Œå¯¼å‡ºä¸¤æ¬¡ï¼Œä¹‹å‰çš„keytabå°±å¤±æ•ˆäº†ï¼è¿›å…¥çŸ¥è¯†ç›²åŒºã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@xh-hd2-peggy-rost01 ~]# kadmin.local addprinc -randkey hive/xh-hd2-peggy-dost000003
[root@xh-hd2-peggy-rost01 ~]# kadmin.local ktadd -k hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003
[root@xh-hd2-peggy-rost01 ~]# mv hive.xh-hd2-peggy-dost000003.keytab hive.xh-hd2-peggy-dost000003.keytab.bak
[root@xh-hd2-peggy-rost01 ~]# kadmin.local ktadd -k hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003
[root@xh-hd2-peggy-rost01 ~]# kinit -kt hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003@PEGGY.LING
[root@xh-hd2-peggy-rost01 ~]# kinit -kt hive.xh-hd2-peggy-dost000003.keytab.bak hive/xh-hd2-peggy-dost000003@PEGGY.LING
kinit: Password incorrect while getting initial credentials
&lt;/code&gt;&lt;/pre&gt;- https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/ - </description>
        </item>
    
    
    
        <item>
        <title>Dockeræ—¥å¿—é©±åŠ¨å°ç»“</title>
        <link>https://xujiahua.github.io/posts/20200403-docker-logging/</link>
        <pubDate>Fri, 03 Apr 2020 15:43:07 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200403-docker-logging/</guid>
        <description>è®¸å˜‰åçš„åšå®¢ https://xujiahua.github.io/posts/20200403-docker-logging/ -&lt;p&gt;&lt;code&gt;docker logs&lt;/code&gt;ï¼Œ &lt;code&gt;kubectl logs&lt;/code&gt;èƒ½çœ‹åˆ°Dockerå®¹å™¨çš„æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜ã€‚è€Œ &lt;code&gt;xxx logs&lt;/code&gt;ä¹‹æ‰€ä»¥èƒ½çœ‹åˆ°ï¼Œæ˜¯å› ä¸ºæ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯å­˜å‚¨åœ¨æ¯ä¸ªå®¹å™¨ç‹¬æœ‰çš„æ—¥å¿—æ–‡ä»¶ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;å¦å¤–æ—¥å¿—é‡å¤§äº†ï¼Œç”¨&lt;code&gt;docker logs&lt;/code&gt;çœ‹å†å²æ•°æ®ä¸å¤§åˆé€‚ã€‚æˆ‘ä»¬å°±éœ€è¦è€ƒè™‘å°†æ—¥å¿—å­˜å‚¨åˆ°æ—¥å¿—ä¸­å¿ƒå»ã€‚&lt;/p&gt;
&lt;p&gt;Dockeré»˜è®¤æ”¯æŒå¦‚ä¸‹æ—¥å¿—é©±åŠ¨ã€‚æœ‰ç›´æ¥å†™æ–‡ä»¶çš„ï¼Œæœ‰ä½¿ç”¨äº‘æœåŠ¡çš„ã€‚ä¸‹é¢ç®€å•ä»‹ç»ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/Screen-Shot-2017-09-11-at-3.08.50-PM.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;credit: &lt;a href=&#34;https://jaxenter.com/docker-logging-gotchas-137049.html&#34;&gt;https://jaxenter.com/docker-logging-gotchas-137049.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£ &lt;a href=&#34;https://docs.docker.com/config/containers/logging/configure/&#34;&gt;https://docs.docker.com/config/containers/logging/configure/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;é»˜è®¤é©±åŠ¨json-file&#34;&gt;é»˜è®¤é©±åŠ¨ï¼šjson-file&lt;/h2&gt;
&lt;p&gt;é»˜è®¤çš„Logging Driveræ˜¯json-fileã€‚&lt;code&gt;docker info&lt;/code&gt;å¯ä»¥æŸ¥çœ‹ã€‚å…¨å±€çš„æ—¥å¿—é©±åŠ¨è®¾ç½®ï¼Œå¯ä»¥ä¿®æ”¹daemoné…ç½®æ–‡ä»¶ &lt;code&gt;/etc/docker/daemon.json&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å†™å…¥æ–‡ä»¶çš„æ—¥å¿—æ ¼å¼é•¿è¿™æ ·ï¼š&lt;code&gt;{&amp;quot;log&amp;quot;:&amp;quot;Log line is here\n&amp;quot;,&amp;quot;stream&amp;quot;:&amp;quot;stdout&amp;quot;,&amp;quot;time&amp;quot;:&amp;quot;2019-01-01T11:11:11.111111111Z&amp;quot;}&lt;/code&gt;ï¼Œæ¯ä¸€è¡Œæ˜¯ä¸€ä¸ªjsonæ–‡ä»¶ï¼Œlogå­—æ®µä¸ºå®¹å™¨åŸæ¥è¾“å‡ºçš„æ¯è¡Œå†…å®¹ã€‚&lt;/p&gt;
&lt;p&gt;é»˜è®¤é…ç½®ï¼Œåˆ›å»ºçš„å®¹å™¨çš„ä¿¡æ¯åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼š &lt;code&gt;/var/lib/docker/containers&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒ&#34;&gt;å®éªŒ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;root@ubuntu-parallel:~# docker run --name default_logging_driver hello-world

root@ubuntu-parallel:~# cd /var/lib/docker/containers/&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=default_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;

root@ubuntu-parallel:~# cat &lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=default_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;-json.log
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;log&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\n&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stream&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;time&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2020-04-02T01:46:54.096347888Z&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;log&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Hello from Docker!\n&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stream&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;time&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2020-04-02T01:46:54.096377382Z&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;log&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;This message shows that your installation appears to be working correctly.\n&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stream&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;time&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2020-04-02T01:46:54.096381118Z&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;log&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\n&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stream&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;time&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2020-04-02T01:46:54.096383725Z&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/config/containers/logging/json-file/&#34;&gt;https://docs.docker.com/config/containers/logging/json-file/&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ€ä¹ˆè®°å½•æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯&#34;&gt;æ€ä¹ˆè®°å½•æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;json-file&lt;/code&gt;æœ¬èº«æ˜¯æ²¡æœ‰è®°å½•ä¸Šä¸‹æ–‡ä¿¡æ¯çš„ã€‚é›†ä¸­å­˜å‚¨åˆ°æ—¥å¿—ä¸­å¿ƒæœåŠ¡å™¨ï¼Œå°±æ— æ³•åŒºåˆ†å…·ä½“æ˜¯å“ªä¸ªåº”ç”¨äº§ç”Ÿçš„æ—¥å¿—äº†ã€‚&lt;/p&gt;
&lt;p&gt;k8sçš„å®¹å™¨æ—¥å¿—æ”¶é›†ï¼Œä¸Šä¸‹æ–‡ä¿¡æ¯æ˜¯ç”±æ—¥å¿—æ”¶é›†å·¥å…· &lt;code&gt;fluentd&lt;/code&gt; é€šè¿‡è¯·æ±‚api serveré‡‡é›†å¹¶ç¼“å­˜èµ·æ¥çš„ã€‚å‚è€ƒ &lt;a href=&#34;https://xujiahua.github.io/posts/20200414-k8s-logging/&#34;&gt;https://xujiahua.github.io/posts/20200414-k8s-logging/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;åŒæ ·çš„æ€è·¯ï¼Œ&lt;code&gt;fluentd&lt;/code&gt;ä¹Ÿæœ‰ä¸å°‘é€šè¿‡docker daemonæŸ¥è¯¢æˆ–æ˜¯è§£æå®¹å™¨ç›®å½•ä¸‹&lt;code&gt;config.v2.json&lt;/code&gt;è·å–metadataçš„ filter æ’ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200414112709859.png&#34; alt=&#34;image-20200414112709859&#34;&gt;&lt;/p&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://www.fluentd.org/plugins&#34;&gt;https://www.fluentd.org/plugins&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚è¿™ä¸ª &lt;a href=&#34;https://github.com/zsoltf/fluent-plugin-docker_metadata_elastic_filter&#34;&gt;https://github.com/zsoltf/fluent-plugin-docker_metadata_elastic_filter&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{
  &amp;quot;log&amp;quot;: &amp;quot;2015/05/05 19:54:41 \n&amp;quot;,
  &amp;quot;stream&amp;quot;: &amp;quot;stderr&amp;quot;,
  &amp;quot;docker&amp;quot;: {
    &amp;quot;id&amp;quot;: &amp;quot;df14e0d5ae4c07284fa636d739c8fc2e6b52bc344658de7d3f08c36a2e804115&amp;quot;,
    &amp;quot;name&amp;quot;: &amp;quot;k8s_fabric8-console-container.efbd6e64_fabric8-console-controller-9knhj_default_8ae2f621-f360-11e4-8d12-54ee7527188d_7ec9aa3e&amp;quot;,
    &amp;quot;container_hostname&amp;quot;: &amp;quot;fabric8-console-controller-9knhj&amp;quot;,
    &amp;quot;image&amp;quot;: &amp;quot;fabric8/hawtio-kubernetes:latest&amp;quot;,
    &amp;quot;image_id&amp;quot;: &amp;quot;b2bd1a24a68356b2f30128e6e28e672c1ef92df0d9ec01ec0c7faea5d77d2303&amp;quot;,
    &amp;quot;labels&amp;quot;: {}
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ–°å¢äº†dockerç»“æ„ä½“ï¼Œé•œåƒåç§°ä¹Ÿèƒ½æ”¶é›†åˆ°äº† ã€‚&lt;/p&gt;
&lt;h2 id=&#34;local&#34;&gt;local&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;--log-driver&lt;/code&gt;æŒ‡å®šæ—¥å¿—é©±åŠ¨ã€‚&lt;/p&gt;
&lt;p&gt;catè¾“å‡ºlocalæ–‡ä»¶ï¼Œéƒ¨åˆ†ç»“æœä¹±ç ã€‚æŒºä¸æ–¹ä¾¿æ—¥å¿—è§£æçš„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒ-1&#34;&gt;å®éªŒ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;root@ubuntu-parallel:~# docker run --name local_logging_driver --log-driver local hello-world

root@ubuntu-parallel:~# cd /var/lib/docker/containers/&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=local_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;

root@ubuntu-parallel:~# cat local-logs/container.log
stdoutï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½&amp;amp;
stdoutï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hello from Docker!&amp;amp;^
stdoutË§ï¿½ï¿½ï¿½ï¿½ï¿½JThis message shows that your installation appears to be working correctly.^
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/config/containers/logging/local/&#34;&gt;https://docs.docker.com/config/containers/logging/local/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;none&#34;&gt;none&lt;/h2&gt;
&lt;p&gt;ä¸ç”Ÿæˆæ—¥å¿—æ–‡ä»¶ï¼Œ&lt;code&gt;docker logs&lt;/code&gt;ä¹Ÿæ‹¿ä¸åˆ°æ—¥å¿—ã€‚å®é™…ä½¿ç”¨ä¸ä¼šè€ƒè™‘ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒ-2&#34;&gt;å®éªŒ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;root@ubuntu-parallel:~# docker run --name none_logging_driver --log-driver none hello-world

root@ubuntu-parallel:~# cd /var/lib/docker/containers/&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=none_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;

root@ubuntu-parallel:~# docker logs none_logging_driver
Error response from daemon: configured logging driver does not support reading
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;syslog&#34;&gt;syslog&lt;/h2&gt;
&lt;p&gt;å› ä¸ºæ—¥å¿—è¢«å†™å…¥äº†syslogï¼Œå¹¶æ··åœ¨å…¶ä»–åº”ç”¨çš„æ—¥å¿—ä¸­ï¼Œ&lt;code&gt;docker logs&lt;/code&gt;æ²¡åŠæ³•å·¥ä½œäº†ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒ-3&#34;&gt;å®éªŒ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# è§‚å¯Ÿsyslog&lt;/span&gt;
root@ubuntu-parallel:~# tail -f /var/log/syslog

root@ubuntu-parallel:~# docker run --name syslog_logging_driver --log-driver syslog hello-world

&lt;span style=&#34;color:#75715e&#34;&gt;# æ—¥å¿—ä¸ä¼šå†™æœ¬åœ°&lt;/span&gt;
root@ubuntu-parallel:~# cd /var/lib/docker/containers/&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=syslog_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;

root@ubuntu-parallel:~# docker logs syslog_logging_driver
Error response from daemon: configured logging driver does not support reading
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/config/containers/logging/syslog/&#34;&gt;https://docs.docker.com/config/containers/logging/syslog/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;journald&#34;&gt;journald&lt;/h2&gt;
&lt;p&gt;å†™å…¥syslogå’Œjournaldï¼Œåº”ç”¨æ—¥å¿—ä¸ç³»ç»Ÿæ—¥å¿—æ··åœ¨ä¸€èµ·ï¼Œéš¾ä»¥è¾¨è®¤äº†ã€‚&lt;/p&gt;
&lt;p&gt;å€’æ˜¯journaldé©±åŠ¨ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨&lt;code&gt;docker logs&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼šhttps://wiki.archlinux.org/index.php/Systemd/Journal&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒ-4&#34;&gt;å®éªŒ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;root@ubuntu-parallel:~# docker run --name journald_logging_driver --log-driver journald hello-world

root@ubuntu-parallel:~# journalctl
Apr &lt;span style=&#34;color:#ae81ff&#34;&gt;02&lt;/span&gt; 10:30:36 ubuntu-parallel 4b948bf091a8&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;999&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;: To try something more ambitious, you can run an Ubuntu container with:
Apr &lt;span style=&#34;color:#ae81ff&#34;&gt;02&lt;/span&gt; 10:30:36 ubuntu-parallel 4b948bf091a8&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;999&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;:  $ docker run -it ubuntu bash
Apr &lt;span style=&#34;color:#ae81ff&#34;&gt;02&lt;/span&gt; 10:30:36 ubuntu-parallel 4b948bf091a8&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;999&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;:
Apr &lt;span style=&#34;color:#ae81ff&#34;&gt;02&lt;/span&gt; 10:30:36 ubuntu-parallel 4b948bf091a8&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;999&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;: Share images, automate workflows, and more with a free Docker ID:
Apr &lt;span style=&#34;color:#ae81ff&#34;&gt;02&lt;/span&gt; 10:30:36 ubuntu-parallel 4b948bf091a8&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;999&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;:  https://hub.docker.com/

root@ubuntu-parallel:~# cd /var/lib/docker/containers/&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=journald_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# docker logsç®¡ç”¨&lt;/span&gt;
root@ubuntu-parallel:~# docker logs journald_logging_driver

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/config/containers/logging/journald/&#34;&gt;https://docs.docker.com/config/containers/logging/journald/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;fluentd&#34;&gt;Fluentd&lt;/h2&gt;
&lt;p&gt;é€šè¿‡æœåŠ¡è¯·æ±‚ï¼Œè®©dockeråæ—¥å¿—åˆ°fluentdè¿›ç¨‹ã€‚https://docs.docker.com/config/containers/logging/fluentd/&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨åŒ…æ‹¬fluentdåœ¨å¾ˆå¤šæ—¥å¿—é©±åŠ¨ï¼Œå› ä¸ºæ—¥å¿—å†™å…¥åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼Œä¼šå¯¼è‡´&lt;code&gt;docker logs&lt;/code&gt;ï¼Œ &lt;code&gt;kubectl logs&lt;/code&gt;ä¸å¯ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;Fluentdæ˜¯ä¸€ä¸ªæŒºçµæ´»çš„å·¥å…·ï¼Œå¯ä»¥è®©fluentdä¸»åŠ¨ç›‘å¬å®¹å™¨ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶ã€‚å‚è€ƒå¦ä¸€ç¯‡æ–‡ç«  &lt;a href=&#34;https://xujiahua.github.io/posts/use-fluentd/&#34;&gt;https://xujiahua.github.io/posts/use-fluentd/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;ä¸ºäº†å…¼å®¹å¯ä½¿ç”¨&lt;code&gt;docker logs&lt;/code&gt; ï¼Œ&lt;code&gt;kubectl logs&lt;/code&gt;ï¼Œå¿…é¡»ä½¿ç”¨å†™æœ¬åœ°æ–‡ä»¶çš„æ—¥å¿—é©±åŠ¨ã€‚è€Œjsonæ ¼å¼æ›´æ–¹ä¾¿å·¥å…·ï¼ˆæ¯”å¦‚fluentdï¼Œlogstashï¼‰è§£æï¼Œæ‰€ä»¥json-fileæ˜¯é¦–é€‰ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶åä½¿ç”¨æ—¥å¿—æ”¶é›†å·¥å…·é›†ä¸­é‡‡é›†dockerå®¹å™¨æ—¥å¿—ã€‚k8sä¸­æ—¥å¿—æ”¶é›†ç­–ç•¥ï¼Œä¸€èˆ¬æ˜¯åœ¨æ¯å°æœåŠ¡å™¨ä¸Šä»¥DaemonSetçš„å½¢å¼å®‰è£…logging agentï¼Œç›‘å¬æœ¬åœ°æ–‡ä»¶ã€æ–‡ä»¶å¤¹ï¼Œå°†æ—¥å¿—è½¬å‘åˆ°æ—¥å¿—ä¸­å¿ƒã€‚&lt;/p&gt;
&lt;p&gt;å½“ç„¶è¿™ä¸ªå‰ææ¡ä»¶æ˜¯ï¼Œåº”ç”¨æ—¥å¿—æ˜¯è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯çš„ã€‚è¿™å¯¹åº”ç”¨æ—¥å¿—çš„è§„èŒƒæœ‰ä¸€å®šè¦æ±‚ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸è¾“å‡ºå¤šè¡Œæ—¥å¿—ã€‚æ¯”å¦‚panicã€exceptionã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨æ—¥å¿—ä½¿ç”¨JSONæ ¼å¼è¾“å‡ºï¼Œæ–¹ä¾¿åç»­çš„æ—¥å¿—åˆ†æã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨æ—¥å¿—ä¸­åŠ å…¥æ›´å¤šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ç”¨äºé—®é¢˜å®šä½ï¼Œç»´åº¦åˆ†æã€‚&lt;/li&gt;
&lt;li&gt;Goåº”ç”¨å¼€å‘ï¼Œä½¿ç”¨logrusæ—¥å¿—åº“ï¼ŒåŠ å­—æ®µï¼Œä»¥JSONæ ¼å¼è¾“å‡ºéƒ½å¾ˆæ–¹ä¾¿ã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨ä¸å…³æ³¨æ—¥å¿—è¯¥å¦‚ä½•æ”¶é›†è¿™ä¸ªé—®é¢˜ã€‚ä¸åœ¨åº”ç”¨å±‚å†™æ—¥å¿—åˆ°kafkaã€redisç­‰ä¸­é—´ä»¶ï¼Œè®©åŸºç¡€è®¾æ–½å±‚å¤„ç†ã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨è¦ä¹ˆå†™å…¥æ–‡ä»¶ã€è¦ä¹ˆå†™å…¥æ ‡å‡†è¾“å‡ºï¼Œè¿™ä¸ªåº”è¯¥å¾ˆæ–¹ä¾¿åšæˆå¯é…ç½®çš„ã€‚å¯¹ç¨‹åºæ¥è¯´ï¼Œéƒ½æœ‰å…±åŒçš„æŠ½è±¡ï¼Œio.Writerã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;åº”ç”¨æ—¥å¿—å¦‚æœæ˜¯å†™åˆ°æ–‡ä»¶çš„ï¼Œéœ€è¦è€ƒè™‘é€šè¿‡æ•°æ®å·ï¼ŒæŒ‚è½½ç­‰å°†æ—¥å¿—ä¸å®¹å™¨åˆ†ç¦»ã€‚é‡‡é›†æŒ‚è½½ç›®å½•ä¸Šçš„æ—¥å¿—æ–‡ä»¶ï¼Œä»¥å‰æ€ä¹ˆæ”¶é›†ï¼Œç°åœ¨è¿˜æ˜¯æ€ä¹ˆæ”¶é›†ã€‚è¿˜æ˜¯å»ºè®®å†™æ ‡å‡†è¾“å‡ºï¼Œè¿™æ˜¯ç›®å‰çš„æœ€ä½³å®è·µã€‚&lt;/p&gt;
- https://xujiahua.github.io/posts/20200403-docker-logging/ - </description>
        </item>
    
    
    
        <item>
        <title>Fluentdå®æˆ˜</title>
        <link>https://xujiahua.github.io/posts/20200402-use-fluentd/</link>
        <pubDate>Thu, 02 Apr 2020 16:58:23 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200402-use-fluentd/</guid>
        <description>è®¸å˜‰åçš„åšå®¢ https://xujiahua.github.io/posts/20200402-use-fluentd/ -&lt;p&gt;ä»¥æ”¶é›†Dockerå®¹å™¨æ—¥å¿—çš„ä¾‹å­ï¼Œä»‹ç»ä¸‹Fluentdçš„ç”¨æ³•ã€‚ä¸è€ƒè™‘logstashï¼Œå¤ªå æœåŠ¡å™¨èµ„æºäº†ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å®‰è£…-fluentd&#34;&gt;å®‰è£… Fluentd&lt;/h2&gt;
&lt;p&gt;Ubuntu 18.04ä¸Šçš„å®‰è£…å‘½ä»¤ï¼ˆhttps://docs.fluentd.org/installation/install-by-debï¼‰ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# curl -L https://toolbelt.treasuredata.com/sh/install-ubuntu-bionic-td-agent3.sh | sh
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ä»¥Daemonæ–¹å¼å¯åŠ¨ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# systemctl start td-agent.service
root@ubuntu-parallel:~# systemctl status td-agent.service
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;fluentdçš„å®‰è£…ç›®å½•æ˜¯åœ¨/opt/td-agent/ä¸‹çš„ã€‚ä¸ºæ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ &lt;code&gt;/opt/td-agent/embedded/bin/fluentd&lt;/code&gt;è¿™ä¸ªç¨‹åºã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# ps -ef | grep fluentd
td-agent 30596     1  0 17:10 ?        00:00:00 /opt/td-agent/embedded/bin/ruby /opt/td-agent/embedded/bin/fluentd --log /var/log/td-agent/td-agent.log --daemon /var/run/td-agent/td-agent.pid
td-agent 30602 30596  9 17:10 ?        00:00:00 /opt/td-agent/embedded/bin/ruby -Eascii-8bit:ascii-8bit /opt/td-agent/embedded/bin/fluentd --log /var/log/td-agent/td-agent.log --daemon /var/run/td-agent/td-agent.pid --under-supervisor
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å…¶ä»–ç³»ç»Ÿçš„å®‰è£…å‚è€ƒï¼šhttps://docs.fluentd.org/installation&lt;/p&gt;
&lt;h3 id=&#34;å°è¯•ç‰›åˆ€&#34;&gt;å°è¯•ç‰›åˆ€&lt;/h3&gt;
&lt;p&gt;é…ç½®æ–‡ä»¶ test.confï¼Œå¯åŠ¨ä¸€ä¸ªHTTPæœåŠ¡ï¼Œå¹¶æŠŠæ¥æ”¶åˆ°çš„æ—¥å¿—ï¼Œæ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;source&amp;gt;
  @type http
  port 9880
&amp;lt;/source&amp;gt;

&amp;lt;match *.*&amp;gt;
  @type stdout
&amp;lt;/match&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¯åŠ¨fluentdè¿›ç¨‹ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# /opt/td-agent/embedded/bin/fluentd -c test.conf
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;é€šè¿‡HTTPæœåŠ¡æäº¤æ—¥å¿—ã€‚å¯ä»¥çœ‹åˆ°fluentdç»ˆç«¯æ‰“å°å‡ºäº†è¾“å…¥çš„æ—¥å¿—ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# curl -X POST -d &#39;json={&amp;quot;event&amp;quot;:&amp;quot;data&amp;quot;}&#39; http://localhost:9880/my.tag
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;å®æˆ˜æ”¶é›†linuxä¸»æœºä¸Šçš„dockerå®¹å™¨æ—¥å¿—&#34;&gt;å®æˆ˜ï¼šæ”¶é›†Linuxä¸»æœºä¸Šçš„Dockerå®¹å™¨æ—¥å¿—&lt;/h2&gt;
&lt;p&gt;Dockerå®˜æ–¹æœ‰fluentdçš„Logging Driverã€‚ä¸è¶³ä¹‹å¤„ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å› ä¸ºæ²¡æœ‰äº†æœ¬åœ°æ—¥å¿—æ–‡ä»¶ï¼Œdocker logs ä¸ç®¡ç”¨äº†ã€‚&lt;/li&gt;
&lt;li&gt;éœ€è¦é¢å¤–é…ç½®ï¼Œæˆ–æ˜¯åœ¨daemon.jsoné‡Œè®¾å®šï¼Œæˆ–æ˜¯docker runæ—¶å€™è®¾å®šã€‚æ–°å¢æœºå™¨æˆ–æ˜¯è¿è¡Œå®¹å™¨ï¼Œå¾ˆå®¹æ˜“å¿˜è®°ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœè¿œç¨‹æ•°æ®å­˜å‚¨downäº†ï¼Œä¼šä¸ä¼šä¸¢æ—¥å¿—ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è€ƒè™‘åˆ°è¿™äº›é—®é¢˜ï¼Œæœ¬å®éªŒä»¥æ”¶é›†æœ¬åœ°æ—¥å¿—çš„æ–¹å¼ä½¿ç”¨fluentdã€‚&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒå‰ææ¡ä»¶&#34;&gt;å®éªŒå‰ææ¡ä»¶&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;Linuxç³»ç»Ÿ&lt;/li&gt;
&lt;li&gt;Dockerå®¹å™¨ä½¿ç”¨é»˜è®¤çš„Logging Driverï¼Œä¹Ÿå°±æ˜¯json-file&lt;/li&gt;
&lt;li&gt;å®¹å™¨æ—¥å¿—ç›®å½•ï¼ˆä¹ŸåŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶çš„ï¼‰&lt;code&gt;/var/lib/docker/containers&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;é…ç½®æ–‡ä»¶è¾“å‡ºåˆ°stdout&#34;&gt;é…ç½®æ–‡ä»¶ï¼ˆè¾“å‡ºåˆ°stdoutï¼‰&lt;/h3&gt;
&lt;p&gt;å®šä¹‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ docker.container.log.conf&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;source&amp;gt;
  @type tail
  path /var/lib/docker/containers/*/*-json.log
  pos_file /var/log/docker_container.log.pos
  tag docker.*
  refresh_interval 10
  read_from_head true
  &amp;lt;parse&amp;gt;
    @type json
  &amp;lt;/parse&amp;gt;
&amp;lt;/source&amp;gt;

&amp;lt;filter docker.var.lib.docker.containers.*.*.log&amp;gt;
  @type parser
  key_name log
  remove_key_name_field true
  &amp;lt;parse&amp;gt;
    @type json
  &amp;lt;/parse&amp;gt;
&amp;lt;/filter&amp;gt;

&amp;lt;filter docker.var.lib.docker.containers.*.*.log&amp;gt;
  @type record_transformer
  &amp;lt;record&amp;gt;
    container_id ${tag_parts[5]}
    hostname &amp;quot;#{Socket.gethostname}&amp;quot;
  &amp;lt;/record&amp;gt;
&amp;lt;/filter&amp;gt;

&amp;lt;match docker.var.lib.docker.containers.*.*.log&amp;gt;
  @type stdout
&amp;lt;/match&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;ç®€è¦ä»‹ç»&#34;&gt;ç®€è¦ä»‹ç»&lt;/h4&gt;
&lt;p&gt;ä¸€ä¸ªå…¸å‹çš„æ—¥å¿—æ”¶é›†è¿‡ç¨‹åˆ†ä¸‰éƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å®šä¹‰æ•°æ®æºï¼Œä¹Ÿå°±æ˜¯sourceéƒ¨åˆ†&lt;/li&gt;
&lt;li&gt;æ¯æ¡æ•°æ®å¯ä»¥å¢åˆ ä¿®æ”¹å­—æ®µï¼Œä¹Ÿå°±æ˜¯filteréƒ¨åˆ†ï¼Œfilterå¯ä»¥æ˜¯0ä¸ªæˆ–æ˜¯å¤šä¸ªï¼ŒæŒ‰é¡ºåºå¤„ç†ã€‚&lt;/li&gt;
&lt;li&gt;æ•°æ®è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯matchéƒ¨åˆ†&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;source&#34;&gt;source&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;@type tail ä½¿ç”¨tailæ’ä»¶ &lt;a href=&#34;https://docs.fluentd.org/input/tail&#34;&gt;https://docs.fluentd.org/input/tail&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;path å®šä¹‰è·¯å¾„ï¼Œæ­£åˆ™åŒ¹é…&lt;/li&gt;
&lt;li&gt;pos_file å­˜æ”¾è¯»æ–‡ä»¶çš„offset&lt;/li&gt;
&lt;li&gt;éœ€è¦å®šä¹‰tagï¼Œfilterã€matchä½¿ç”¨tagè¿›è¡ŒåŒ¹é…ã€‚&lt;/li&gt;
&lt;li&gt;tag docker.*ï¼Œ*ä¼šè¢«å®é™…çš„æ–‡ä»¶åç»™æ›¿ä»£&lt;/li&gt;
&lt;li&gt;refresh_interval è®¾ç½®å¤šä¹…åˆ·æ–°ç›‘å¬çš„æ–‡ä»¶åˆ—è¡¨ï¼Œé»˜è®¤60ç§’&lt;/li&gt;
&lt;li&gt;read_from_head é»˜è®¤falseï¼Œä¹Ÿå°±æ˜¯ï¼Œæ²¡æœ‰poså­˜åœ¨çš„è¯ï¼Œä»æ–‡ä»¶å°¾è¯»å–ã€‚è®¾ç½®ä¸ºtrueï¼Œè§£å†³æ–°å¢æ–‡ä»¶è€Œæ–‡ä»¶åˆæ²¡è¢«fluentdåŠæ—¶ç›‘å¬èµ·æ¥çš„é—®é¢˜ã€‚&lt;/li&gt;
&lt;li&gt;parse ä½¿ç”¨jsonè§£æï¼Œå› ä¸ºdockerçš„logging driverç”¨çš„json-file&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ›´å¤šsourceæ’ä»¶è§ï¼šhttps://docs.fluentd.org/input&lt;/p&gt;
&lt;h4 id=&#34;filter&#34;&gt;filter&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;æŒ‡å®štag pattern&lt;/li&gt;
&lt;li&gt;@type parser ä½¿ç”¨parseræ’ä»¶ &lt;a href=&#34;https://docs.fluentd.org/filter/parser&#34;&gt;https://docs.fluentd.org/filter/parser&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;key_name éœ€è¦parseçš„å­—æ®µå&lt;/li&gt;
&lt;li&gt;remove_key_name_field å› ä¸ºæˆ‘ä»¬åªéœ€è¦logå­—æ®µçš„jsonå†…å®¹ï¼Œlogå­—æ®µæœ¬èº«ä¸éœ€è¦ä¿ç•™&lt;/li&gt;
&lt;li&gt;parse è§£æä¸ºjsonï¼Œå› ä¸ºæˆ‘ä»¬çš„åº”ç”¨æ—¥å¿—æ˜¯jsonæ ¼å¼è¾“å‡ºçš„&lt;/li&gt;
&lt;li&gt;@type record_transformer ä½¿ç”¨record_transformeræ’ä»¶ &lt;a href=&#34;https://docs.fluentd.org/filter/record_transformer&#34;&gt;https://docs.fluentd.org/filter/record_transformer&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;record æ–°å¢å­—æ®µ&lt;/li&gt;
&lt;li&gt;${tag_parts[5]} é¢„å®šä¹‰çš„å˜é‡ï¼Œtag_partsæ˜¯tagå­—ç¬¦ä¸²è¢«&amp;rdquo;.&amp;ldquo;åˆ‡åˆ†åçš„æ•°ç»„ï¼Œç¬¬6ä¸ªä»£è¡¨çš„æ˜¯container_id&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;quot;#{Socket.gethostname}&amp;quot;&lt;/code&gt; rubyå†…çš„å˜é‡&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ›´å¤šfilteræ’ä»¶è§ï¼šhttps://docs.fluentd.org/filter&lt;/p&gt;
&lt;h4 id=&#34;match&#34;&gt;match&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;æŒ‡å®štag pattern&lt;/li&gt;
&lt;li&gt;@type stdout ä½¿ç”¨stdoutæ’ä»¶ï¼Œç”¨äºæ¼”ç¤º &lt;a href=&#34;https://docs.fluentd.org/output/stdout&#34;&gt;https://docs.fluentd.org/output/stdout&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;å¯åŠ¨fluentd&#34;&gt;å¯åŠ¨fluentd&lt;/h3&gt;
&lt;p&gt;æ³¨æ„æŸ¥çœ‹æ—¥å¿—ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# /opt/td-agent/embedded/bin/fluentd -c docker.container.log.conf
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;ç”Ÿæˆæ—¥å¿—&#34;&gt;ç”Ÿæˆæ—¥å¿—&lt;/h3&gt;
&lt;p&gt;JSONæ ¼å¼è¾“å‡ºæ¯ä¸€è¡Œæ—¥å¿—ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# docker run -it busybox echo &#39;{&amp;quot;user&amp;quot;:1,&amp;quot;num&amp;quot;:2}&#39;
{&amp;quot;user&amp;quot;:1,&amp;quot;num&amp;quot;:2}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è§‚å¯Ÿ &lt;code&gt;/var/lib/docker/containers/*/*-json.log&lt;/code&gt;æ—¥å¿—å†…å®¹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{&amp;quot;log&amp;quot;:&amp;quot;{\&amp;quot;user\&amp;quot;:1,\&amp;quot;num\&amp;quot;:2}\r\n&amp;quot;,&amp;quot;stream&amp;quot;:&amp;quot;stdout&amp;quot;,&amp;quot;time&amp;quot;:&amp;quot;2020-04-02T12:25:50.877037148Z&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;fluentd stdoutè¾“å‡ºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{&amp;quot;user&amp;quot;:1,&amp;quot;num&amp;quot;:2,&amp;quot;container_id&amp;quot;:&amp;quot;e4fb94ee2d067450eeaf15837ed1497e2b7eb2f6754ba4eec1792ee37e31f12f&amp;quot;,&amp;quot;hostname&amp;quot;:&amp;quot;ubuntu-parallel&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;è¾“å‡ºä»stdoutæ”¹ä¸ºelasticsearch&#34;&gt;è¾“å‡ºä»stdoutæ”¹ä¸ºelasticsearch&lt;/h3&gt;
&lt;h4 id=&#34;å¯åŠ¨es&#34;&gt;å¯åŠ¨ES&lt;/h4&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-docker.html&#34;&gt;https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-docker.html&lt;/a&gt;ï¼Œä½¿ç”¨docker-composeå¯åŠ¨eså’ŒkibanaæœåŠ¡ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# docker-compose up
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;ä¿®æ”¹match&#34;&gt;ä¿®æ”¹match&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;match docker.var.lib.docker.containers.*.*.log&amp;gt;
  @type elasticsearch
  host localhost
  port 9200
  logstash_format true
&amp;lt;/match&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å‚è€ƒï¼šhttps://docs.fluentd.org/output/elasticsearch&lt;/p&gt;
&lt;h4 id=&#34;å¯åŠ¨fluentd-1&#34;&gt;å¯åŠ¨fluentd&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# /opt/td-agent/embedded/bin/fluentd -c docker.container.log.es.conf
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;kibanaæ—¥å¿—åˆ†æ&#34;&gt;kibanaæ—¥å¿—åˆ†æ&lt;/h4&gt;
&lt;p&gt;å› ä¸ºESçš„æ—¥å¿—å·²ç»æ˜¯JSONæ ¼å¼è¾“å‡ºçš„ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦é¢å¤–é€ æ•°æ®äº†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200403001746670.png&#34; alt=&#34;image-20200403001746670&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;å®¹å™¨ä¸Šä¸‹æ–‡ä¿¡æ¯&#34;&gt;å®¹å™¨ä¸Šä¸‹æ–‡ä¿¡æ¯&lt;/h3&gt;
&lt;p&gt;å¯ä»¥è€ƒè™‘è¿™ä¸ªfilteræ’ä»¶ &lt;a href=&#34;https://github.com/zsoltf/fluent-plugin-docker_metadata_elastic_filter&#34;&gt;https://github.com/zsoltf/fluent-plugin-docker_metadata_elastic_filter&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;filter docker.var.lib.docker.containers.*.*.log&amp;gt;
  type docker_metadata_elastic
&amp;lt;/filter&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ–°å¢ docker  ç»“æ„ä½“ï¼ŒåŒ…å«é•œåƒåç§°ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{
  &amp;quot;log&amp;quot;: &amp;quot;2015/05/05 19:54:41 \n&amp;quot;,
  &amp;quot;stream&amp;quot;: &amp;quot;stderr&amp;quot;,
  &amp;quot;docker&amp;quot;: {
    &amp;quot;id&amp;quot;: &amp;quot;df14e0d5ae4c07284fa636d739c8fc2e6b52bc344658de7d3f08c36a2e804115&amp;quot;,
    &amp;quot;name&amp;quot;: &amp;quot;k8s_fabric8-console-container.efbd6e64_fabric8-console-controller-9knhj_default_8ae2f621-f360-11e4-8d12-54ee7527188d_7ec9aa3e&amp;quot;,
    &amp;quot;container_hostname&amp;quot;: &amp;quot;fabric8-console-controller-9knhj&amp;quot;,
    &amp;quot;image&amp;quot;: &amp;quot;fabric8/hawtio-kubernetes:latest&amp;quot;,
    &amp;quot;image_id&amp;quot;: &amp;quot;b2bd1a24a68356b2f30128e6e28e672c1ef92df0d9ec01ec0c7faea5d77d2303&amp;quot;,
    &amp;quot;labels&amp;quot;: {}
  }
}
&lt;/code&gt;&lt;/pre&gt;- https://xujiahua.github.io/posts/20200402-use-fluentd/ - </description>
        </item>
    
    
  </channel>
</rss> 