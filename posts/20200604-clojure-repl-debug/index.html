<!DOCTYPE html>
<html><head>
<title>使用 REPL 调试 Clojure 项目</title>

<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-162706610-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>




<link rel="stylesheet" href="https://xujiahua.github.io/scss/journal.min.5c667e74038e21ddbb9024b67930f8544e02af62491281cf73fdb817eec2947e.css" integrity="sha256-XGZ&#43;dAOOId27kCS2eTD4VE4Cr2JJEoHPc/24F&#43;7ClH4=" media="screen">

<script src="https://xujiahua.github.io//js/loadCSS.js"></script>
<script src="https://xujiahua.github.io//js/table.js"></script>


<script src="https://xujiahua.github.io//js/toc.js"></script>


<script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
</script>






</head><body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://xujiahua.github.io/">
    
        <div class="nav-title">
            许嘉华的博客
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2020 许嘉华的博客
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7" v-on:click="closeDrawer" id="开发工具-nav">
										 开发工具
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#intellij-idea--cursive" v-on:click="closeDrawer" id="intellij-idea--cursive-nav">
										 Intellij IDEA &#43; Cursive
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#cursive-%e6%8f%92%e4%bb%b6%e6%8c%89%e9%94%ae%e5%86%b2%e7%aa%81" v-on:click="closeDrawer" id="cursive-插件按键冲突-nav">
										 Cursive 插件按键冲突
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e8%b7%b5" v-on:click="closeDrawer" id="实践-nav">
										 实践
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#metabase" v-on:click="closeDrawer" id="metabase-nav">
										 Metabase
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#repl-%e8%b0%83%e8%af%95-clojure-%e9%a1%b9%e7%9b%ae" v-on:click="closeDrawer" id="repl-调试-clojure-项目-nav">
										 REPL 调试 Clojure 项目
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#repl-%e4%bc%9a%e9%98%bb%e5%a1%9e" v-on:click="closeDrawer" id="repl-会阻塞-nav">
										 REPL 会阻塞
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e6%80%bb%e7%bb%93" v-on:click="closeDrawer" id="总结-nav">
										 总结
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%bc%80%e5%8f%91%e5%b7%a5%e5%85%b7" v-on:click="closeDrawer" id="开发工具-nav">
										 开发工具
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#intellij-idea--cursive" v-on:click="closeDrawer" id="intellij-idea--cursive-nav">
										 Intellij IDEA &#43; Cursive
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#cursive-%e6%8f%92%e4%bb%b6%e6%8c%89%e9%94%ae%e5%86%b2%e7%aa%81" v-on:click="closeDrawer" id="cursive-插件按键冲突-nav">
										 Cursive 插件按键冲突
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e8%b7%b5" v-on:click="closeDrawer" id="实践-nav">
										 实践
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#metabase" v-on:click="closeDrawer" id="metabase-nav">
										 Metabase
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#repl-%e8%b0%83%e8%af%95-clojure-%e9%a1%b9%e7%9b%ae" v-on:click="closeDrawer" id="repl-调试-clojure-项目-nav">
										 REPL 调试 Clojure 项目
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#repl-%e4%bc%9a%e9%98%bb%e5%a1%9e" v-on:click="closeDrawer" id="repl-会阻塞-nav">
										 REPL 会阻塞
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e6%80%bb%e7%bb%93" v-on:click="closeDrawer" id="总结-nav">
										 总结
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://xujiahua.github.io/">
            许嘉华的博客
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://xujiahua.github.io/">
        <div class="single-column-header-title">许嘉华的博客</div>
        

    </a>
</div>
            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                 style="background-image: url('/')">
                <div class="post-title">
                    使用 REPL 调试 Clojure 项目
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2020-06-04 16:13
                        </time>
                        

                        

                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                <div class="post-body">
                    <h2 id="开发工具">开发工具</h2>
<h3 id="intellij-idea--cursive">Intellij IDEA + Cursive</h3>
<p>安装 IDEA 社区版即可，并安装插件 Cursive。</p>
<p><img src="../../images/image-20200604161831382.png" alt="image-20200604161831382"></p>
<h4 id="cursive-插件按键冲突">Cursive 插件按键冲突</h4>
<p>比如我会用组合键<code>⌘ + [</code>浏览代码，与 Cursive 插件的按键冲突。可以取消 Cursive 的这个组合键。</p>
<p><img src="../../images/image-20200604162732892.png" alt="image-20200604162732892"></p>
<h2 id="实践">实践</h2>
<h3 id="metabase">Metabase</h3>
<p>接触 Clojure 是因为 Metabase 这个项目 <a href="https://github.com/metabase/metabase">https://github.com/metabase/metabase</a> 。以 Metabase 为例，说明如何调试 Clojure 项目。</p>
<p>Metabase 由前后端两部分组成，后端是由 Clojure 写的 REST API 项目。启动前端工程，需要在前端界面上触发 API 请求。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yarn build-hot
</code></pre></div><p>参考</p>
<ol>
<li>Metabase developers-guide <a href="https://github.com/metabase/metabase/blob/master/docs/developers-guide.md">https://github.com/metabase/metabase/blob/master/docs/developers-guide.md</a></li>
</ol>
<h3 id="repl-调试-clojure-项目">REPL 调试 Clojure 项目</h3>
<p>新建一个 Clojure REPL 配置。</p>
<p><img src="../../images/image-20200604163122517.png" alt="image-20200604163122517"></p>
<p>展开右下角的 REPL 子窗口，Run REPL for metabase-core。（注意，此时，项目中的 clojure namespace 并没有实际加载。代码编辑区运行 Clojure 函数，会报错，<code>Error: :namespace-not-found</code>）</p>
<p><img src="../../images/image-20200604163823092.png" alt="image-20200604163823092"></p>
<p>metabase.core.clj 是整个项目的入口文件。执行 Load File in REPL。插件自动把所有 metabase.core 的依赖加载进 REPL 中。</p>
<p><img src="../../images/image-20200604164551541.png" alt="image-20200604164551541"></p>
<p>Load 成功。</p>
<p><img src="../../images/image-20200604165257244.png" alt="image-20200604165257244"></p>
<p>入口函数<code>-main</code>并不会自动运行的。调用<code>-main</code>并发送函数到 REPL 中执行。</p>
<p><img src="../../images/image-20200604165642551.png" alt="image-20200604165642551"></p>
<p>print 调试，改完代码即可生效。如下，加入打印变量函数，执行<code>Load File in REPL</code>/<code>Sync Files in REPL</code>/<code>Send xxx to REPL</code>让函数生效。</p>
<p><img src="../../images/image-20200604171525496.png" alt="image-20200604171525496"></p>
<h4 id="repl-会阻塞">REPL 会阻塞</h4>
<p>会有发送函数到 REPL 中执行，而没有反应的情况。需要注意，REPL 会阻塞。</p>
<p><code>(.join (server/instance)))</code> Jetty Server 阻塞住当前线程。所以其他函数在 REPL 中被阻塞了。</p>
<p>Metabase 入口代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">(<span style="color:#66d9ef">defn- </span>start-normally []
  (<span style="color:#a6e22e">log/info</span> (<span style="color:#a6e22e">trs</span> <span style="color:#e6db74">&#34;Starting Metabase in STANDALONE mode&#34;</span>))
  (<span style="color:#a6e22e">try</span>
    <span style="color:#75715e">;; launch embedded webserver async</span>
    (<span style="color:#a6e22e">server/start-web-server!</span> handler/app)
    <span style="color:#75715e">;; run our initialization process</span>
    (<span style="color:#a6e22e">init!</span>)
    <span style="color:#75715e">;; Ok, now block forever while Jetty does its thing</span>
    (when (<span style="color:#a6e22e">config/config-bool</span> <span style="color:#e6db74">:mb-jetty-join</span>)
      (<span style="color:#a6e22e">.join</span> (<span style="color:#a6e22e">server/instance</span>)))
    (<span style="color:#a6e22e">catch</span> Throwable e
      (<span style="color:#a6e22e">log/error</span> e (<span style="color:#a6e22e">trs</span> <span style="color:#e6db74">&#34;Metabase Initialization FAILED&#34;</span>))
      (<span style="color:#a6e22e">System/exit</span> <span style="color:#ae81ff">1</span>))))

(<span style="color:#66d9ef">defn </span>-main
  <span style="color:#e6db74">&#34;Launch Metabase in standalone mode.&#34;</span>
  [<span style="color:#f92672">&amp;</span> [cmd <span style="color:#f92672">&amp;</span> args]]
  (<span style="color:#a6e22e">maybe-enable-tracing</span>)
  (<span style="color:#66d9ef">if </span>cmd
    (<span style="color:#a6e22e">run-cmd</span> cmd args) <span style="color:#75715e">; run a command like `java -jar metabase.jar migrate release-locks` or `lein run migrate release-locks`</span>
    (<span style="color:#a6e22e">start-normally</span>))) <span style="color:#75715e">; with no command line args just start Metabase normally</span>
</code></pre></div><p>解决办法，就是不要让代码阻塞住当前线程、REPL。</p>
<p>参考：</p>
<ol>
<li>The Cursive REPL <a href="https://cursive-ide.com/userguide/repl.html">https://cursive-ide.com/userguide/repl.html</a></li>
</ol>
<h2 id="总结">总结</h2>
<p>REPL 的方式调试代码还是蛮新奇的，对我来说。</p>

                    
                    <HR width="100%" id="EOF">
                    <p style="color:#777;">Last modified on 2020-06-04</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts">
                    Next<br>No newer posts.
                </a>
                
                
                
                <a class="older-posts" href="https://xujiahua.github.io/posts/20200529-bi_project/">
                    Previous<br>记一次数据项目经历
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                






            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2020 许嘉华的博客
	</div>
    	</div>
    <script src="https://xujiahua.github.io//js/journal.js"></script>
    </body>
</html>
