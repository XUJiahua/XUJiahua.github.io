<!DOCTYPE html>
<html><head>
<title>瘦终端指北 —— ICMP tunnel</title>

<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-162706610-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>




<link rel="stylesheet" href="https://xujiahua.github.io/scss/journal.min.5d0fd093a264465a2c30c56fbe9eb8cdb0764ecf3eb96e8c64de3cf6c081cc40.css" integrity="sha256-XQ/Qk6JkRlosMMVvvp64zbB2Ts8&#43;uW6MZN489sCBzEA=" media="screen">

<script src="https://xujiahua.github.io//js/loadCSS.js"></script>
<script src="https://xujiahua.github.io//js/table.js"></script>


<script src="https://xujiahua.github.io//js/toc.js"></script>


<script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
</script>






</head><body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://xujiahua.github.io/">
    
        <div class="nav-title">
            许嘉华的笔记
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2021 许嘉华的笔记
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#icmp" v-on:click="closeDrawer" id="icmp-nav">
										 ICMP
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#icmp-tunnel" v-on:click="closeDrawer" id="icmp-tunnel-nav">
										 ICMP tunnel
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%bb%ba%e7%ab%8b-icmp-tunnel" v-on:click="closeDrawer" id="建立-icmp-tunnel-nav">
										 建立 ICMP tunnel
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#network-traffic" v-on:click="closeDrawer" id="network-traffic-nav">
										 Network Traffic
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#ssh-%e9%9a%a7%e9%81%93%e4%bb%a3%e7%90%86" v-on:click="closeDrawer" id="ssh-隧道代理-nav">
										 SSH 隧道代理
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%8e%9f%e7%90%86" v-on:click="closeDrawer" id="原理-nav">
										 原理
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#overall-architecture" v-on:click="closeDrawer" id="overall-architecture-nav">
										 Overall Architecture
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#client-architecture" v-on:click="closeDrawer" id="client-architecture-nav">
										 Client Architecture
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#proxy-server-architecture" v-on:click="closeDrawer" id="proxy-server-architecture-nav">
										 Proxy Server Architecture
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e7%8e%b0%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" v-on:click="closeDrawer" id="实现注意事项-nav">
										 实现注意事项
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e6%80%bb%e7%bb%93" v-on:click="closeDrawer" id="总结-nav">
										 总结
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%8f%82%e8%80%83" v-on:click="closeDrawer" id="参考-nav">
										 参考
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#icmp" v-on:click="closeDrawer" id="icmp-nav">
										 ICMP
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#icmp-tunnel" v-on:click="closeDrawer" id="icmp-tunnel-nav">
										 ICMP tunnel
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%bb%ba%e7%ab%8b-icmp-tunnel" v-on:click="closeDrawer" id="建立-icmp-tunnel-nav">
										 建立 ICMP tunnel
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#network-traffic" v-on:click="closeDrawer" id="network-traffic-nav">
										 Network Traffic
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#ssh-%e9%9a%a7%e9%81%93%e4%bb%a3%e7%90%86" v-on:click="closeDrawer" id="ssh-隧道代理-nav">
										 SSH 隧道代理
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%8e%9f%e7%90%86" v-on:click="closeDrawer" id="原理-nav">
										 原理
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#overall-architecture" v-on:click="closeDrawer" id="overall-architecture-nav">
										 Overall Architecture
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#client-architecture" v-on:click="closeDrawer" id="client-architecture-nav">
										 Client Architecture
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#proxy-server-architecture" v-on:click="closeDrawer" id="proxy-server-architecture-nav">
										 Proxy Server Architecture
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e7%8e%b0%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" v-on:click="closeDrawer" id="实现注意事项-nav">
										 实现注意事项
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e6%80%bb%e7%bb%93" v-on:click="closeDrawer" id="总结-nav">
										 总结
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%8f%82%e8%80%83" v-on:click="closeDrawer" id="参考-nav">
										 参考
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://xujiahua.github.io/">
            许嘉华的笔记
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://xujiahua.github.io/">
        <div class="single-column-header-title">许嘉华的笔记</div>
        

    </a>
</div>
            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                 style="background-image: url('/')">
                <div class="post-title">
                    瘦终端指北 —— ICMP tunnel
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2020-09-03 17:02
                        </time>
                        

                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/linux">Linux</a>
                                &nbsp;
                            
                                <a href="/tags/tunnel">tunnel</a>
                                &nbsp;
                            
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                <div class="post-body">
                    <p>因为公司有开发泄露源码在 Github，对公司声誉造成一定影响，公司层面推广起瘦终端，所有开发一起背锅 :( 。在瘦终端里，网络严格管控，vscode 下载插件都难，需要申请 IP 白名单。开发只允许在瘦终端里接触 git 仓库，只能向瘦终端拷贝文件，反之不能。这样就能防住代码泄露么？</p>
<p>搞笑的办法，瘦终端生成二维码，主机扫描，数据传输问题搞定。</p>
<p>从网络角度，怎么解决呢。我们来严肃看待这个技术问题。</p>
<h2 id="icmp">ICMP</h2>
<p>实践发现，瘦终端里不能访问百度，但是能 ping 通。从 TCP/IP 的角度，瘦终端在网络上只是 TCP 传输层被流量管控了，IP 层还是畅通无阻的。</p>
<p>下图为 TCP/IP 的层次结构，TCP 包封装于 IP 包。</p>
<p><img src="../../images/Packet-encapsulation-TCP-IP-architecture-encapsulates-the-data-from-the-upper-layer-by.png" alt="3: Packet encapsulation. TCP/IP architecture encapsulates the data from the upper layer by attaching a &ldquo;header&rdquo; of the current-layer protocol into the data."></p>
<p><a href="https://www.researchgate.net/figure/Packet-encapsulation-TCP-IP-architecture-encapsulates-the-data-from-the-upper-layer-by_fig4_49288737">https://www.researchgate.net/figure/Packet-encapsulation-TCP-IP-architecture-encapsulates-the-data-from-the-upper-layer-by_fig4_49288737</a></p>
<p>目前网站的基石是 HTTP/TCP 协议，代理也普遍是基于 HTTP/TCP 的，shadowsocks 翻墙的思路不通。</p>
<p>所以 ICMP 协议是否能作为代理协议呢。从封包的角度，ICMP 与 TCP 一样，也是封在 IP 包中的。</p>
<p><img src="../../images/fire0602.gif" alt="Figure 6.2"></p>
<p><a href="http://web.deu.edu.tr/doc/oreily/networking/firewall/ch06_03.htm">http://web.deu.edu.tr/doc/oreily/networking/firewall/ch06_03.htm</a></p>
<p>ICMP 有 Data 字段，可用于存储需要被代理的 TCP 包（协议允许附加最大 64K 大小的 Payload）。从而突破防火墙。</p>
<p><img src="../../images/ICMP-packet-structure.png" alt="ICMP packet structure "></p>
<p><a href="https://www.researchgate.net/figure/ICMP-packet-structure_fig5_316727741">https://www.researchgate.net/figure/ICMP-packet-structure_fig5_316727741</a></p>
<h2 id="icmp-tunnel">ICMP tunnel</h2>
<p>ICMP 隧道，使用 ICMP 协议建立的两台计算机的连接。可用该隧道传输 TCP 流量。</p>
<blockquote>
<p>An <strong>ICMP tunnel</strong>[<a href="https://en.wikipedia.org/wiki/ICMP_tunnel#cite_note-ptunnel-1">1]</a> establishes a <a href="https://en.wikipedia.org/wiki/Covert_channel">covert</a> connection between two remote computers (a client and proxy), using <a href="https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol">ICMP</a> echo requests and reply packets. An example of this technique is <a href="https://en.wikipedia.org/wiki/Tunneling_protocol">tunneling</a> complete <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a> traffic over ping requests and replies.</p>
<p><a href="https://en.wikipedia.org/wiki/ICMP_tunnel">https://en.wikipedia.org/wiki/ICMP_tunnel</a></p>
</blockquote>
<p>前人早已栽树，开源实现： <a href="https://github.com/jamesbarlow/icmptunnel">https://github.com/jamesbarlow/icmptunnel</a></p>
<h3 id="建立-icmp-tunnel">建立 ICMP tunnel</h3>
<p>Linux 上编译 icmptunnel：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git clone git@github.com:jamesbarlow/icmptunnel.git
$ make
</code></pre></div><p>没在瘦终端试验，因为还没尝试将 icmptunnel 编译到 Windows 平台，https://github.com/esrrhs/pingtunnel 是跨平台的，可以参考下。</p>
<p>Vagrant 启动两台 Ubuntu 虚拟机试验下，两台虚拟机通过网卡 enp0s8 互联，假设两者通信只允许 ICMP。</p>
<p>Proxy server 192.168.33.12：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</span>

<span style="color:#75715e"># ./icmptunnel –s</span>
opened tunnel device: tun0
<span style="color:#f92672">(</span>ctrl-z<span style="color:#f92672">)</span>
<span style="color:#75715e"># bg</span>
<span style="color:#75715e"># ifconfig tun0 10.0.0.1 netmask 255.255.255.0</span>

<span style="color:#75715e"># ifconfig</span>
enp0s8: flags<span style="color:#f92672">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
        inet 192.168.33.12  netmask 255.255.255.0  broadcast 192.168.33.255
        inet6 fe80::a00:27ff:feb6:74f5  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20&lt;link&gt;
        ether 08:00:27:b6:74:f5  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>
        RX packets <span style="color:#ae81ff">4808</span>  bytes <span style="color:#ae81ff">321774</span> <span style="color:#f92672">(</span>321.7 KB<span style="color:#f92672">)</span>
        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
        TX packets <span style="color:#ae81ff">1077</span>  bytes <span style="color:#ae81ff">95776</span> <span style="color:#f92672">(</span>95.7 KB<span style="color:#f92672">)</span>
        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>

lo: flags<span style="color:#f92672">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span style="color:#ae81ff">65536</span>
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen <span style="color:#ae81ff">128</span>  scopeid 0x10&lt;host&gt;
        loop  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Local Loopback<span style="color:#f92672">)</span>
        RX packets <span style="color:#ae81ff">44</span>  bytes <span style="color:#ae81ff">3890</span> <span style="color:#f92672">(</span>3.8 KB<span style="color:#f92672">)</span>
        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
        TX packets <span style="color:#ae81ff">44</span>  bytes <span style="color:#ae81ff">3890</span> <span style="color:#f92672">(</span>3.8 KB<span style="color:#f92672">)</span>
        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>

tun0: flags<span style="color:#f92672">=</span>4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
        inet 10.0.0.1  netmask 255.255.255.0  destination 10.0.0.1
        inet6 fe80::2743:f01:5f93:4c90  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20&lt;link&gt;
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen <span style="color:#ae81ff">500</span>  <span style="color:#f92672">(</span>UNSPEC<span style="color:#f92672">)</span>
        RX packets <span style="color:#ae81ff">156</span>  bytes <span style="color:#ae81ff">18219</span> <span style="color:#f92672">(</span>18.2 KB<span style="color:#f92672">)</span>
        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
        TX packets <span style="color:#ae81ff">134</span>  bytes <span style="color:#ae81ff">32887</span> <span style="color:#f92672">(</span>32.8 KB<span style="color:#f92672">)</span>
        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</code></pre></div><p>Client 192.168.33.11：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</span>
<span style="color:#75715e"># ./icmptunnel 192.168.33.12</span>
opened tunnel device: tun0
connection established.
<span style="color:#f92672">(</span>ctrl-z<span style="color:#f92672">)</span>
<span style="color:#75715e"># bg</span>
<span style="color:#75715e"># ifconfig tun0 10.0.0.2 netmask 255.255.255.0</span>

<span style="color:#75715e"># ifconfig</span>
enp0s8: flags<span style="color:#f92672">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
        inet 192.168.33.11  netmask 255.255.255.0  broadcast 192.168.33.255
        inet6 fe80::a00:27ff:fe65:dae7  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20&lt;link&gt;
        ether 08:00:27:65:da:e7  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>
        RX packets <span style="color:#ae81ff">1180</span>  bytes <span style="color:#ae81ff">118335</span> <span style="color:#f92672">(</span>118.3 KB<span style="color:#f92672">)</span>
        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
        TX packets <span style="color:#ae81ff">4603</span>  bytes <span style="color:#ae81ff">292845</span> <span style="color:#f92672">(</span>292.8 KB<span style="color:#f92672">)</span>
        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>

lo: flags<span style="color:#f92672">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span style="color:#ae81ff">65536</span>
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen <span style="color:#ae81ff">128</span>  scopeid 0x10&lt;host&gt;
        loop  txqueuelen <span style="color:#ae81ff">1000</span>  <span style="color:#f92672">(</span>Local Loopback<span style="color:#f92672">)</span>
        RX packets <span style="color:#ae81ff">122</span>  bytes <span style="color:#ae81ff">22468</span> <span style="color:#f92672">(</span>22.4 KB<span style="color:#f92672">)</span>
        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
        TX packets <span style="color:#ae81ff">122</span>  bytes <span style="color:#ae81ff">22468</span> <span style="color:#f92672">(</span>22.4 KB<span style="color:#f92672">)</span>
        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>

tun0: flags<span style="color:#f92672">=</span>4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu <span style="color:#ae81ff">1500</span>
        inet 10.0.0.2  netmask 255.255.255.0  destination 10.0.0.2
        inet6 fe80::673f:aedd:d37e:afc4  prefixlen <span style="color:#ae81ff">64</span>  scopeid 0x20&lt;link&gt;
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen <span style="color:#ae81ff">500</span>  <span style="color:#f92672">(</span>UNSPEC<span style="color:#f92672">)</span>
        RX packets <span style="color:#ae81ff">130</span>  bytes <span style="color:#ae81ff">32695</span> <span style="color:#f92672">(</span>32.6 KB<span style="color:#f92672">)</span>
        RX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">1</span>  overruns <span style="color:#ae81ff">0</span>  frame <span style="color:#ae81ff">0</span>
        TX packets <span style="color:#ae81ff">156</span>  bytes <span style="color:#ae81ff">18219</span> <span style="color:#f92672">(</span>18.2 KB<span style="color:#f92672">)</span>
        TX errors <span style="color:#ae81ff">0</span>  dropped <span style="color:#ae81ff">0</span> overruns <span style="color:#ae81ff">0</span>  carrier <span style="color:#ae81ff">0</span>  collisions <span style="color:#ae81ff">0</span>
</code></pre></div><p>试验联通性：</p>
<p>Server 上创建一个 web server。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python3 -m http.server <span style="color:#ae81ff">8000</span>
</code></pre></div><p>Client 上 curl：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ curl 10.0.0.1:8000
&lt;!DOCTYPE HTML PUBLIC <span style="color:#e6db74">&#34;-//W3C//DTD HTML 4.01//EN&#34;</span> <span style="color:#e6db74">&#34;http://www.w3.org/TR/html4/strict.dtd&#34;</span>&gt;
&lt;html&gt;
&lt;head&gt;
...
</code></pre></div><p>这样，两台虚拟机通过 ICMP 协议建立 tunnel 成功。Client (10.0.0.2) 可通过 TCP 协议访问 Proxy Server (10.0.0.1)。</p>
<h3 id="network-traffic">Network Traffic</h3>
<p>Client/Server 上抓包，假设 enp0s8 网卡上，client -&gt; server 只有 ICMP 协议流量。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># tcpdump -i tun0 -w tun0.pcap</span>

<span style="color:#75715e"># tcpdump -i enp0s8 -w enp0s8.pcap</span>
</code></pre></div><p>Client 执行 <code>curl 10.0.0.1:8000</code>。</p>
<p>Client enp0s8：</p>
<p><img src="../../images/image-20200903170657920.png" alt="image-20200903170657920"></p>
<p>Client tun0：</p>
<p><img src="../../images/image-20200903170805505.png" alt="image-20200903170805505"></p>
<p>Server enp0s8：</p>
<p><img src="../../images/image-20200903170855923.png" alt="image-20200903170855923"></p>
<p>Server tun0：</p>
<p><img src="../../images/image-20200903170932762.png" alt="image-20200903170932762"></p>
<p>如预期，enp0s8 网卡上只有 ICMP 协议通信，而 tun0 允许 HTTP/TCP。</p>
<h3 id="ssh-隧道代理">SSH 隧道代理</h3>
<p>ssh 隧道翻墙跟连普通服务器没啥两样了。</p>
<p>Client 生成 SSH 秘钥：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ssh-keygen</span>
<span style="color:#75715e"># cat ~/.ssh/id_rsa.pub</span>
</code></pre></div><p>Proxy server 让 client root 免密登录：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># vim ~/.ssh/authorized_keys</span>
</code></pre></div><p>Client 建立 socks 代理：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ssh -D 8080 -N root@10.0.0.1</span>
</code></pre></div><p>代理测试：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># curl -x socks5h://localhost:8080 http://baidu.com/</span>
&lt;html&gt;
&lt;meta http-equiv<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;refresh&#34;</span> content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0;url=http://www.baidu.com/&#34;</span>&gt;
&lt;/html&gt;
</code></pre></div><h3 id="原理">原理</h3>
<p>流程图借用 <a href="https://github.com/DhavalKapil/icmptunnel">https://github.com/DhavalKapil/icmptunnel</a></p>
<h4 id="overall-architecture">Overall Architecture</h4>
<p>示例中貌似 Client/Proxy Server分别是通过 tun0 网卡上的IP 通信。</p>
<p>Client 与 Proxy Server 之间通过 ICMP 协议通信，TCP/UDP over ICMP。Client 发送 Echo Request，Proxy Server 发送 Echo Reply。</p>
<pre><code>+--------------+                         +------------+
|              |       ICMP traffic      |            |       IP traffic
|    Client    |  -------------------&gt;   |   Proxy    |   ------------------&gt;
|              |  &lt;-------------------   |   Server   |   &lt;------------------
|              |    through restricted   |            |     proper internet
+--------------+         internet        +------------+
</code></pre><h4 id="client-architecture">Client Architecture</h4>
<pre><code>+--------------+                                    +------------+
|              |  IP traffic  +------+  IP traffic  |            |   ICMP traffic
|     User     |  ---------&gt;  | tun0 |  ---------&gt;  | icmptunnel | ---------------&gt;
| Applications |  &lt;---------  +------+  &lt;---------  |  program   | &lt;---------------
|              |        (Virtual Interface)         |            |    restricted 
+--------------+                                    +------------+     internet
</code></pre><h4 id="proxy-server-architecture">Proxy Server Architecture</h4>
<pre><code>                 +------------+
  ICMP traffic   |            |  IP traffic     +------+       NAT/Masquerading
---------------&gt; | icmptunnel | ------------&gt;   | tun0 |    ---------------------&gt; 
&lt;--------------- |  program   | &lt;------------   +------+    &lt;---------------------
   restricted    |            |           (Virtual Interface)   proper internet
    internet     +------------+
</code></pre><h4 id="实现注意事项">实现注意事项</h4>
<p>The client will perform all its communications using ICMP echo request (ping) packets (type 8), whereas the proxy will use echo reply packets (type 0)</p>
<p>Both the client and proxy maintain their own sequence number, and also a number indicating the last sequence number acknowledged by the remote peer.</p>
<h2 id="总结">总结</h2>
<p>除了瘦终端这个场景，如果你有在公共场所，比如酒店，用过需要网页注册登录才能使用的 WIFI，在不登录的情况下，你的主机只被分配了 IP，而没有浏览网页的能力。icmptunnel 这个工具就能派上用处了。</p>
<p>道高一尺魔高一丈，要是被网管封禁了 ICMP 流量或是只允许定长的 ICMP 包，就 GG 了。</p>
<blockquote>
<p>One way to prevent this type of tunneling is to block ICMP traffic, at the cost of losing some network functionality that people usually take for granted (e.g. it might take tens of seconds to determine that a peer is offline, rather than almost instantaneously). Another method for mitigating this type of attack is to only allow fixed sized ICMP packets through firewalls, which can impede or eliminate this type of behavior.[<a href="https://en.wikipedia.org/wiki/ICMP_tunnel#cite_note-3">3]</a></p>
<p><a href="https://en.wikipedia.org/wiki/ICMP_tunnel">https://en.wikipedia.org/wiki/ICMP_tunnel</a></p>
</blockquote>
<p>本文仅仅是一个技术探讨，切莫在犯罪的道路上越走越远。</p>
<h2 id="参考">参考</h2>
<ol>
<li>ICMP tunnel <a href="https://en.wikipedia.org/wiki/ICMP_tunnel">https://en.wikipedia.org/wiki/ICMP_tunnel</a></li>
<li>icmptunnel: Pivot with Ping <a href="https://labs.f-secure.com/tools/pivot-with-ping/">https://labs.f-secure.com/tools/pivot-with-ping/</a></li>
<li>内网渗透之ICMP隐藏隧道 <a href="https://xz.aliyun.com/t/7875#toc-4">https://xz.aliyun.com/t/7875#toc-4</a></li>
<li>内网渗透之内网穿透 <a href="https://xz.aliyun.com/t/7701">https://xz.aliyun.com/t/7701</a></li>
<li>Ping Tunnel <a href="http://www.cs.uit.no/~daniels/PingTunnel/">http://www.cs.uit.no/~daniels/PingTunnel/</a></li>
</ol>

                    
                    <HR width="100%" id="EOF">
                    <p style="color:#777;">Last modified on 2020-09-03</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://xujiahua.github.io/posts/20200907-docker-bridge-net-sim/">
                    Next<br>使用 ip/iptables 命令模拟 Docker bridge 网络
                </a>
                
                
                
                <a class="older-posts" href="https://xujiahua.github.io/posts/20200901-linux-namespace/">
                    Previous<br>Linux Namespace
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                






            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2021 许嘉华的笔记
	</div>
    	</div>
    <script src="https://xujiahua.github.io//js/journal.js"></script>
    </body>
</html>
