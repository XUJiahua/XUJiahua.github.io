<!DOCTYPE html>
<html><head>
<title>使用 Perceptual hashing 去除微信头像内容干扰</title>

<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-162706610-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>




<link rel="stylesheet" href="https://xujiahua.github.io/scss/journal.min.5c667e74038e21ddbb9024b67930f8544e02af62491281cf73fdb817eec2947e.css" integrity="sha256-XGZ&#43;dAOOId27kCS2eTD4VE4Cr2JJEoHPc/24F&#43;7ClH4=" media="screen">

<script src="https://xujiahua.github.io//js/loadCSS.js"></script>
<script src="https://xujiahua.github.io//js/table.js"></script>


<script src="https://xujiahua.github.io//js/toc.js"></script>


<script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
</script>






</head><body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://xujiahua.github.io/">
    
        <div class="nav-title">
            许嘉华的笔记
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2020 许嘉华的笔记
	
    </div>
    
</div><div ref="extraContainer" class="extra-container">
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e9%aa%8c%e6%a1%86%e6%9e%b6" v-on:click="closeDrawer" id="实验框架-nav">
										 实验框架
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e9%aa%8c%e6%95%b0%e6%8d%ae" v-on:click="closeDrawer" id="实验数据-nav">
										 实验数据
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e9%aa%8c%e6%9c%9f%e6%9c%9b" v-on:click="closeDrawer" id="实验期望-nav">
										 实验期望
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e9%aa%8c" v-on:click="closeDrawer" id="实验-nav">
										 实验
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%9b%be%e5%83%8f%e9%99%8d%e7%bb%b4%e6%96%b9%e6%b3%95" v-on:click="closeDrawer" id="图像降维方法-nav">
										 图像降维方法
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#perceptual-hashing" v-on:click="closeDrawer" id="perceptual-hashing-nav">
										 Perceptual hashing
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90" v-on:click="closeDrawer" id="详细分析-nav">
										 详细分析
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#todo" v-on:click="closeDrawer" id="todo-nav">
										 TODO
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e6%80%bb%e7%bb%93" v-on:click="closeDrawer" id="总结-nav">
										 总结
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- CATALOG -</center>
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e9%aa%8c%e6%a1%86%e6%9e%b6" v-on:click="closeDrawer" id="实验框架-nav">
										 实验框架
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e9%aa%8c%e6%95%b0%e6%8d%ae" v-on:click="closeDrawer" id="实验数据-nav">
										 实验数据
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e9%aa%8c%e6%9c%9f%e6%9c%9b" v-on:click="closeDrawer" id="实验期望-nav">
										 实验期望
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%ae%9e%e9%aa%8c" v-on:click="closeDrawer" id="实验-nav">
										 实验
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e5%9b%be%e5%83%8f%e9%99%8d%e7%bb%b4%e6%96%b9%e6%b3%95" v-on:click="closeDrawer" id="图像降维方法-nav">
										 图像降维方法
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#perceptual-hashing" v-on:click="closeDrawer" id="perceptual-hashing-nav">
										 Perceptual hashing
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90" v-on:click="closeDrawer" id="详细分析-nav">
										 详细分析
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#todo" v-on:click="closeDrawer" id="todo-nav">
										 TODO
									</a>
								</li>
						
							</ul>
						
							</ul>
						
							</ul>
						
							</ul>
						
					
				
			
				
				
					
						
						
							<ul>
						
							<ul>
						
						
								<li>
				 					<a href="#%e6%80%bb%e7%bb%93" v-on:click="closeDrawer" id="总结-nav">
										 总结
									</a>
								</li>
						
							</ul>
						
							</ul>
						
					
				
			
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="https://xujiahua.github.io/">
            许嘉华的笔记
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://xujiahua.github.io/">
        <div class="single-column-header-title">许嘉华的笔记</div>
        

    </a>
</div>
            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                 style="background-image: url('/')">
                <div class="post-title">
                    使用 Perceptual hashing 去除微信头像内容干扰
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2020-06-11 11:38
                        </time>
                        

                        

                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                <div class="post-body">
                    <p>本文是<a href="https://xujiahua.github.io/posts/20200514-wx-avatar/">「微信用户授权头像内容带随机干扰的问题」</a>的延续。本文对效果进行量化，并找到一个phash库，达到了更好的效果。</p>
<h2 id="实验框架">实验框架</h2>
<p>相关脚本<a href="https://github.com/XUJiahua/phash_test">点此</a>。</p>
<h3 id="实验数据">实验数据</h3>
<p>10 组微信头像，每组 10万个头像。</p>
<p>准备 10万 微信头像链接，重复下载10次：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./download.sh
</code></pre></div><h3 id="实验期望">实验期望</h3>
<p>期望目标：</p>
<ol>
<li>1 个头像链接对应 1 个特征：期望特征抽取算法能够剥离微信对头像内容加入的干扰。不然使用密码学哈希算法，1 个头像链接下载 10 次可能就对应 10 个特征了。</li>
<li>1 个特征对应 1 个头像链接。跟哈希算法一样，希望哈希冲突尽可能小。</li>
</ol>
<h2 id="实验">实验</h2>
<h3 id="图像降维方法">图像降维方法</h3>
<p>延续上文中在有限数据下得出的规则，图像降维到：32级灰度，10x10 尺寸。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">python extract_feature_p2.py

echo <span style="color:#e6db74">&#34;file,feature&#34;</span> &gt; header.csv
cat header.csv download_1.csv download_2.csv download_3.csv download_4.csv download_5.csv download_6.csv download_7.csv download_8.csv download_9.csv download_10.csv &gt; data.csv
</code></pre></div><p>两个指标分析如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">csvsql --query <span style="color:#e6db74">&#34;select avg(cnt) as expect1 from (select file, count(distinct feature) as cnt from &#39;data&#39; group by file)&#34;</span> data.csv

expect1
2.186088754189832

csvsql --query <span style="color:#e6db74">&#34;select avg(cnt) as expect1 from (select feature, count(distinct file) as cnt from &#39;data&#39; group by feature)&#34;</span> data.csv

expect1
1.0051170602511927
</code></pre></div><p>每个头像链接，重复下载 10 次的情况下，平均有生成 2.18 个特征。</p>
<p>每个特征，平均对应 1 个头像链接。在期望内，毕竟是密码学哈希算出的特征。</p>
<h3 id="perceptual-hashing">Perceptual hashing</h3>
<p>使用了<a href="https://github.com/JohannesBuchner/imagehash">这个库</a>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">python extract_feature_p.py

echo <span style="color:#e6db74">&#34;file,feature&#34;</span> &gt; header.csv
cat header.csv download_1.csv download_2.csv download_3.csv download_4.csv download_5.csv download_6.csv download_7.csv download_8.csv download_9.csv download_10.csv &gt; data.csv
</code></pre></div><p>两个指标分析如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">csvsql --query <span style="color:#e6db74">&#34;select avg(cnt) as expect1 from (select file, count(distinct feature) as cnt from &#39;data&#39; group by file)&#34;</span> data.csv

expect1
1.1413604158721875

csvsql --query <span style="color:#e6db74">&#34;select avg(cnt) as expect1 from (select feature, count(distinct file) as cnt from &#39;data&#39; group by feature)&#34;</span> data.csv

expect1
1.0312553837783924
</code></pre></div><p>每个头像链接，重复下载 10 次的情况下，平均有生成 1.1 个特征，效果很惊艳！</p>
<p>每个特征，平均对应 1.03 个头像链接。性能也很好了。</p>
<h4 id="详细分析">详细分析</h4>
<p>1 个头像链接对应不同特征数的区间分布：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">csvsql --query <span style="color:#e6db74">&#34;select cnt, count(1) from (select file, count(distinct feature) as cnt from &#39;data&#39; group by file) group by cnt order by cnt&#34;</span> data.csv &gt; dist1.csv
</code></pre></div><p><img src="../../images/image-20200611172502130.png" alt="image-20200611172502130"></p>
<p>重复下载 10 次的情况下，89%的头像链接都映射到了唯一值。</p>
<p>还有11%都是什么表现呢？大部分如图所示，只有部分位不同。可以理解，phash就是为了相似图搜索设计的。</p>
<p><img src="../../images/image-20200611174113623.png" alt="image-20200611174113623"></p>
<p>一个特征值对应不同头像链接的区间分布：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">csvsql --query <span style="color:#e6db74">&#34;select cnt, count(1) from (select feature, count(distinct file) as cnt from &#39;data&#39; group by feature) group by cnt order by cnt&#34;</span> data.csv &gt; dist2.csv
</code></pre></div><p><img src="../../images/image-20200611172438551.png" alt="image-20200611172438551"></p>
<p>98%的特征值对应一个头像链接。分析下剩余的2%的特征值，一个个处理。</p>
<p>使用如下脚本将相同特征值的图像放一块比较，参数为特征值。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./open_same_hash_images.sh ec9e1413e268c377
</code></pre></div><p>有两组图是比较异常的。如图169张图的特征值是一样的。共性是纯色。特征值也很奇怪 8000000000000000。</p>
<p><img src="../../images/image-20200611155105274.png" alt="image-20200611155105274"></p>
<p>如图46张图的特征值是一样的，共性是纯色。hash值也很奇怪 0000000000000000。</p>
<p><img src="../../images/image-20200611155003908.png" alt="image-20200611155003908"></p>
<p>其他hash值相同的图像文件，确实是相同的图像（肉眼看是一样的），如预期。</p>
<p><img src="../../images/image-20200611162618300.png" alt="image-20200611162618300"></p>
<p><img src="../../images/image-20200611162511234.png" alt="image-20200611162511234"></p>
<h4 id="todo">TODO</h4>
<ol>
<li>phash对不同纯色的图，生成的hash值是相同的。8000000000000000/0000000000000000这两个hash值很奇怪。</li>
<li>相似的图，生成的hash值可能不同的，2-3位的数字可能不同。查看原理。</li>
</ol>
<h2 id="总结">总结</h2>
<p>虽然对 phash 算法还是有点陌生，但是其效果基本满足了业务需求。至少比自己分析出的规则好很多。</p>

                    
                    <HR width="100%" id="EOF">
                    <p style="color:#777;">Last modified on 2020-06-11</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://xujiahua.github.io/posts/20200615-metabase-customer-isolation/">
                    Next<br>Metabase 客户隔离
                </a>
                
                
                
                <a class="older-posts" href="https://xujiahua.github.io/posts/20200609-metabase-sso-login/">
                    Previous<br>Metabase SSO 登录
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                






            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://amazingrise.net">Rise</a>
<br>
Ported from <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	2020 许嘉华的笔记
	</div>
    	</div>
    <script src="https://xujiahua.github.io//js/journal.js"></script>
    </body>
</html>
