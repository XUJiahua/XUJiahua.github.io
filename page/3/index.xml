<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>è®¸å˜‰åçš„ç¬”è®°</title>
    <link>https://xujiahua.github.io/</link>
    <description>Recent content on è®¸å˜‰åçš„ç¬”è®°</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Thu, 06 Aug 2020 09:49:47 +0800</lastBuildDate>
    
        <atom:link href="https://xujiahua.github.io/index.xml" rel="self" type="application/rss+xml" />
    
    
    
        <item>
        <title>æœºå™¨å­¦ä¹ åœ¨çº¿æ¨ç†éƒ¨ç½²æ–¹æ¡ˆï¼šCortex</title>
        <link>https://xujiahua.github.io/posts/20200416-cortex/</link>
        <pubDate>Thu, 16 Apr 2020 11:33:18 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200416-cortex/</guid>
        <description>è®¸å˜‰åçš„ç¬”è®° https://xujiahua.github.io/posts/20200416-cortex/ -&lt;h2 id=&#34;cortex-ä»‹ç»&#34;&gt;Cortex ä»‹ç»&lt;/h2&gt;
&lt;p&gt;å®˜æ–¹ç½‘ç«™ï¼šDeploy machine learning models in production &lt;a href=&#34;https://www.cortex.dev/&#34;&gt;https://www.cortex.dev/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;GitHub &lt;a href=&#34;https://github.com/cortexlabs/cortex&#34;&gt;https://github.com/cortexlabs/cortex&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The CLI sends configuration and code to the cluster every time you run &lt;code&gt;cortex deploy&lt;/code&gt;. Each model is loaded into a Docker container, along with any Python packages and request handling code. The model is exposed as a web service using Elastic Load Balancing (ELB), TensorFlow Serving, and ONNX Runtime. The containers are orchestrated on Elastic Kubernetes Service (EKS) while logs and metrics are streamed to CloudWatch.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;CLIå·¥å…·å°†é…ç½®æ–‡ä»¶å’Œä»£ç æ¨é€åˆ°é›†ç¾¤ã€‚æ¨¡å‹è¿åŒPythonä¾èµ–åŒ…å’Œè¯·æ±‚å¤„ç†çš„ä»£ç è¢«Dockerå®¹å™¨æ‰“åŒ…ã€‚ä½¿ç”¨AWS ELBç­‰æš´éœ²å‡ºWebæœåŠ¡ã€‚å®¹å™¨ä½¿ç”¨AWS EKSç¼–æ’ï¼Œæ—¥å¿—å’ŒæŒ‡æ ‡ä¼šæ¨é€åˆ°AWS CloudWatchã€‚&lt;/p&gt;
&lt;h3 id=&#34;key-features&#34;&gt;Key Features&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Multi framework:&lt;/strong&gt; Cortex supports TensorFlow, PyTorch, scikit-learn, XGBoost, and more. æ”¯æŒä¸»æµçš„æœºå™¨å­¦ä¹ ã€æ·±åº¦å­¦ä¹ æ¡†æ¶&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Autoscaling:&lt;/strong&gt; Cortex automatically scales APIs to handle production workloads. ä¾èµ–k8sçš„èƒ½åŠ›ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;CPU / GPU support:&lt;/strong&gt; Cortex can run inference on CPU or GPU infrastructure. CPU/GPUéƒ½æ”¯æŒã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Spot instances:&lt;/strong&gt; Cortex supports EC2 spot instances.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Rolling updates:&lt;/strong&gt; Cortex updates deployed APIs without any downtime. ä¾èµ–k8sçš„èƒ½åŠ›ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Log streaming:&lt;/strong&gt; Cortex streams logs from deployed models to your CLI. ä¾èµ–CloudWatchçš„èƒ½åŠ›ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Prediction monitoring:&lt;/strong&gt; Cortex monitors network metrics and tracks predictions.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Minimal configuration:&lt;/strong&gt; Cortex deployments are defined in a single &lt;code&gt;cortex.yaml&lt;/code&gt; file.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;æˆ‘çš„ä½“éªŒ&#34;&gt;æˆ‘çš„ä½“éªŒ&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;ä¸AWSæ·±åº¦ç»‘å®šã€‚å¯¹ç§æœ‰äº‘ã€å›½å†…å…¬æœ‰äº‘ä¸å¤Ÿå‹å¥½äº†ã€‚&lt;/li&gt;
&lt;li&gt;ä¾èµ–KubernetesæœåŠ¡ã€‚&lt;/li&gt;
&lt;li&gt;ä¾èµ–äº‘å­˜å‚¨æœåŠ¡ï¼Œæ¯”å¦‚S3ã€OSSã€‚cortex deployçš„å»ºè®®ï¼šcortex will zip files and upload them to the cluster; we recommend that you upload large files/directories (e.g. models) to s3 and download them in your api&amp;rsquo;s &lt;strong&gt;init&lt;/strong&gt; function,&lt;/li&gt;
&lt;li&gt;æœ‰ä¸€å¥—Python APIæœåŠ¡çš„æ¨¡æ¿ï¼Œå¹¶ä½¿ç”¨Dockerå°è£…ã€‚æ¯”å¦‚ &lt;a href=&#34;https://github.com/cortexlabs/cortex/blob/master/images/python-serve/Dockerfile&#34;&gt;https://github.com/cortexlabs/cortex/blob/master/images/python-serve/Dockerfile&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;æ¨ç†Predictorç±»æŒ‰ç…§Cortexå®šä¹‰çš„æ¥å£è§„èŒƒå®ç°ï¼Œæ‰€åœ¨ç›®å½•æŒ‚è½½åˆ° /mnt/project ç›®å½•ã€‚&lt;/li&gt;
&lt;li&gt;å¯åŠ¨å®¹å™¨ï¼Œé¢„ç½®è„šæœ¬ä¼šå®‰è£…&lt;code&gt;requirement.txt&lt;/code&gt;ï¼Œå¹¶åŠ¨æ€åŠ è½½Predictorç±»ã€‚&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨è€…åªéœ€è¦å¤„ç†æ¨¡å‹è®­ç»ƒå’ŒæŒ‰ç…§è§„èŒƒå®šä¹‰Predictorç±»ã€‚é‡å¤çš„APIå®šä¹‰ã€éƒ¨ç½²ã€æ‰©å®¹ï¼Œéƒ½å·²ç»è¢«éšè—æ‰äº†ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;ä»£ç ç»“æ„&#34;&gt;ä»£ç ç»“æ„&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;cli ç›®å½•ï¼šå®¢æˆ·ç«¯ã€‚deployæ“ä½œï¼Œå°±æ˜¯æŠŠæœ¬åœ°çš„é…ç½®æ–‡ä»¶å‹ç¼©æˆzipåŒ…ä¸Šä¼ ã€‚&lt;/li&gt;
&lt;li&gt;pkg/operator ç›®å½•ï¼šæœåŠ¡ç«¯ã€‚deployæ¥å£åœ¨æ­¤ï¼šzipåŒ…ä¼šä¸Šä¼ åˆ°S3ï¼Œç¼–ç¨‹çš„æ–¹å¼ç”³è¯·k8sèµ„æºï¼ˆdeployment, service, virtualServiceï¼‰ï¼Œç›´æ¥å‘k8s API serverå‘é€è¯·æ±‚ã€‚&lt;/li&gt;
&lt;li&gt;pkg/lib ç›®å½•ï¼šæ¯”è¾ƒæ ¸å¿ƒçš„Goä»£ç ã€‚&lt;/li&gt;
&lt;li&gt;pkg/workloads/cortex/downloader ç›®å½•ï¼šåœ¨k8sä¸­ä½œä¸ºInitContainerï¼Œç”¨äºä¸‹è½½é…ç½®æ–‡ä»¶åˆ°Podä¸­ã€‚&lt;/li&gt;
&lt;li&gt;pkg/workloads ç›®å½•ï¼šæ¨ç†æœåŠ¡çš„ä»£ç ï¼Œæ¯”è¾ƒé€šç”¨ã€‚pkg/workloads/cortex/serve/run.sh ç•™äº†ä¸ªå£å­ &lt;code&gt;/mnt/project&lt;/code&gt;ï¼Œæ¯ä¸ªæœåŠ¡ä¸ªæ€§åŒ–çš„éƒ¨åˆ†ç•™ç»™å¼€å‘è€…ï¼ˆéµä»è§„èŒƒï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;images ç›®å½•ï¼šé•œåƒæ–‡ä»¶ã€‚åŒ…æ‹¬ operator çš„é•œåƒæ–‡ä»¶ï¼Œä¹ŸåŒ…æ‹¬æ¨ç†æœåŠ¡çš„ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å…·ä½“çœ‹çœ‹åˆ›å»ºæ¨ç†æœåŠ¡å®¹å™¨çš„è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;ç”³è¯· K8s Deploymentã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200416151230669.png&#34; alt=&#34;image-20200416151230669&#34;&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œåˆ†ä¸ºä¸‰å¤§ç±»ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200416151318515.png&#34; alt=&#34;image-20200416151318515&#34;&gt;&lt;/p&gt;
&lt;p&gt;å…³æ³¨PythonPredictorTypeã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200416151537448.png&#34; alt=&#34;image-20200416151537448&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¼ å…¥ InitContainer ï¼ˆä»£ç è§ pkg/workloads/cortex/downloaderï¼‰çš„å‚æ•°å¦‚ä¸‹ï¼Œå°†S3ä¸Šå­˜å‚¨çš„é…ç½®ä¿¡æ¯å’Œpredictoræ–‡ä»¶ç­‰ä¸‹è½½åˆ°Podä¸­çš„ &lt;code&gt;/mnt/project&lt;/code&gt;ç›®å½•ï¼ˆ&lt;code&gt;_emptyDirMountPath = &amp;quot;/mnt&amp;quot;&lt;/code&gt;ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200416152324873.png&#34; alt=&#34;image-20200416152324873&#34;&gt;&lt;/p&gt;
&lt;p&gt;å› ä¸ºPodå†…å®¹å™¨å…±äº«å­˜å‚¨ç©ºé—´ï¼Œè¿™æ ·æ¨ç†æœåŠ¡å®¹å™¨å°±èƒ½è¯»å–åˆ° &lt;code&gt;/mnt/project&lt;/code&gt;äº†ã€‚&lt;/p&gt;
&lt;h2 id=&#34;cortex-é•œåƒä½“éªŒ&#34;&gt;cortex é•œåƒä½“éªŒ&lt;/h2&gt;
&lt;p&gt;ä¸‹è½½åœ°å€ &lt;a href=&#34;https://hub.docker.com/r/cortexlabs/python-serve/tags&#34;&gt;https://hub.docker.com/r/cortexlabs/python-serve/tags&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å®¹å™¨å†…ä»£ç ä¹Ÿæ˜¯ä¾èµ–S3çš„ï¼Œä¸ä¿®æ”¹è¿˜ä¸èƒ½ç›´æ¥ä½¿ç”¨ğŸ¤£ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200416161622829.png&#34; alt=&#34;image-20200416161622829&#34;&gt;&lt;/p&gt;
&lt;p&gt;åˆ°æ­¤ä¸ºæ­¢å§ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;docker run -e CORTEX_SERVING_PORT&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;5000&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_WORKERS_PER_REPLICA&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_MAX_WORKER_CONCURRENCY&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;8&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_THREADS_PER_WORKER&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_SO_MAX_CONN&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2048&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_CACHE_DIR&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;/mnt/spec &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -e CORTEX_VERSION&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;0.15.1 &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -v &lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;pwd&lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;:/mnt/project &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -v &lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;pwd&lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;:/mnt/spec &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;        -p 5000:5000 cortexlabs/python-serve:0.15.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;- https://xujiahua.github.io/posts/20200416-cortex/ - </description>
        </item>
    
    
    
        <item>
        <title>k8s åº”ç”¨æ—¥å¿—æ”¶é›†</title>
        <link>https://xujiahua.github.io/posts/20200414-k8s-logging/</link>
        <pubDate>Tue, 14 Apr 2020 09:53:35 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200414-k8s-logging/</guid>
        <description>è®¸å˜‰åçš„ç¬”è®° https://xujiahua.github.io/posts/20200414-k8s-logging/ -&lt;h2 id=&#34;k8s-æ—¥å¿—æ”¶é›†æ¶æ„&#34;&gt;k8s æ—¥å¿—æ”¶é›†æ¶æ„&lt;/h2&gt;
&lt;p&gt;ä»¥ä¸‹æ˜¯æ¯”è¾ƒä¸€èˆ¬ã€æ™®é€‚çš„æ¶æ„ã€‚æ›´å¤šå‚è€ƒï¼šKubernetes æ—¥å¿—æ¶æ„ &lt;a href=&#34;https://kubernetes.io/zh/docs/concepts/cluster-administration/logging/&#34;&gt;https://kubernetes.io/zh/docs/concepts/cluster-administration/logging/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/logging-with-node-agent.png&#34; alt=&#34;ä½¿ç”¨èŠ‚ç‚¹æ—¥å¿—è®°å½•ä»£ç†&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å®¹å™¨åŒ–åº”ç”¨å°†æ—¥å¿—å†™å…¥&lt;code&gt;stdout&lt;/code&gt;ã€&lt;code&gt;stderr&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;Dockerå®¹å™¨å¼•æ“å°†&lt;code&gt;stdout&lt;/code&gt;ã€&lt;code&gt;stderr&lt;/code&gt;æµé‡å®šå‘åˆ°æ—¥å¿—é©±åŠ¨ï¼Œæ¯”å¦‚é»˜è®¤çš„json-fileã€‚&lt;/li&gt;
&lt;li&gt;json-fileæ—¥å¿—é©±åŠ¨å°†æ—¥å¿—å†™å…¥åˆ°ï¼ˆå®¿ä¸»æœºä¸Šçš„ï¼‰æ–‡ä»¶ã€‚&lt;/li&gt;
&lt;li&gt;æ—¥å¿—æ”¶é›†å·¥å…·ä»¥DaemonSetçš„å½¢å¼å®‰è£…åœ¨æ¯ä¸ªèŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;æ—¥å¿—æ”¶é›†å·¥å…·ç›‘å¬æ–‡ä»¶å˜åŒ–ï¼Œå¹¶å°†æ—¥å¿—å†™å…¥åˆ°æ—¥å¿—ä¸­å¿ƒæœåŠ¡ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;k8s-æ—¥å¿—æ”¶é›†ç»†èŠ‚&#34;&gt;k8s æ—¥å¿—æ”¶é›†ç»†èŠ‚&lt;/h2&gt;
&lt;h3 id=&#34;å®æˆ˜&#34;&gt;å®æˆ˜&lt;/h3&gt;
&lt;p&gt;å¯ä»¥ç›´æ¥å‚è€ƒä»¥ä¸‹æ•™ç¨‹ï¼šminikubeåˆ›å»ºäº†ä¸€ä¸ªKubernetesé›†ç¾¤ï¼ŒFluentdæ”¶é›†æ—¥å¿—ï¼Œå­˜å…¥ElasticSearchï¼Œä½¿ç”¨KibanaæŸ¥çœ‹æ—¥å¿—ã€‚å…¸å‹çš„EFKæŠ€æœ¯æ ˆã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Logging in Kubernetes with Elasticsearch, Kibana, and Fluentd &lt;a href=&#34;https://mherman.org/blog/logging-in-kubernetes-with-elasticsearch-Kibana-fluentd/&#34;&gt;https://mherman.org/blog/logging-in-kubernetes-with-elasticsearch-Kibana-fluentd/&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;åœ¨Kibanaä¸Šçœ‹æ”¶é›†åˆ°çš„æ—¥å¿—ã€‚èƒ½çœ‹åˆ°æ—¥å¿—æ”¶é›†å·¥å…·ä¹Ÿé‡‡é›†äº†å®¹å™¨ã€é•œåƒã€Podæœ‰å…³çš„ä¿¡æ¯ã€‚è¿™äº›ä¸Šä¸‹æ–‡ä¿¡æ¯èƒ½è®©äººå®šä½åˆ°æ˜¯å“ªä¸ªåº”ç”¨åœ¨ç”Ÿäº§æ—¥å¿—ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200414104511399.png&#34; alt=&#34;image-20200414104511399&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;fluentd-æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯&#34;&gt;fluentd æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯&lt;/h3&gt;
&lt;p&gt;Docker &lt;code&gt;json-file&lt;/code&gt; æ—¥å¿—é©±åŠ¨å†™æ–‡ä»¶ï¼Œå¹¶ä¸è®°å½•ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ &lt;a href=&#34;https://docs.docker.com/config/containers/logging/json-file/&#34;&gt;https://docs.docker.com/config/containers/logging/json-file/&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{&amp;quot;log&amp;quot;:&amp;quot;Log line is here\n&amp;quot;,&amp;quot;stream&amp;quot;:&amp;quot;stdout&amp;quot;,&amp;quot;time&amp;quot;:&amp;quot;2019-01-01T11:11:11.111111111Z&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ä¸Šæ–‡ä¸­ä½¿ç”¨çš„æ—¥å¿—æ”¶é›†é•œåƒæ˜¯ &lt;code&gt;fluent/fluentd-kubernetes-daemonset:v1.3-debian-elasticsearch&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“ä»£ç è·¯å¾„åœ¨æ­¤ &lt;a href=&#34;https://github.com/fluent/fluentd-kubernetes-daemonset/tree/master/docker-image/v1.3/debian-elasticsearch&#34;&gt;https://github.com/fluent/fluentd-kubernetes-daemonset/tree/master/docker-image/v1.3/debian-elasticsearch&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ”¶é›†å®¹å™¨ç›®å½•ä¸‹çš„æ—¥å¿—ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200414105706563.png&#34; alt=&#34;image-20200414105706563&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨&lt;code&gt;kubernetes_metadata&lt;/code&gt;è¿™ä¸ªç¬¬ä¸‰æ–¹æ’ä»¶è·å–å®¹å™¨ç›¸å…³çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚è¿™é‡Œæ˜¯é€šè¿‡è¯·æ±‚API serverå¾—åˆ°metadataçš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200414105752287.png&#34; alt=&#34;image-20200414105752287&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;kubernetes_metadata&lt;/code&gt; æ’ä»¶åœ°å€ &lt;a href=&#34;https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter&#34;&gt;https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ’ä»¶ä¸­æœ‰ç¼“å­˜metadataçš„é€‰é¡¹ï¼Œä¸ç”¨æ‹…å¿ƒæ¯å¤„ç†ä¸€æ¡æ—¥å¿—ï¼Œå°±è¦å‘API serverå‘é€è¯·æ±‚ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200414111028867.png&#34; alt=&#34;image-20200414111028867&#34;&gt;&lt;/p&gt;
- https://xujiahua.github.io/posts/20200414-k8s-logging/ - </description>
        </item>
    
    
    
        <item>
        <title>Metabase &#43; Spark SQL</title>
        <link>https://xujiahua.github.io/posts/20200410-metabase-spark-sql/</link>
        <pubDate>Fri, 10 Apr 2020 16:41:53 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200410-metabase-spark-sql/</guid>
        <description>è®¸å˜‰åçš„ç¬”è®° https://xujiahua.github.io/posts/20200410-metabase-spark-sql/ -&lt;p&gt;è¿™æ˜¯å¤§æ•°æ® BI å¹³å°çš„ç¬¬äºŒæ­¥ï¼ŒBI å·¥å…·çš„æ­å»ºã€‚å‡è®¾å·²ç»é…ç½®å¥½ Spark SQL JDBC Serverï¼Œå¹¶å¯ç”¨äº†Kerberosã€‚å‚è€ƒ  &lt;a href=&#34;https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/&#34;&gt;https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œï¼Œæˆ‘ä»¬é€‰æ‹©äº†å¼€æºäº§å“ Metabaseã€‚&lt;/p&gt;
&lt;p&gt;æœ€ç»ˆï¼Œå¤§æ•°æ® BI å¹³å°ï¼Œæ˜¯ç”± 1) ä»¥Metabaseä½œä¸ºBIå¯è§†åŒ–ï¼Œ2) ç”±HDFSï¼ˆåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨ï¼‰ + parquetï¼ˆåˆ—å¼æ•°æ®å­˜å‚¨æ ¼å¼ï¼‰+ Hive metastoreï¼ˆSQLè¡¨ç»“æ„ä¿¡æ¯ç»´æŠ¤ï¼‰ + Spark SQLï¼ˆæ‰¹å¤„ç†å¼•æ“ï¼‰ç»„åˆçš„OLAPæ•°æ®åº“ç»„æˆã€‚&lt;/p&gt;
&lt;h2 id=&#34;metabase-ç®€ä»‹&#34;&gt;Metabase ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;Metabase is the easy, open source way for everyone in your company to ask questions and learn from data.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.metabase.com/&#34;&gt;https://www.metabase.com/&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ•°æ®åº“æ”¯æŒ&#34;&gt;æ•°æ®åº“æ”¯æŒ&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;BigQuery&lt;/li&gt;
&lt;li&gt;Druid&lt;/li&gt;
&lt;li&gt;Google Analytics&lt;/li&gt;
&lt;li&gt;H2&lt;/li&gt;
&lt;li&gt;MongoDB&lt;/li&gt;
&lt;li&gt;MySQL/MariaDB&lt;/li&gt;
&lt;li&gt;PostgreSQL&lt;/li&gt;
&lt;li&gt;Presto&lt;/li&gt;
&lt;li&gt;Amazon Redshift&lt;/li&gt;
&lt;li&gt;Snowflake&lt;/li&gt;
&lt;li&gt;Spark SQL&lt;/li&gt;
&lt;li&gt;SQLite&lt;/li&gt;
&lt;li&gt;SQL Server&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a href=&#34;https://www.metabase.com/docs/latest/faq/setup/which-databases-does-metabase-support.html&#34;&gt;https://www.metabase.com/docs/latest/faq/setup/which-databases-does-metabase-support.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è¿™é‡Œæœ‰æˆ‘ä»¬éœ€è¦çš„Spark SQLï¼Œæˆ‘ä»¬çš„å¤§æ•°æ®é›†ç¾¤å¯ä»¥æ”¯æŒã€‚æ¯”è¾ƒé—æ†¾çš„æ˜¯æ²¡æœ‰Impalaã€‚&lt;/p&gt;
&lt;h2 id=&#34;metabase-å®‰è£…&#34;&gt;Metabase å®‰è£…&lt;/h2&gt;
&lt;h3 id=&#34;mysql&#34;&gt;MySQL&lt;/h3&gt;
&lt;p&gt;ä½¿ç”¨MySQLä½œä¸ºå…ƒæ•°æ®å­˜å‚¨ã€‚å¤ç”¨ä¹‹å‰CDHçš„MySQLå®ä¾‹ã€‚&lt;/p&gt;
&lt;p&gt;åˆ›å»ºæ•°æ®åº“ã€ç”¨æˆ·ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-SQL&#34; data-lang=&#34;SQL&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;-- é€‚åˆMySQL5.7åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œæ”¯æŒæ›´å¤§çš„max key lengthã€‚ä¸€ä¸ªå­—ç¬¦ä½¿ç”¨å››ä¸ªå­—èŠ‚ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;CREATE&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;DATABASE&lt;/span&gt; metabase CHARACTER &lt;span style=&#34;color:#66d9ef&#34;&gt;SET&lt;/span&gt; utf8mb4 &lt;span style=&#34;color:#66d9ef&#34;&gt;COLLATE&lt;/span&gt; utf8mb4_unicode_ci;
&lt;span style=&#34;color:#75715e&#34;&gt;-- é€‚åˆMySQL5.6åŠä»¥ä¸‹ç‰ˆæœ¬ã€‚ä¸€ä¸ªå­—ç¬¦ä½¿ç”¨3ä¸ªå­—èŠ‚ã€‚
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;CREATE&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;DATABASE&lt;/span&gt; metabase CHARACTER &lt;span style=&#34;color:#66d9ef&#34;&gt;SET&lt;/span&gt; utf8 &lt;span style=&#34;color:#66d9ef&#34;&gt;COLLATE&lt;/span&gt; utf8_unicode_ci;

&lt;span style=&#34;color:#75715e&#34;&gt;-- % è¡¨ç¤ºä¸é™åˆ¶host
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;CREATE&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;USER&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;metabase&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;@&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;%&amp;#39;&lt;/span&gt; IDENTIFIED &lt;span style=&#34;color:#66d9ef&#34;&gt;BY&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;metabase&amp;#39;&lt;/span&gt;;
&lt;span style=&#34;color:#66d9ef&#34;&gt;GRANT&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ALL&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;ON&lt;/span&gt; metabase.&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;TO&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;metabase&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;@&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;%&amp;#39;&lt;/span&gt;;

FLUSH &lt;span style=&#34;color:#66d9ef&#34;&gt;PRIVILEGES&lt;/span&gt;;
&lt;span style=&#34;color:#75715e&#34;&gt;-- https://dev.mysql.com/doc/refman/5.7/en/grant.html
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;å¸¸è§é—®é¢˜&#34;&gt;å¸¸è§é—®é¢˜&lt;/h4&gt;
&lt;p&gt;mysql 5.7ä¸5.6çš„åŒºåˆ«ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;767 bytes is the &lt;a href=&#34;http://dev.mysql.com/doc/refman/5.1/en/create-index.html&#34;&gt;stated prefix limitation&lt;/a&gt; for InnoDB tables in MySQL version 5.6 (and prior versions). It&amp;rsquo;s 1,000 bytes long for MyISAM tables. In MySQL version 5.7 and upwards this limit has been increased to 3072 bytes.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Caused by: java.sql.SQLException: Specified key was too long; max key length is 767 bytes&lt;/p&gt;
&lt;p&gt;Caused by: liquibase.exception.DatabaseException: (conn=175553) Specified key was too long; max key length is 767 bytes [Failed SQL: CREATE TABLE &lt;code&gt;metabase&lt;/code&gt;.&lt;code&gt;core_organization&lt;/code&gt; (&lt;code&gt;id&lt;/code&gt; INT AUTO_INCREMENT NOT NULL, &lt;code&gt;slug&lt;/code&gt; VARCHAR(254) NOT NULL, &lt;code&gt;name&lt;/code&gt; VARCHAR(254) NOT NULL, &lt;code&gt;description&lt;/code&gt; TEXT NULL, &lt;code&gt;logo_url&lt;/code&gt; VARCHAR(254) NULL, &lt;code&gt;inherits&lt;/code&gt; BIT(1) NOT NULL, CONSTRAINT &lt;code&gt;PK_CORE_ORGANIZATION&lt;/code&gt; PRIMARY KEY (&lt;code&gt;id&lt;/code&gt;), UNIQUE (&lt;code&gt;slug&lt;/code&gt;))]&lt;/p&gt;
&lt;h3 id=&#34;metabase&#34;&gt;Metabase&lt;/h3&gt;
&lt;p&gt;ä¸‹è½½metabaseã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# ä»¥ /opt/metabase ä¸ºå·¥ä½œç›®å½•&lt;/span&gt;
mkdir /opt/metabase &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; cd /opt/metabase
&lt;span style=&#34;color:#75715e&#34;&gt;# ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„metabaseï¼Œå‚è€ƒ https://www.metabase.com/start/jar.html&lt;/span&gt;
wget https://downloads.metabase.com/v0.35.1/metabase.jar
&lt;span style=&#34;color:#75715e&#34;&gt;# åˆ›å»ºæ’ä»¶ç›®å½•&lt;/span&gt; 
mkdir plugins
&lt;span style=&#34;color:#75715e&#34;&gt;# Spark SQLçš„é©±åŠ¨ï¼ŒjaråŒ…å†…ç½®çš„æœ‰é—®é¢˜&lt;/span&gt;
wget https://s3.amazonaws.com/sparksql-deps/metabase-sparksql-deps-1.2.1.spark2-standalone.jar -O plugins/metabase-sparksql-deps-1.2.1.spark2-standalone.jar
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å¯åŠ¨è„šæœ¬ start.shã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#!/usr/bin/bash
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
export MB_DB_TYPE&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;mysql
export MB_DB_DBNAME&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;metabase
export MB_DB_PORT&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;3306&lt;/span&gt;
export MB_DB_USER&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;metabase
export MB_DB_PASS&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;metabase
export MB_DB_HOST&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;172.31.0.100

kinit -kt hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003@PEGGY.LING

mkdir -p logs

nohup java -Djavax.security.auth.useSubjectCredsOnly&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;false -jar metabase.jar  &amp;gt;&amp;gt; logs/metabase.log 2&amp;gt;&amp;amp;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &amp;amp;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœæ­¢è„šæœ¬ stop.shã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#!/usr/bin/bash
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
ps -ef | grep &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;metabase.jar&amp;#39;&lt;/span&gt; | grep -v &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;grep&amp;#39;&lt;/span&gt; | awk &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;{print $2}&amp;#39;&lt;/span&gt; | xargs kill -9

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;webapp@xh-hd2-peggy-dost000003 metabase&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;$ tree
â”œâ”€â”€ hive.xh-hd2-peggy-dost000003.keytab
â”œâ”€â”€ logs
â”‚Â Â  â””â”€â”€ metabase.log
â”œâ”€â”€ metabase.jar
â”œâ”€â”€ plugins
â”‚Â Â  â”œâ”€â”€ metabase-sparksql-deps-1.2.1.spark2-standalone.jar
â”‚Â Â  â”œâ”€â”€ sparksql.metabase-driver.jar
â”‚Â Â  â”œâ”€â”€ ...
â”œâ”€â”€ start.sh
â””â”€â”€ stop.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Metabaseæ­å»ºæ‰‹å†Œï¼šä½¿ç”¨SparkSQLè¿æ¥Hive &lt;a href=&#34;https://webcache.googleusercontent.com/search?q=cache:DcmHXWOc9woJ:https://immm.in/archives/24.html+&amp;amp;cd=5&amp;amp;hl=zh-CN&amp;amp;ct=clnk&amp;amp;gl=hk&#34;&gt;https://webcache.googleusercontent.com/search?q=cache:DcmHXWOc9woJ:https://immm.in/archives/24.html+&amp;amp;cd=5&amp;amp;hl=zh-CN&amp;amp;ct=clnk&amp;amp;gl=hk&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;é…ç½®-spark-sql-è¿æ¥&#34;&gt;é…ç½® Spark SQL è¿æ¥&lt;/h4&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200410180255501.png&#34; alt=&#34;image-20200410180255501&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¿å­˜æ²¡æœ‰æŠ¥é”™ï¼Œå°±æ˜¯æˆåŠŸäº†ã€‚&lt;/p&gt;
&lt;h4 id=&#34;å¸¸è§é—®é¢˜-1&#34;&gt;å¸¸è§é—®é¢˜&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;ä½¿ç”¨å†…ç½®çš„é©±åŠ¨æŠ¥é”™ï¼šUnrecognized Hadoop major version number: 3.1.1&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨metabase-sparksql-deps-1.2.1.spark2-standalone.jarè¿™ä¸ªé©±åŠ¨æŠ¥é”™ï¼Œç„¶è€Œbeelineè¿æ¥æ˜¯æ²¡é—®é¢˜çš„ï¼š transport.TSaslTransport :: SASL negotiation failure
javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæš‚æ—¶å¿½ç•¥ï¼Œä½¿ç”¨å…¶ä»–é©±åŠ¨ã€‚&lt;/p&gt;
&lt;p&gt;æŒ‰ç†è¯´ï¼Œhttps://github.com/metabase/sparksql-deps å·²ç»åˆå¹¶åˆ° &lt;a href=&#34;https://github.com/metabase/metabase/tree/v0.35.1/modules/drivers/sparksql&#34;&gt;https://github.com/metabase/metabase/tree/v0.35.1/modules/drivers/sparksql&lt;/a&gt; äº†ã€‚å†…ç½®é©±åŠ¨å°±èƒ½ç”¨æ‰å¯¹ã€‚&lt;/p&gt;
&lt;p&gt;èƒ½çœ‹åˆ°ä¾èµ–hadoop-commonåŒ…çš„ç‰ˆæœ¬å·®å¼‚ã€‚TODO: è¿˜å¾—ç»†çœ‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200411071918161.png&#34; alt=&#34;image-20200411071918161&#34;&gt;&lt;/p&gt;
&lt;p&gt;ä¾èµ–çš„hadoopç‰ˆæœ¬æ˜¯3.1.0ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200411072135265.png&#34; alt=&#34;image-20200411072135265&#34;&gt;&lt;/p&gt;
&lt;p&gt;å†…ç½®Driverä¾èµ–3.1.1ã€‚æŠ¥é”™ä¿¡æ¯ä¹Ÿæ˜¯åŒ…å«3.1.1ï¼Œæ˜¯å¦åˆ‡åˆ°3.1.0ï¼Œé‡æ–°æ‰“åŒ…å°±å¯ä»¥äº†ï¼Ÿ&lt;/p&gt;
&lt;p&gt;ç¬¬äºŒä¸ªé—®é¢˜éœ€è¦è®¾ç½®Javaå‚æ•° &lt;code&gt;-Djavax.security.auth.useSubjectCredsOnly=false&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;é€šè¿‡åº•å±‚æœºåˆ¶è·å–å‡­è¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¯é€šè¿‡åº”ç”¨æ‰§è¡Œè®¤è¯æ“ä½œã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200410173734177.png&#34; alt=&#34;image-20200410173734177&#34;&gt;&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;How to connnect sparksql in Kerberos enviroment &lt;a href=&#34;https://discourse.metabase.com/t/how-to-connnect-sparksql-in-kerberos-enviroment/8290/2&#34;&gt;https://discourse.metabase.com/t/how-to-connnect-sparksql-in-kerberos-enviroment/8290/2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided https://stackoverflow.com/questions/32205087/javax-security-sasl-saslexception-gss-initiate-failed-caused-by-gssexception&lt;/li&gt;
&lt;li&gt;Below are listed some problems that may occur when attempting a login, and suggestions for solving them. &lt;a href=&#34;https://docs.oracle.com/javase/7/docs/technotes/guides/security/jgss/tutorials/Troubleshooting.html&#34;&gt;https://docs.oracle.com/javase/7/docs/technotes/guides/security/jgss/tutorials/Troubleshooting.html&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;ä¸-superset-æ¯”è¾ƒ&#34;&gt;ä¸ Superset æ¯”è¾ƒ&lt;/h2&gt;
&lt;p&gt;Supersetæ˜¯å¦å¤–ä¸€ä¸ªå¼€æºçš„BIå·¥å…·ã€‚ä½†æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­ä½“éªŒä¸ä½³ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸æ”¯æŒå¤šè¡¨JOINã€‚è¿™ä¸ªä¸èƒ½å¿ã€‚&lt;/li&gt;
&lt;li&gt;ç›´æ¥å†™SQLï¼Œæ•°æ®æ²¡æ³•å¯è§†åŒ–ã€‚æ•ˆç‡æœ‰ç‚¹ä½ä¸‹ã€‚&lt;/li&gt;
&lt;li&gt;å¤–è§‚ä¸‘é™‹ã€‚FlaskAppbuilderç”Ÿæˆçš„å‰åç«¯æ¶å­ã€‚&lt;/li&gt;
&lt;li&gt;Tableæºå¦‚æœæ”¹äº†ï¼Œå»ºè®®åˆ æ‰å†æ·»åŠ ï¼Œä¸ç„¶ä¼šæœ‰å„ç§æ„å¤–ã€‚&lt;/li&gt;
&lt;li&gt;äº¤äº’ä½“éªŒå·®ã€‚è‡ªå®šä¹‰SELECT COUNT(cookie) as pvï¼Œæ­»æ´»æä¸å®šã€‚æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼æ˜¯è®¾ç½®labelï¼Œä½“éªŒä¸ç›´è§‚ã€‚&lt;/li&gt;
&lt;li&gt;å°bugå¤šã€‚ç”¨èµ·æ¥å¤ªå®¹æ˜“çƒ¦èºäº†ã€‚å¯¹èº«å¿ƒå¥åº·ä¸å¥½ã€‚&lt;/li&gt;
&lt;/ol&gt;
- https://xujiahua.github.io/posts/20200410-metabase-spark-sql/ - </description>
        </item>
    
    
    
        <item>
        <title>CDH6 å¯ç”¨ Spark Thrift Server</title>
        <link>https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/</link>
        <pubDate>Fri, 10 Apr 2020 10:07:16 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/</guid>
        <description>è®¸å˜‰åçš„ç¬”è®° https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/ -&lt;p&gt;å¾ˆé—æ†¾ï¼ŒCDHç‰ˆæœ¬çš„Sparké˜‰å‰²äº†Thrift Serverã€‚ï¼ˆå¯èƒ½ä¸è‡ªå®¶äº§å“Impalaæœ‰ç«äº‰å…³ç³»çš„åŸå› ã€‚ï¼‰&lt;/p&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/spark.html#spark__d99299e107&#34;&gt;https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/spark.html#spark__d99299e107&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ll /opt/cloudera/parcels/CDH/lib/spark/sbin/
total 84
-rwxr-xr-x 1 root root 2803 Nov  9 00:05 slaves.sh
-rwxr-xr-x 1 root root 1429 Nov  9 00:05 spark-config.sh
-rwxr-xr-x 1 root root 5689 Nov  9 00:05 spark-daemon.sh
-rwxr-xr-x 1 root root 1262 Nov  9 00:05 spark-daemons.sh
-rwxr-xr-x 1 root root 1190 Nov  9 00:05 start-all.sh
-rwxr-xr-x 1 root root 1274 Nov  9 00:05 start-history-server.sh
-rwxr-xr-x 1 root root 2050 Nov  9 00:05 start-master.sh
-rwxr-xr-x 1 root root 1877 Nov  9 00:05 start-mesos-dispatcher.sh
-rwxr-xr-x 1 root root 1423 Nov  9 00:05 start-mesos-shuffle-service.sh
-rwxr-xr-x 1 root root 1279 Nov  9 00:05 start-shuffle-service.sh
-rwxr-xr-x 1 root root 3151 Nov  9 00:05 start-slave.sh
-rwxr-xr-x 1 root root 1527 Nov  9 00:05 start-slaves.sh
-rwxr-xr-x 1 root root 1478 Nov  9 00:05 stop-all.sh
-rwxr-xr-x 1 root root 1056 Nov  9 00:05 stop-history-server.sh
-rwxr-xr-x 1 root root 1080 Nov  9 00:05 stop-master.sh
-rwxr-xr-x 1 root root 1227 Nov  9 00:05 stop-mesos-dispatcher.sh
-rwxr-xr-x 1 root root 1084 Nov  9 00:05 stop-mesos-shuffle-service.sh
-rwxr-xr-x 1 root root 1067 Nov  9 00:05 stop-shuffle-service.sh
-rwxr-xr-x 1 root root 1557 Nov  9 00:05 stop-slave.sh
-rwxr-xr-x 1 root root 1064 Nov  9 00:05 stop-slaves.sh
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¯è§ï¼Œæ²¡æœ‰Thrift Serverçš„å¯åŠ¨è„šæœ¬ã€‚&lt;/p&gt;
&lt;p&gt;å€Ÿé‰´ç½‘ä¸Šèµ„æ–™ï¼ˆCDH 6æˆåŠŸå¯åŠ¨spark-thriftæœåŠ¡ &lt;a href=&#34;https://blog.csdn.net/qq_34864753/article/details/102729859&#34;&gt;https://blog.csdn.net/qq_34864753/article/details/102729859&lt;/a&gt;ï¼‰ï¼Œåœ¨ä¸ä¿®æ”¹CDH Sparkçš„å‰æä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å¯åŠ¨ä¸€ä¸ªç‹¬ç«‹çš„Spark Thrift Serverã€‚&lt;/p&gt;
&lt;p&gt;è¿˜éœ€è¦è€ƒè™‘CDH Kerberosè®¤è¯çš„é—®é¢˜ã€‚&lt;/p&gt;
&lt;h2 id=&#34;spark-thrift-server-ç®€ä»‹&#34;&gt;Spark Thrift Server ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;../../images/sparksqlthriftserver.png&#34; alt=&#34;Spark SQL Thrift Server&#34;&gt;&lt;/p&gt;
&lt;p&gt;Spark Thrift Serveræ˜¯Sparkç¤¾åŒºåŸºäºHiveServer2å®ç°çš„ä¸€ä¸ªThriftæœåŠ¡ã€‚æ—¨åœ¨æ— ç¼å…¼å®¹HiveServer2ã€‚&lt;/p&gt;
&lt;p&gt;å› ä¸ºSpark Thrift Serverçš„æ¥å£å’Œåè®®éƒ½å’ŒHiveServer2å®Œå…¨ä¸€è‡´ï¼Œå› æ­¤æˆ‘ä»¬éƒ¨ç½²å¥½Spark Thrift Serveråï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨hiveçš„beelineè®¿é—®Spark Thrift Serveræ‰§è¡Œç›¸å…³è¯­å¥ã€‚&lt;/p&gt;
&lt;p&gt;Spark Thrift Serverçš„ç›®çš„ä¹Ÿåªæ˜¯å–ä»£HiveServer2ï¼Œå› æ­¤å®ƒä¾æ—§å¯ä»¥å’ŒHive Metastoreè¿›è¡Œäº¤äº’ï¼Œè·å–åˆ°hiveçš„å…ƒæ•°æ®ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://www.jianshu.com/p/b719c6415411&#34;&gt;https://www.jianshu.com/p/b719c6415411&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;apache-sparké…ç½®&#34;&gt;Apache Sparké…ç½®&lt;/h2&gt;
&lt;h3 id=&#34;ä¸‹è½½å®˜æ–¹ç‰ˆæœ¬&#34;&gt;ä¸‹è½½å®˜æ–¹ç‰ˆæœ¬&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;cd /opt
wget https://archive.apache.org/dist/spark/spark-2.4.0/spark-2.4.0-bin-hadoop2.7.tgz
cd spark-2.4.0-bin-hadoop2.7 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; ln -s &lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;pwd&lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt; /opt/spark
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;sparké…ç½®æ–‡ä»¶&#34;&gt;Sparké…ç½®æ–‡ä»¶&lt;/h3&gt;
&lt;p&gt;é€šè¿‡è½¯é“¾æ¥çš„æ–¹å¼å¤ç”¨Hiveçš„é…ç½®ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;ln -s /etc/hive/conf/hive-site.xml /opt/spark/conf/hive-site.xml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æœ€åé…ç½®æ–‡ä»¶å¤¹é•¿è¿™æ ·ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# ll /opt/spark/conf/&lt;/span&gt;
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp  &lt;span style=&#34;color:#ae81ff&#34;&gt;996&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; docker.properties.template
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp &lt;span style=&#34;color:#ae81ff&#34;&gt;1105&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; fairscheduler.xml.template
lrwxrwxrwx &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root   root     &lt;span style=&#34;color:#ae81ff&#34;&gt;28&lt;/span&gt; Apr  &lt;span style=&#34;color:#ae81ff&#34;&gt;9&lt;/span&gt; 11:05 hive-site.xml -&amp;gt; /etc/hive/conf/hive-site.xml
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp &lt;span style=&#34;color:#ae81ff&#34;&gt;2025&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; log4j.properties.template
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp &lt;span style=&#34;color:#ae81ff&#34;&gt;7801&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; metrics.properties.template
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp  &lt;span style=&#34;color:#ae81ff&#34;&gt;865&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; slaves.template
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp &lt;span style=&#34;color:#ae81ff&#34;&gt;1292&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; spark-defaults.conf.template
-rwxr-xr-x &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; webapp webapp &lt;span style=&#34;color:#ae81ff&#34;&gt;4221&lt;/span&gt; Oct &lt;span style=&#34;color:#ae81ff&#34;&gt;29&lt;/span&gt;  &lt;span style=&#34;color:#ae81ff&#34;&gt;2018&lt;/span&gt; spark-env.sh.template
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h4 id=&#34;sparké…ç½®æ–‡ä»¶é…ç½®æ–¹å¼&#34;&gt;Sparké…ç½®æ–‡ä»¶é…ç½®æ–¹å¼&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;é»˜è®¤é…ç½®è·¯å¾„ï¼š&lt;code&gt;$SPARK_HOME/conf&lt;/code&gt;ï¼Œå¦‚æœ&lt;code&gt;$SPARK_HOME&lt;/code&gt;ä¸å­˜åœ¨ï¼Œè„šæœ¬ä¸­ä¼šæŠŠè„šæœ¬ä¸Šå±‚ç›®å½•å½“åš&lt;code&gt;$SPARK_HOME&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;$SPARK_CONF_DIR&lt;/code&gt;ï¼Œå¯ä»¥æŒ‡å®šSPARKé…ç½®æ–‡ä»¶å¤¹ã€‚&lt;/li&gt;
&lt;li&gt;Spark classpathï¼Œå¦‚æœ&lt;code&gt;hdfs-site.xml&lt;/code&gt; &lt;code&gt;core-site.xml&lt;/code&gt;åœ¨classpathï¼ŒSparkå¯ä»¥è¯»å–ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;$HADOOP_CONF_DIR&lt;/code&gt;ï¼Œä¸€èˆ¬æ˜¯&lt;code&gt;/etc/hadoop/conf&lt;/code&gt;ç›®å½•ï¼Œè¯»Hadoopé…ç½®ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;$YARN_CONF_DIR&lt;/code&gt;ï¼Œä¸€èˆ¬ä¹Ÿæ˜¯&lt;code&gt;/etc/hadoop/conf&lt;/code&gt;ç›®å½•ã€‚&lt;/li&gt;
&lt;li&gt;å‘½ä»¤è¡Œä¸­å¯ä»¥è¦†ç›–ä»¥ä¸Šé…ç½®æ–‡ä»¶ä¸­çš„å…·ä½“å‚æ•°ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://spark.apache.org/docs/latest/configuration.html#inheriting-hadoop-cluster-configuration&#34;&gt;https://spark.apache.org/docs/latest/configuration.html#inheriting-hadoop-cluster-configuration&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;spark-libä¿®æ”¹&#34;&gt;Spark libä¿®æ”¹&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;cd /opt/spark
rm -rf jars/hadoop-yarn-*
cp /opt/cloudera/parcels/CDH-6.3.2-1.cdh6.3.2.p0.1605554/jars/hadoop-yarn-* jars/
cp /opt/cloudera/parcels/CDH-6.3.2-1.cdh6.3.2.p0.1605554/jars/hive-shims-scheduler-2.1.1-cdh6.3.2.jar jars/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;kerberos-è®¤è¯&#34;&gt;Kerberos è®¤è¯&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200410140136660.png&#34; alt=&#34;image-20200410140136660&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å›¾ä¸­çš„ä¸‰ä¸ªè§’è‰²ï¼Œåœ¨Kerkerosè®¤è¯ä½“ç³»ä¸‹éƒ½å¯¹åº”ä¸€ä¸ªprincipalã€‚Kerberos principalç›¸å½“äºç”¨æˆ·åï¼Œkeytabç›¸å½“äºå¯†ç ã€‚æƒé™é…ç½®ï¼Œä¾é hiveä¸hdfsæœ¬èº«ã€‚&lt;/li&gt;
&lt;li&gt;JDBCå®¢æˆ·ç«¯ä¸Spark JDBC Serveréœ€è¦ä½¿ç”¨Kerberosè®¤è¯ã€‚JDBCå®¢æˆ·ç«¯éœ€è¦æ‹¥æœ‰principal/keytabå¯¹ã€‚æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºã€‚&lt;/li&gt;
&lt;li&gt;Spark JDBC Serverä¸Hive metastoreéœ€è¦ä½¿ç”¨Kerberosè®¤è¯ã€‚JDBCæœåŠ¡ç«¯éœ€è¦æ‹¥æœ‰principal/keytabå¯¹ã€‚æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºã€‚&lt;/li&gt;
&lt;li&gt;Hive metastoreä¹Ÿæ‹¥æœ‰è‡ªå·±çš„principal/keytabå¯¹ï¼Œä¸è¿‡è¿™ä¸ªå·²ç»ç”±CDHæ‰˜ç®¡äº†ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¸¸è§Kerberosé”™è¯¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;org.apache.hive.service.ServiceException: Unable to login to kerberos with given principal/keytab / Caused by: java.io.IOException: HiveServer2 Kerberos principal or keytab is not correctly configured&lt;/li&gt;
&lt;li&gt;Caused by: java.io.IOException: Login failure for &lt;a href=&#34;mailto:hive/xh-hd2-peggy-dost000003@PEGGY.LING&#34;&gt;hive/xh-hd2-peggy-dost000003@PEGGY.LING&lt;/a&gt; from keytab hive.keytab: javax.security.auth.login.LoginException: Unable to obtain password from user&lt;/li&gt;
&lt;li&gt;SASL negotiation failure
javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)]&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;åˆ›å»º-spark-jdbc-server-çš„-principal&#34;&gt;åˆ›å»º Spark JDBC Server çš„ Principal&lt;/h3&gt;
&lt;p&gt;å› ä¸ºå¤ç”¨äº†Hiveçš„é…ç½®æ–‡ä»¶ï¼Œå¾…åˆ›å»ºçš„principalçš„åå­—éœ€è¦æ»¡è¶³é…ç½®ä¸­çš„è§„èŒƒã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;webapp@xh-hd2-peggy-dost000004 spark&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;$ cat conf/hive-site.xml
...
  &amp;lt;property&amp;gt;
    &amp;lt;name&amp;gt;hive.server2.authentication.kerberos.principal&amp;lt;/name&amp;gt;
    &amp;lt;value&amp;gt;hive/_HOST@PEGGY.LING&amp;lt;/value&amp;gt;
  &amp;lt;/property&amp;gt;
... 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;åœ¨KerberosæœåŠ¡å™¨åˆ›å»º principalåŠå¯¼å‡º keytabï¼ŒåŒæ­¥åˆ°Spark JDBC Serveræ‰€åœ¨æœºå™¨ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# create principal&lt;/span&gt;
kadmin.local addprinc -randkey hive/xh-hd2-peggy-dost000004
&lt;span style=&#34;color:#75715e&#34;&gt;# export keytab&lt;/span&gt;
kadmin.local ktadd -k hive.xh-hd2-peggy-dost000004.keytab hive/xh-hd2-peggy-dost000004
&lt;span style=&#34;color:#75715e&#34;&gt;# éªŒè¯æ˜¯å¦OK&lt;/span&gt;
kinit -kt hive.xh-hd2-peggy-dost000004.keytab hive/xh-hd2-peggy-dost000004@PEGGY.LING
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;å¯åŠ¨-spark-jdbc-server&#34;&gt;å¯åŠ¨ Spark JDBC Server&lt;/h3&gt;
&lt;p&gt;å¯åŠ¨è„šæœ¬å¦‚ä¸‹ã€‚å› ä¸ºé…ç½®æ–‡ä»¶é‡Œæ²¡æœ‰æŒ‡å®škeytabçš„è·¯å¾„ï¼Œéœ€è¦é€šè¿‡&lt;code&gt;--hiveconf&lt;/code&gt;æŒ‡å®šã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;#!/usr/bin/bash
&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;
export JAVA_HOME&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;/usr/java/jdk1.8.0_181-cloudera
export PATH&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;$PATH:$JAVA_HOME/bin
export HADOOP_CONF_DIR&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;/etc/hadoop/conf

kinit -kt hive.xh-hd2-peggy-dost000004.keytab hive/xh-hd2-peggy-dost000004@PEGGY.LING

sbin/start-thriftserver.sh &lt;span style=&#34;color:#ae81ff&#34;&gt;\
&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;&lt;/span&gt;--hiveconf hive.server2.authentication.kerberos.keytab hive.xh-hd2-peggy-dost000004.keytab
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¹Ÿå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š&lt;/p&gt;
&lt;p&gt;Configuring Spark Thrift Server with Kerberos &lt;a href=&#34;https://mapr.com/docs/61/Spark/ConfiguringSparkSQLThriftServer_Kerberos.html&#34;&gt;https://mapr.com/docs/61/Spark/ConfiguringSparkSQLThriftServer_Kerberos.html&lt;/a&gt;&lt;/p&gt;
&lt;h4 id=&#34;kinit-ticketè¿‡æœŸé—®é¢˜&#34;&gt;kinit ticketè¿‡æœŸé—®é¢˜&lt;/h4&gt;
&lt;p&gt;Spark Thrift Server è¿›ç¨‹ä¼šè‡ªåŠ¨å¤„ç†Kerberos ticket renewalæ“ä½œã€‚&lt;/p&gt;
&lt;p&gt;é»˜è®¤çš„ticket_lifetime 1dï¼Œrenew_lifetime 7dã€‚ä¸Šæ¬¡kinitæ˜¯04/10ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[webapp@xh-hd2-peggy-dost000004 spark]$ klist
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: hive/xh-hd2-peggy-dost000004@PEGGY.LING

Valid starting       Expires              Service principal
04/13/2020 01:32:45  04/14/2020 01:32:45  krbtgt/PEGGY.LING@PEGGY.LING
	renew until 04/17/2020 15:56:45
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å°±çœ‹7å¤©åä¼šæ€ä¹ˆæ ·äº†ã€‚renewå‘¨æœŸè¿‡äº†ï¼Œä¼šé‡å»ºä¹ˆï¼Ÿç†è®ºä¸Šæ˜¯å¯ä»¥çš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2020-05-30ï¼šå®è·µè¯æ˜ï¼Œrenewå‘¨æœŸè¿‡åï¼Œticketå°±æ— æ³•renewï¼Œä¹Ÿå°±æ— æ³•è¿æ¥æ•°æ®åº“ã€‚ç®€å•ç›´æ¥çš„æ–¹æ³•ï¼Œè®¾ç½®å®šæ—¶ä»»åŠ¡æ‰§è¡Œ kinit å‘½ä»¤ï¼Œåˆ·æ–°ticketï¼Œä¸ä¾èµ– spark çš„å®ç°ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;çœ‹åˆ°Sparkä»£ç ä¸­å·²ç»æœ‰kerberosé›†æˆäº†ï¼ŒåŒ…æ‹¬ç™»å½•å•¥çš„ã€‚&lt;/p&gt;
&lt;p&gt;spark/sql/hive-thriftserver/v2.3.5/src/main/java/org/apache/hive/service/auth/HiveAuthFactory.java&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200413110032646.png&#34; alt=&#34;image-20200413110032646&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200413105917167.png&#34; alt=&#34;image-20200413105917167&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;åˆ›å»º-jdbc-client-çš„-principal&#34;&gt;åˆ›å»º JDBC Client çš„ Principal&lt;/h3&gt;
&lt;p&gt;åœ¨KerberosæœåŠ¡å™¨åˆ›å»º principalåŠå¯¼å‡º keytabï¼ŒåŒæ­¥åˆ° JDBC Client æ‰€åœ¨æœºå™¨ã€‚è¿™é‡Œå¯¹principalçš„åç§°æ²¡æœ‰ä¸¥æ ¼è¦æ±‚ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# create principal&lt;/span&gt;
kadmin.local addprinc -randkey hive/xh-hd2-peggy-dost000003
&lt;span style=&#34;color:#75715e&#34;&gt;# export keytab&lt;/span&gt;
kadmin.local ktadd -k hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003 
&lt;span style=&#34;color:#75715e&#34;&gt;# éªŒè¯æ˜¯å¦OK&lt;/span&gt;
kinit -kt hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003@PEGGY.LING
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id=&#34;å¯åŠ¨-jdbc-client&#34;&gt;å¯åŠ¨ JDBC Client&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;webapp@xh-hd2-peggy-dost000003 spark&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;$ kinit -kt hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003@PEGGY.LING

&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;webapp@xh-hd2-peggy-dost000003 spark&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;$ bin/beeline -u &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;jdbc:hive2://xh-hd2-peggy-dost000004:10000/default;principal=hive/xh-hd2-peggy-dost000004@PEGGY.LING&amp;#34;&lt;/span&gt;
Connecting to jdbc:hive2://xh-hd2-peggy-dost000004:10000/default;principal&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;hive/xh-hd2-peggy-dost000004@PEGGY.LING
2020-04-10 16:09:01 INFO  Utils:310 - Supplied authorities: xh-hd2-peggy-dost000004:10000
2020-04-10 16:09:01 INFO  Utils:397 - Resolved authority: xh-hd2-peggy-dost000004:10000
2020-04-10 16:09:01 INFO  HiveConnection:203 - Will try to open client transport with JDBC Uri: jdbc:hive2://xh-hd2-peggy-dost000004:10000/default;principal&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;hive/xh-hd2-peggy-dost000004@PEGGY.LING
Connected to: Spark SQL &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;version 2.4.0&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
Driver: Hive JDBC &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;version 1.2.1.spark2&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
Transaction isolation: TRANSACTION_REPEATABLE_READ
Beeline version 1.2.1.spark2 by Apache Hive
0: jdbc:hive2://xh-hd2-peggy-dost000004:10000&amp;gt; show databases;
+---------------+--+
| databaseName  |
+---------------+--+
| db1           |
| default       |
| product       |
+---------------+--+
&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt; rows selected &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;0.091 seconds&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è‡³æ­¤ï¼ŒThrift Serverçš„å¯ç”¨å°±å®Œæˆäº†ã€‚&lt;/p&gt;
&lt;h3 id=&#34;yarn-è¿è¡Œ&#34;&gt;YARN è¿è¡Œ&lt;/h3&gt;
&lt;p&gt;å¤±è´¥äº†ï¼ŒTODO&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;sbin/start-thriftserver.sh --hiveconf hive.server2.authentication.kerberos.keytab hive.keytab --hiveconf hive.server2.thrift.port=10001 --queue root.zm_yarn_pool.development  --master yarn --executor-memory 4g --executor-cores 2 --num-executors 20

2020-04-09 17:56:19 INFO  Client:54 - Requesting a new application from cluster with 5 NodeManagers
Exception in thread &amp;quot;main&amp;quot; java.lang.NoClassDefFoundError: org/apache/hadoop/util/FastNumberFormat
        at org.apache.hadoop.yarn.api.records.ApplicationId.toString(ApplicationId.java:104)
        at org.apache.spark.deploy.yarn.Client$.org$apache$spark$deploy$yarn$Client$$getAppStagingDir(Client.scala:1222)
        at org.apache.spark.deploy.yarn.Client.org$apache$spark$deploy$yarn$Client$$cleanupStagingDirInternal$1(Client.scala:206)
        at org.apache.spark.deploy.yarn.Client.cleanupStagingDir(Client.scala:226)
        at org.apache.spark.deploy.yarn.Client.submitApplication(Client.scala:191)
        at org.apache.spark.scheduler.cluster.YarnClientSchedulerBackend.start(YarnClientSchedulerBackend.scala:57)
        at org.apache.spark.scheduler.TaskSchedulerImpl.start(TaskSchedulerImpl.scala:178)
        at org.apache.spark.SparkContext.&amp;lt;init&amp;gt;(SparkContext.scala:501)
        at org.apache.spark.SparkContext$.getOrCreate(SparkContext.scala:2520)
        at org.apache.spark.sql.SparkSession$Builder$$anonfun$7.apply(SparkSession.scala:935)
        at org.apache.spark.sql.SparkSession$Builder$$anonfun$7.apply(SparkSession.scala:926)
        at scala.Option.getOrElse(Option.scala:121)
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;å¤–ä¼ cdhæ˜¯å¦‚ä½•ç®¡ç†hadoopé…ç½®æ–‡ä»¶çš„&#34;&gt;ã€å¤–ä¼ ã€‘CDHæ˜¯å¦‚ä½•ç®¡ç†Hadoopé…ç½®æ–‡ä»¶çš„&lt;/h2&gt;
&lt;p&gt;ä»¥ä¸‹ç»“æœéƒ½æ˜¯é€šè¿‡è§‚å¯Ÿå®è·µæ‰€å¾—ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥Hiveä¸ºä¾‹ï¼Œ&lt;code&gt;/etc/hive/conf&lt;/code&gt;ä¸‹çš„é…ç½®æ–‡ä»¶ç”±CDHç”Ÿæˆã€‚ï¼ˆCDHç®¡ç†ç•Œé¢ä¸Šå¯ä»¥ä¿®æ”¹è¿™äº›é…ç½®ã€‚ï¼‰&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# ll /etc/hive/conf/&lt;/span&gt;
total &lt;span style=&#34;color:#ae81ff&#34;&gt;64&lt;/span&gt;
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root   &lt;span style=&#34;color:#ae81ff&#34;&gt;21&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 __cloudera_generation__
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root   &lt;span style=&#34;color:#ae81ff&#34;&gt;70&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 __cloudera_metadata__
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root &lt;span style=&#34;color:#ae81ff&#34;&gt;3846&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 core-site.xml
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root  &lt;span style=&#34;color:#ae81ff&#34;&gt;617&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 hadoop-env.sh
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root &lt;span style=&#34;color:#ae81ff&#34;&gt;3839&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 hdfs-site.xml
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root &lt;span style=&#34;color:#ae81ff&#34;&gt;2655&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 hive-env.sh
-rw-r--r-- &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; root root &lt;span style=&#34;color:#ae81ff&#34;&gt;6925&lt;/span&gt; Dec &lt;span style=&#34;color:#ae81ff&#34;&gt;31&lt;/span&gt; 15:02 hive-site.xml
...

&lt;span style=&#34;color:#75715e&#34;&gt;# head /etc/hive/conf/hive-site.xml&lt;/span&gt;
&amp;lt;?xml version&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;1.0&amp;#34;&lt;/span&gt; encoding&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;UTF-8&amp;#34;&lt;/span&gt;?&amp;gt;

&amp;lt;!--Autogenerated by Cloudera Manager--&amp;gt;
&amp;lt;configuration&amp;gt;
  &amp;lt;property&amp;gt;
    &amp;lt;name&amp;gt;hive.metastore.uris&amp;lt;/name&amp;gt;
    &amp;lt;value&amp;gt;thrift://xh-hd2-peggy-dost001:9083&amp;lt;/value&amp;gt;
  &amp;lt;/property&amp;gt;
  &amp;lt;property&amp;gt;
    &amp;lt;name&amp;gt;hive.metastore.client.socket.timeout&amp;lt;/name&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;æˆ‘ä»¬çš„é›†ç¾¤æ˜¯å¼€å¯äº†Kerberosè®¤è¯çš„ã€‚ä½†æ˜¯ä¸Šè¿°é…ç½®æ–‡ä»¶é‡Œæ²¡è§principalçš„keytabè·¯å¾„é…ç½®ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# grep keytab /etc/hive/conf/hive-site.xml&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;ä¹Ÿå°±æ˜¯è¯´ï¼Œ&lt;code&gt;/etc/hive/conf&lt;/code&gt;ä¸æ˜¯çœŸæ­£åœ¨è¢«ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;/var/run/cloudera-scm-agent/process/&lt;/code&gt; è¿™ä¸ªç›®å½•ä¸­æœ‰æ‰€æœ‰CDHç›‘æ§çš„è¿›ç¨‹ï¼ŒåŒ…æ‹¬æˆ‘ä»¬å…³æ³¨çš„Hiveè¿›ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://community.cloudera.com/t5/Support-Questions/Location-of-keytab-files/td-p/33716&#34;&gt;https://community.cloudera.com/t5/Support-Questions/Location-of-keytab-files/td-p/33716&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ls /var/run/cloudera-scm-agent/process/*hive*
/var/run/cloudera-scm-agent/process/954-hive-HIVEMETASTORE:
cloudera-monitor.properties        config.zip     creds.localjceks  hdfs-site.xml  hive-log4j2.properties  logs       redaction-rules.json  service-metrics.properties  supervisor_status
cloudera-stack-monitor.properties  core-site.xml  exit_code         hive.keytab    hive-site.xml           proc.json  sentry-site.xml       supervisor.conf             yarn-conf

/var/run/cloudera-scm-agent/process/955-hive-HIVESERVER2:
cloudera-monitor.properties        config.zip     exit_code           hdfs-site.xml  hive-log4j2.properties  logs                         navigator.lineage.client.properties  redaction-rules.json  service-metrics.properties  supervisor.conf    yarn-conf
cloudera-stack-monitor.properties  core-site.xml  fair-scheduler.xml  hive.keytab    hive-site.xml           navigator.client.properties  proc.json                            sentry-site.xml       spark-defaults.conf         supervisor_status

/var/run/cloudera-scm-agent/process/956-hive-WEBHCAT:
cloudera-monitor.properties        config.zip     exit_code      hive-site.xml  logs       redaction-rules.json        supervisor.conf    webhcat-default.xml       webhcat-site.xml
cloudera-stack-monitor.properties  core-site.xml  hdfs-site.xml  HTTP.keytab    proc.json  service-metrics.properties  supervisor_status  webhcat-log4j.properties  yarn-conf
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è¿™é‡ŒHiveæœ‰ä¸‰ä¸ªè¿›ç¨‹ï¼Œmetastoreï¼Œhiveserver2ï¼ŒWEBHCATã€‚å¯è§principalå¯¹åº”çš„keytabï¼Œè¿™é‡Œçš„ &lt;code&gt;hive.keytab&lt;/code&gt;ï¼Œä¹Ÿæ˜¯åœ¨è¿™é‡Œç»´æŠ¤ç€ã€‚é…ç½®æ–‡ä»¶ä¹Ÿæ˜¯åœ¨&lt;code&gt;/etc/hive/conf&lt;/code&gt;åŸºç¡€ä¸Šä½œäº†æ”¹åŠ¨ï¼Œæ¯”å¦‚keytabè·¯å¾„çš„è®¾ç½®ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;root 954-hive-HIVEMETASTORE&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# grep kerberos hive-site.xml&lt;/span&gt;
    &amp;lt;name&amp;gt;hive.metastore.kerberos.principal&amp;lt;/name&amp;gt;
    &amp;lt;name&amp;gt;hive.metastore.kerberos.keytab.file&amp;lt;/name&amp;gt;
    &amp;lt;value&amp;gt;kerberos&amp;lt;/value&amp;gt;
    
&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;root 955-hive-HIVESERVER2&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# grep kerberos hive-site.xml&lt;/span&gt;
    &amp;lt;value&amp;gt;kerberos&amp;lt;/value&amp;gt;
    &amp;lt;name&amp;gt;hive.metastore.kerberos.principal&amp;lt;/name&amp;gt;
    &amp;lt;name&amp;gt;hive.server2.authentication.kerberos.principal&amp;lt;/name&amp;gt;
    &amp;lt;name&amp;gt;hive.server2.authentication.kerberos.keytab&amp;lt;/name&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;HiveMetaStoreä¸HiveServer2ä½¿ç”¨çš„keytabæ˜¯ä¸åŒçš„ã€‚ä¸€ä¸ªprincipalå¯¹åº”å¤šä¸ªkeytabä¹ˆï¼ŸTODOï¼šå¯èƒ½æ˜¯å› ä¸ºåŠ å¯†éšæœºçš„åŸå› ï¼Ÿï¼Ÿï¼Ÿ&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;root@xh-hd2-peggy-dost001 955-hive-HIVESERVER2&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# md5sum hive.keytab&lt;/span&gt;
523357eec4f542b7b3df7ec52cee43b2  hive.keytab

&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;root@xh-hd2-peggy-dost001 954-hive-HIVEMETASTORE&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# md5sum hive.keytab&lt;/span&gt;
3c6f52333067518ae4bdce1e99878857  hive.keytab
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;TODOï¼šå®éªŒå‘ç°ï¼Œå¯¼å‡ºä¸¤æ¬¡ï¼Œä¹‹å‰çš„keytabå°±å¤±æ•ˆäº†ï¼è¿›å…¥çŸ¥è¯†ç›²åŒºã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@xh-hd2-peggy-rost01 ~]# kadmin.local addprinc -randkey hive/xh-hd2-peggy-dost000003
[root@xh-hd2-peggy-rost01 ~]# kadmin.local ktadd -k hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003
[root@xh-hd2-peggy-rost01 ~]# mv hive.xh-hd2-peggy-dost000003.keytab hive.xh-hd2-peggy-dost000003.keytab.bak
[root@xh-hd2-peggy-rost01 ~]# kadmin.local ktadd -k hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003
[root@xh-hd2-peggy-rost01 ~]# kinit -kt hive.xh-hd2-peggy-dost000003.keytab hive/xh-hd2-peggy-dost000003@PEGGY.LING
[root@xh-hd2-peggy-rost01 ~]# kinit -kt hive.xh-hd2-peggy-dost000003.keytab.bak hive/xh-hd2-peggy-dost000003@PEGGY.LING
kinit: Password incorrect while getting initial credentials
&lt;/code&gt;&lt;/pre&gt;- https://xujiahua.github.io/posts/20200410-spark-thrift-server-cdh/ - </description>
        </item>
    
    
    
        <item>
        <title>Dockeræ—¥å¿—é©±åŠ¨å°ç»“</title>
        <link>https://xujiahua.github.io/posts/20200403-docker-logging/</link>
        <pubDate>Fri, 03 Apr 2020 15:43:07 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200403-docker-logging/</guid>
        <description>è®¸å˜‰åçš„ç¬”è®° https://xujiahua.github.io/posts/20200403-docker-logging/ -&lt;p&gt;&lt;code&gt;docker logs&lt;/code&gt;ï¼Œ &lt;code&gt;kubectl logs&lt;/code&gt;èƒ½çœ‹åˆ°Dockerå®¹å™¨çš„æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜ã€‚è€Œ &lt;code&gt;xxx logs&lt;/code&gt;ä¹‹æ‰€ä»¥èƒ½çœ‹åˆ°ï¼Œæ˜¯å› ä¸ºæ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯å­˜å‚¨åœ¨æ¯ä¸ªå®¹å™¨ç‹¬æœ‰çš„æ—¥å¿—æ–‡ä»¶ä¸­ã€‚&lt;/p&gt;
&lt;p&gt;å¦å¤–æ—¥å¿—é‡å¤§äº†ï¼Œç”¨&lt;code&gt;docker logs&lt;/code&gt;çœ‹å†å²æ•°æ®ä¸å¤§åˆé€‚ã€‚æˆ‘ä»¬å°±éœ€è¦è€ƒè™‘å°†æ—¥å¿—å­˜å‚¨åˆ°æ—¥å¿—ä¸­å¿ƒå»ã€‚&lt;/p&gt;
&lt;p&gt;Dockeré»˜è®¤æ”¯æŒå¦‚ä¸‹æ—¥å¿—é©±åŠ¨ã€‚æœ‰ç›´æ¥å†™æ–‡ä»¶çš„ï¼Œæœ‰ä½¿ç”¨äº‘æœåŠ¡çš„ã€‚ä¸‹é¢ç®€å•ä»‹ç»ä¸‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/Screen-Shot-2017-09-11-at-3.08.50-PM.png&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;p&gt;credit: &lt;a href=&#34;https://jaxenter.com/docker-logging-gotchas-137049.html&#34;&gt;https://jaxenter.com/docker-logging-gotchas-137049.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å®˜æ–¹æ–‡æ¡£ &lt;a href=&#34;https://docs.docker.com/config/containers/logging/configure/&#34;&gt;https://docs.docker.com/config/containers/logging/configure/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;é»˜è®¤é©±åŠ¨json-file&#34;&gt;é»˜è®¤é©±åŠ¨ï¼šjson-file&lt;/h2&gt;
&lt;p&gt;é»˜è®¤çš„Logging Driveræ˜¯json-fileã€‚&lt;code&gt;docker info&lt;/code&gt;å¯ä»¥æŸ¥çœ‹ã€‚å…¨å±€çš„æ—¥å¿—é©±åŠ¨è®¾ç½®ï¼Œå¯ä»¥ä¿®æ”¹daemoné…ç½®æ–‡ä»¶ &lt;code&gt;/etc/docker/daemon.json&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å†™å…¥æ–‡ä»¶çš„æ—¥å¿—æ ¼å¼é•¿è¿™æ ·ï¼š&lt;code&gt;{&amp;quot;log&amp;quot;:&amp;quot;Log line is here\n&amp;quot;,&amp;quot;stream&amp;quot;:&amp;quot;stdout&amp;quot;,&amp;quot;time&amp;quot;:&amp;quot;2019-01-01T11:11:11.111111111Z&amp;quot;}&lt;/code&gt;ï¼Œæ¯ä¸€è¡Œæ˜¯ä¸€ä¸ªjsonæ–‡ä»¶ï¼Œlogå­—æ®µä¸ºå®¹å™¨åŸæ¥è¾“å‡ºçš„æ¯è¡Œå†…å®¹ã€‚&lt;/p&gt;
&lt;p&gt;é»˜è®¤é…ç½®ï¼Œåˆ›å»ºçš„å®¹å™¨çš„ä¿¡æ¯åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼š &lt;code&gt;/var/lib/docker/containers&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒ&#34;&gt;å®éªŒ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;root@ubuntu-parallel:~# docker run --name default_logging_driver hello-world

root@ubuntu-parallel:~# cd /var/lib/docker/containers/&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=default_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;

root@ubuntu-parallel:~# cat &lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=default_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;-json.log
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;log&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\n&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stream&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;time&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2020-04-02T01:46:54.096347888Z&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;log&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Hello from Docker!\n&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stream&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;time&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2020-04-02T01:46:54.096377382Z&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;log&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;This message shows that your installation appears to be working correctly.\n&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stream&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;time&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2020-04-02T01:46:54.096381118Z&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color:#f92672&#34;&gt;{&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;log&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\n&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stream&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;time&amp;#34;&lt;/span&gt;:&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2020-04-02T01:46:54.096383725Z&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/config/containers/logging/json-file/&#34;&gt;https://docs.docker.com/config/containers/logging/json-file/&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;æ€ä¹ˆè®°å½•æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯&#34;&gt;æ€ä¹ˆè®°å½•æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;json-file&lt;/code&gt;æœ¬èº«æ˜¯æ²¡æœ‰è®°å½•ä¸Šä¸‹æ–‡ä¿¡æ¯çš„ã€‚é›†ä¸­å­˜å‚¨åˆ°æ—¥å¿—ä¸­å¿ƒæœåŠ¡å™¨ï¼Œå°±æ— æ³•åŒºåˆ†å…·ä½“æ˜¯å“ªä¸ªåº”ç”¨äº§ç”Ÿçš„æ—¥å¿—äº†ã€‚&lt;/p&gt;
&lt;p&gt;k8sçš„å®¹å™¨æ—¥å¿—æ”¶é›†ï¼Œä¸Šä¸‹æ–‡ä¿¡æ¯æ˜¯ç”±æ—¥å¿—æ”¶é›†å·¥å…· &lt;code&gt;fluentd&lt;/code&gt; é€šè¿‡è¯·æ±‚api serveré‡‡é›†å¹¶ç¼“å­˜èµ·æ¥çš„ã€‚å‚è€ƒ &lt;a href=&#34;https://xujiahua.github.io/posts/20200414-k8s-logging/&#34;&gt;https://xujiahua.github.io/posts/20200414-k8s-logging/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;åŒæ ·çš„æ€è·¯ï¼Œ&lt;code&gt;fluentd&lt;/code&gt;ä¹Ÿæœ‰ä¸å°‘é€šè¿‡docker daemonæŸ¥è¯¢æˆ–æ˜¯è§£æå®¹å™¨ç›®å½•ä¸‹&lt;code&gt;config.v2.json&lt;/code&gt;è·å–metadataçš„ filter æ’ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200414112709859.png&#34; alt=&#34;image-20200414112709859&#34;&gt;&lt;/p&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://www.fluentd.org/plugins&#34;&gt;https://www.fluentd.org/plugins&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚è¿™ä¸ª &lt;a href=&#34;https://github.com/zsoltf/fluent-plugin-docker_metadata_elastic_filter&#34;&gt;https://github.com/zsoltf/fluent-plugin-docker_metadata_elastic_filter&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{
  &amp;quot;log&amp;quot;: &amp;quot;2015/05/05 19:54:41 \n&amp;quot;,
  &amp;quot;stream&amp;quot;: &amp;quot;stderr&amp;quot;,
  &amp;quot;docker&amp;quot;: {
    &amp;quot;id&amp;quot;: &amp;quot;df14e0d5ae4c07284fa636d739c8fc2e6b52bc344658de7d3f08c36a2e804115&amp;quot;,
    &amp;quot;name&amp;quot;: &amp;quot;k8s_fabric8-console-container.efbd6e64_fabric8-console-controller-9knhj_default_8ae2f621-f360-11e4-8d12-54ee7527188d_7ec9aa3e&amp;quot;,
    &amp;quot;container_hostname&amp;quot;: &amp;quot;fabric8-console-controller-9knhj&amp;quot;,
    &amp;quot;image&amp;quot;: &amp;quot;fabric8/hawtio-kubernetes:latest&amp;quot;,
    &amp;quot;image_id&amp;quot;: &amp;quot;b2bd1a24a68356b2f30128e6e28e672c1ef92df0d9ec01ec0c7faea5d77d2303&amp;quot;,
    &amp;quot;labels&amp;quot;: {}
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ–°å¢äº†dockerç»“æ„ä½“ï¼Œé•œåƒåç§°ä¹Ÿèƒ½æ”¶é›†åˆ°äº† ã€‚&lt;/p&gt;
&lt;h2 id=&#34;local&#34;&gt;local&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;--log-driver&lt;/code&gt;æŒ‡å®šæ—¥å¿—é©±åŠ¨ã€‚&lt;/p&gt;
&lt;p&gt;catè¾“å‡ºlocalæ–‡ä»¶ï¼Œéƒ¨åˆ†ç»“æœä¹±ç ã€‚æŒºä¸æ–¹ä¾¿æ—¥å¿—è§£æçš„ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒ-1&#34;&gt;å®éªŒ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;root@ubuntu-parallel:~# docker run --name local_logging_driver --log-driver local hello-world

root@ubuntu-parallel:~# cd /var/lib/docker/containers/&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=local_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;

root@ubuntu-parallel:~# cat local-logs/container.log
stdoutï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½&amp;amp;
stdoutï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Hello from Docker!&amp;amp;^
stdoutË§ï¿½ï¿½ï¿½ï¿½ï¿½JThis message shows that your installation appears to be working correctly.^
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/config/containers/logging/local/&#34;&gt;https://docs.docker.com/config/containers/logging/local/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;none&#34;&gt;none&lt;/h2&gt;
&lt;p&gt;ä¸ç”Ÿæˆæ—¥å¿—æ–‡ä»¶ï¼Œ&lt;code&gt;docker logs&lt;/code&gt;ä¹Ÿæ‹¿ä¸åˆ°æ—¥å¿—ã€‚å®é™…ä½¿ç”¨ä¸ä¼šè€ƒè™‘ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒ-2&#34;&gt;å®éªŒ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;root@ubuntu-parallel:~# docker run --name none_logging_driver --log-driver none hello-world

root@ubuntu-parallel:~# cd /var/lib/docker/containers/&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=none_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;

root@ubuntu-parallel:~# docker logs none_logging_driver
Error response from daemon: configured logging driver does not support reading
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;syslog&#34;&gt;syslog&lt;/h2&gt;
&lt;p&gt;å› ä¸ºæ—¥å¿—è¢«å†™å…¥äº†syslogï¼Œå¹¶æ··åœ¨å…¶ä»–åº”ç”¨çš„æ—¥å¿—ä¸­ï¼Œ&lt;code&gt;docker logs&lt;/code&gt;æ²¡åŠæ³•å·¥ä½œäº†ã€‚&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒ-3&#34;&gt;å®éªŒ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# è§‚å¯Ÿsyslog&lt;/span&gt;
root@ubuntu-parallel:~# tail -f /var/log/syslog

root@ubuntu-parallel:~# docker run --name syslog_logging_driver --log-driver syslog hello-world

&lt;span style=&#34;color:#75715e&#34;&gt;# æ—¥å¿—ä¸ä¼šå†™æœ¬åœ°&lt;/span&gt;
root@ubuntu-parallel:~# cd /var/lib/docker/containers/&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=syslog_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;

root@ubuntu-parallel:~# docker logs syslog_logging_driver
Error response from daemon: configured logging driver does not support reading
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/config/containers/logging/syslog/&#34;&gt;https://docs.docker.com/config/containers/logging/syslog/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;journald&#34;&gt;journald&lt;/h2&gt;
&lt;p&gt;å†™å…¥syslogå’Œjournaldï¼Œåº”ç”¨æ—¥å¿—ä¸ç³»ç»Ÿæ—¥å¿—æ··åœ¨ä¸€èµ·ï¼Œéš¾ä»¥è¾¨è®¤äº†ã€‚&lt;/p&gt;
&lt;p&gt;å€’æ˜¯journaldé©±åŠ¨ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨&lt;code&gt;docker logs&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼šhttps://wiki.archlinux.org/index.php/Systemd/Journal&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒ-4&#34;&gt;å®éªŒ&lt;/h3&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;root@ubuntu-parallel:~# docker run --name journald_logging_driver --log-driver journald hello-world

root@ubuntu-parallel:~# journalctl
Apr &lt;span style=&#34;color:#ae81ff&#34;&gt;02&lt;/span&gt; 10:30:36 ubuntu-parallel 4b948bf091a8&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;999&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;: To try something more ambitious, you can run an Ubuntu container with:
Apr &lt;span style=&#34;color:#ae81ff&#34;&gt;02&lt;/span&gt; 10:30:36 ubuntu-parallel 4b948bf091a8&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;999&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;:  $ docker run -it ubuntu bash
Apr &lt;span style=&#34;color:#ae81ff&#34;&gt;02&lt;/span&gt; 10:30:36 ubuntu-parallel 4b948bf091a8&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;999&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;:
Apr &lt;span style=&#34;color:#ae81ff&#34;&gt;02&lt;/span&gt; 10:30:36 ubuntu-parallel 4b948bf091a8&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;999&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;: Share images, automate workflows, and more with a free Docker ID:
Apr &lt;span style=&#34;color:#ae81ff&#34;&gt;02&lt;/span&gt; 10:30:36 ubuntu-parallel 4b948bf091a8&lt;span style=&#34;color:#f92672&#34;&gt;[&lt;/span&gt;999&lt;span style=&#34;color:#f92672&#34;&gt;]&lt;/span&gt;:  https://hub.docker.com/

root@ubuntu-parallel:~# cd /var/lib/docker/containers/&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;docker ps --no-trunc -aqf &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;name=journald_logging_driver&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# docker logsç®¡ç”¨&lt;/span&gt;
root@ubuntu-parallel:~# docker logs journald_logging_driver

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;a href=&#34;https://docs.docker.com/config/containers/logging/journald/&#34;&gt;https://docs.docker.com/config/containers/logging/journald/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;fluentd&#34;&gt;Fluentd&lt;/h2&gt;
&lt;p&gt;é€šè¿‡æœåŠ¡è¯·æ±‚ï¼Œè®©dockeråæ—¥å¿—åˆ°fluentdè¿›ç¨‹ã€‚https://docs.docker.com/config/containers/logging/fluentd/&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨åŒ…æ‹¬fluentdåœ¨å¾ˆå¤šæ—¥å¿—é©±åŠ¨ï¼Œå› ä¸ºæ—¥å¿—å†™å…¥åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼Œä¼šå¯¼è‡´&lt;code&gt;docker logs&lt;/code&gt;ï¼Œ &lt;code&gt;kubectl logs&lt;/code&gt;ä¸å¯ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;Fluentdæ˜¯ä¸€ä¸ªæŒºçµæ´»çš„å·¥å…·ï¼Œå¯ä»¥è®©fluentdä¸»åŠ¨ç›‘å¬å®¹å™¨ç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶ã€‚å‚è€ƒå¦ä¸€ç¯‡æ–‡ç«  &lt;a href=&#34;https://xujiahua.github.io/posts/use-fluentd/&#34;&gt;https://xujiahua.github.io/posts/use-fluentd/&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;æ€»ç»“&#34;&gt;æ€»ç»“&lt;/h2&gt;
&lt;p&gt;ä¸ºäº†å…¼å®¹å¯ä½¿ç”¨&lt;code&gt;docker logs&lt;/code&gt; ï¼Œ&lt;code&gt;kubectl logs&lt;/code&gt;ï¼Œå¿…é¡»ä½¿ç”¨å†™æœ¬åœ°æ–‡ä»¶çš„æ—¥å¿—é©±åŠ¨ã€‚è€Œjsonæ ¼å¼æ›´æ–¹ä¾¿å·¥å…·ï¼ˆæ¯”å¦‚fluentdï¼Œlogstashï¼‰è§£æï¼Œæ‰€ä»¥json-fileæ˜¯é¦–é€‰ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶åä½¿ç”¨æ—¥å¿—æ”¶é›†å·¥å…·é›†ä¸­é‡‡é›†dockerå®¹å™¨æ—¥å¿—ã€‚k8sä¸­æ—¥å¿—æ”¶é›†ç­–ç•¥ï¼Œä¸€èˆ¬æ˜¯åœ¨æ¯å°æœåŠ¡å™¨ä¸Šä»¥DaemonSetçš„å½¢å¼å®‰è£…logging agentï¼Œç›‘å¬æœ¬åœ°æ–‡ä»¶ã€æ–‡ä»¶å¤¹ï¼Œå°†æ—¥å¿—è½¬å‘åˆ°æ—¥å¿—ä¸­å¿ƒã€‚&lt;/p&gt;
&lt;p&gt;å½“ç„¶è¿™ä¸ªå‰ææ¡ä»¶æ˜¯ï¼Œåº”ç”¨æ—¥å¿—æ˜¯è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯çš„ã€‚è¿™å¯¹åº”ç”¨æ—¥å¿—çš„è§„èŒƒæœ‰ä¸€å®šè¦æ±‚ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸è¾“å‡ºå¤šè¡Œæ—¥å¿—ã€‚æ¯”å¦‚panicã€exceptionã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨æ—¥å¿—ä½¿ç”¨JSONæ ¼å¼è¾“å‡ºï¼Œæ–¹ä¾¿åç»­çš„æ—¥å¿—åˆ†æã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨æ—¥å¿—ä¸­åŠ å…¥æ›´å¤šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ç”¨äºé—®é¢˜å®šä½ï¼Œç»´åº¦åˆ†æã€‚&lt;/li&gt;
&lt;li&gt;Goåº”ç”¨å¼€å‘ï¼Œä½¿ç”¨logrusæ—¥å¿—åº“ï¼ŒåŠ å­—æ®µï¼Œä»¥JSONæ ¼å¼è¾“å‡ºéƒ½å¾ˆæ–¹ä¾¿ã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨ä¸å…³æ³¨æ—¥å¿—è¯¥å¦‚ä½•æ”¶é›†è¿™ä¸ªé—®é¢˜ã€‚ä¸åœ¨åº”ç”¨å±‚å†™æ—¥å¿—åˆ°kafkaã€redisç­‰ä¸­é—´ä»¶ï¼Œè®©åŸºç¡€è®¾æ–½å±‚å¤„ç†ã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨è¦ä¹ˆå†™å…¥æ–‡ä»¶ã€è¦ä¹ˆå†™å…¥æ ‡å‡†è¾“å‡ºï¼Œè¿™ä¸ªåº”è¯¥å¾ˆæ–¹ä¾¿åšæˆå¯é…ç½®çš„ã€‚å¯¹ç¨‹åºæ¥è¯´ï¼Œéƒ½æœ‰å…±åŒçš„æŠ½è±¡ï¼Œio.Writerã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;åº”ç”¨æ—¥å¿—å¦‚æœæ˜¯å†™åˆ°æ–‡ä»¶çš„ï¼Œéœ€è¦è€ƒè™‘é€šè¿‡æ•°æ®å·ï¼ŒæŒ‚è½½ç­‰å°†æ—¥å¿—ä¸å®¹å™¨åˆ†ç¦»ã€‚é‡‡é›†æŒ‚è½½ç›®å½•ä¸Šçš„æ—¥å¿—æ–‡ä»¶ï¼Œä»¥å‰æ€ä¹ˆæ”¶é›†ï¼Œç°åœ¨è¿˜æ˜¯æ€ä¹ˆæ”¶é›†ã€‚è¿˜æ˜¯å»ºè®®å†™æ ‡å‡†è¾“å‡ºï¼Œè¿™æ˜¯ç›®å‰çš„æœ€ä½³å®è·µã€‚&lt;/p&gt;
- https://xujiahua.github.io/posts/20200403-docker-logging/ - </description>
        </item>
    
    
    
        <item>
        <title>Fluentdå®æˆ˜</title>
        <link>https://xujiahua.github.io/posts/20200402-use-fluentd/</link>
        <pubDate>Thu, 02 Apr 2020 16:58:23 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200402-use-fluentd/</guid>
        <description>è®¸å˜‰åçš„ç¬”è®° https://xujiahua.github.io/posts/20200402-use-fluentd/ -&lt;p&gt;ä»¥æ”¶é›†Dockerå®¹å™¨æ—¥å¿—çš„ä¾‹å­ï¼Œä»‹ç»ä¸‹Fluentdçš„ç”¨æ³•ã€‚ä¸è€ƒè™‘logstashï¼Œå¤ªå æœåŠ¡å™¨èµ„æºäº†ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å®‰è£…-fluentd&#34;&gt;å®‰è£… Fluentd&lt;/h2&gt;
&lt;p&gt;Ubuntu 18.04ä¸Šçš„å®‰è£…å‘½ä»¤ï¼ˆhttps://docs.fluentd.org/installation/install-by-debï¼‰ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# curl -L https://toolbelt.treasuredata.com/sh/install-ubuntu-bionic-td-agent3.sh | sh
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ä»¥Daemonæ–¹å¼å¯åŠ¨ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# systemctl start td-agent.service
root@ubuntu-parallel:~# systemctl status td-agent.service
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;fluentdçš„å®‰è£…ç›®å½•æ˜¯åœ¨/opt/td-agent/ä¸‹çš„ã€‚ä¸ºæ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ &lt;code&gt;/opt/td-agent/embedded/bin/fluentd&lt;/code&gt;è¿™ä¸ªç¨‹åºã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# ps -ef | grep fluentd
td-agent 30596     1  0 17:10 ?        00:00:00 /opt/td-agent/embedded/bin/ruby /opt/td-agent/embedded/bin/fluentd --log /var/log/td-agent/td-agent.log --daemon /var/run/td-agent/td-agent.pid
td-agent 30602 30596  9 17:10 ?        00:00:00 /opt/td-agent/embedded/bin/ruby -Eascii-8bit:ascii-8bit /opt/td-agent/embedded/bin/fluentd --log /var/log/td-agent/td-agent.log --daemon /var/run/td-agent/td-agent.pid --under-supervisor
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å…¶ä»–ç³»ç»Ÿçš„å®‰è£…å‚è€ƒï¼šhttps://docs.fluentd.org/installation&lt;/p&gt;
&lt;h3 id=&#34;å°è¯•ç‰›åˆ€&#34;&gt;å°è¯•ç‰›åˆ€&lt;/h3&gt;
&lt;p&gt;é…ç½®æ–‡ä»¶ test.confï¼Œå¯åŠ¨ä¸€ä¸ªHTTPæœåŠ¡ï¼Œå¹¶æŠŠæ¥æ”¶åˆ°çš„æ—¥å¿—ï¼Œæ‰“å°åˆ°æ ‡å‡†è¾“å‡ºã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;source&amp;gt;
  @type http
  port 9880
&amp;lt;/source&amp;gt;

&amp;lt;match *.*&amp;gt;
  @type stdout
&amp;lt;/match&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¯åŠ¨fluentdè¿›ç¨‹ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# /opt/td-agent/embedded/bin/fluentd -c test.conf
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;é€šè¿‡HTTPæœåŠ¡æäº¤æ—¥å¿—ã€‚å¯ä»¥çœ‹åˆ°fluentdç»ˆç«¯æ‰“å°å‡ºäº†è¾“å…¥çš„æ—¥å¿—ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# curl -X POST -d &#39;json={&amp;quot;event&amp;quot;:&amp;quot;data&amp;quot;}&#39; http://localhost:9880/my.tag
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;å®æˆ˜æ”¶é›†linuxä¸»æœºä¸Šçš„dockerå®¹å™¨æ—¥å¿—&#34;&gt;å®æˆ˜ï¼šæ”¶é›†Linuxä¸»æœºä¸Šçš„Dockerå®¹å™¨æ—¥å¿—&lt;/h2&gt;
&lt;p&gt;Dockerå®˜æ–¹æœ‰fluentdçš„Logging Driverã€‚ä¸è¶³ä¹‹å¤„ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å› ä¸ºæ²¡æœ‰äº†æœ¬åœ°æ—¥å¿—æ–‡ä»¶ï¼Œdocker logs ä¸ç®¡ç”¨äº†ã€‚&lt;/li&gt;
&lt;li&gt;éœ€è¦é¢å¤–é…ç½®ï¼Œæˆ–æ˜¯åœ¨daemon.jsoné‡Œè®¾å®šï¼Œæˆ–æ˜¯docker runæ—¶å€™è®¾å®šã€‚æ–°å¢æœºå™¨æˆ–æ˜¯è¿è¡Œå®¹å™¨ï¼Œå¾ˆå®¹æ˜“å¿˜è®°ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœè¿œç¨‹æ•°æ®å­˜å‚¨downäº†ï¼Œä¼šä¸ä¼šä¸¢æ—¥å¿—ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è€ƒè™‘åˆ°è¿™äº›é—®é¢˜ï¼Œæœ¬å®éªŒä»¥æ”¶é›†æœ¬åœ°æ—¥å¿—çš„æ–¹å¼ä½¿ç”¨fluentdã€‚&lt;/p&gt;
&lt;h3 id=&#34;å®éªŒå‰ææ¡ä»¶&#34;&gt;å®éªŒå‰ææ¡ä»¶&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;Linuxç³»ç»Ÿ&lt;/li&gt;
&lt;li&gt;Dockerå®¹å™¨ä½¿ç”¨é»˜è®¤çš„Logging Driverï¼Œä¹Ÿå°±æ˜¯json-file&lt;/li&gt;
&lt;li&gt;å®¹å™¨æ—¥å¿—ç›®å½•ï¼ˆä¹ŸåŒ…å«å…¶ä»–é…ç½®æ–‡ä»¶çš„ï¼‰&lt;code&gt;/var/lib/docker/containers&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;é…ç½®æ–‡ä»¶è¾“å‡ºåˆ°stdout&#34;&gt;é…ç½®æ–‡ä»¶ï¼ˆè¾“å‡ºåˆ°stdoutï¼‰&lt;/h3&gt;
&lt;p&gt;å®šä¹‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ docker.container.log.conf&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;source&amp;gt;
  @type tail
  path /var/lib/docker/containers/*/*-json.log
  pos_file /var/log/docker_container.log.pos
  tag docker.*
  refresh_interval 10
  read_from_head true
  &amp;lt;parse&amp;gt;
    @type json
  &amp;lt;/parse&amp;gt;
&amp;lt;/source&amp;gt;

&amp;lt;filter docker.var.lib.docker.containers.*.*.log&amp;gt;
  @type parser
  key_name log
  remove_key_name_field true
  &amp;lt;parse&amp;gt;
    @type json
  &amp;lt;/parse&amp;gt;
&amp;lt;/filter&amp;gt;

&amp;lt;filter docker.var.lib.docker.containers.*.*.log&amp;gt;
  @type record_transformer
  &amp;lt;record&amp;gt;
    container_id ${tag_parts[5]}
    hostname &amp;quot;#{Socket.gethostname}&amp;quot;
  &amp;lt;/record&amp;gt;
&amp;lt;/filter&amp;gt;

&amp;lt;match docker.var.lib.docker.containers.*.*.log&amp;gt;
  @type stdout
&amp;lt;/match&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;ç®€è¦ä»‹ç»&#34;&gt;ç®€è¦ä»‹ç»&lt;/h4&gt;
&lt;p&gt;ä¸€ä¸ªå…¸å‹çš„æ—¥å¿—æ”¶é›†è¿‡ç¨‹åˆ†ä¸‰éƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å®šä¹‰æ•°æ®æºï¼Œä¹Ÿå°±æ˜¯sourceéƒ¨åˆ†&lt;/li&gt;
&lt;li&gt;æ¯æ¡æ•°æ®å¯ä»¥å¢åˆ ä¿®æ”¹å­—æ®µï¼Œä¹Ÿå°±æ˜¯filteréƒ¨åˆ†ï¼Œfilterå¯ä»¥æ˜¯0ä¸ªæˆ–æ˜¯å¤šä¸ªï¼ŒæŒ‰é¡ºåºå¤„ç†ã€‚&lt;/li&gt;
&lt;li&gt;æ•°æ®è¾“å‡ºï¼Œä¹Ÿå°±æ˜¯matchéƒ¨åˆ†&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;source&#34;&gt;source&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;@type tail ä½¿ç”¨tailæ’ä»¶ &lt;a href=&#34;https://docs.fluentd.org/input/tail&#34;&gt;https://docs.fluentd.org/input/tail&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;path å®šä¹‰è·¯å¾„ï¼Œæ­£åˆ™åŒ¹é…&lt;/li&gt;
&lt;li&gt;pos_file å­˜æ”¾è¯»æ–‡ä»¶çš„offset&lt;/li&gt;
&lt;li&gt;éœ€è¦å®šä¹‰tagï¼Œfilterã€matchä½¿ç”¨tagè¿›è¡ŒåŒ¹é…ã€‚&lt;/li&gt;
&lt;li&gt;tag docker.*ï¼Œ*ä¼šè¢«å®é™…çš„æ–‡ä»¶åç»™æ›¿ä»£&lt;/li&gt;
&lt;li&gt;refresh_interval è®¾ç½®å¤šä¹…åˆ·æ–°ç›‘å¬çš„æ–‡ä»¶åˆ—è¡¨ï¼Œé»˜è®¤60ç§’&lt;/li&gt;
&lt;li&gt;read_from_head é»˜è®¤falseï¼Œä¹Ÿå°±æ˜¯ï¼Œæ²¡æœ‰poså­˜åœ¨çš„è¯ï¼Œä»æ–‡ä»¶å°¾è¯»å–ã€‚è®¾ç½®ä¸ºtrueï¼Œè§£å†³æ–°å¢æ–‡ä»¶è€Œæ–‡ä»¶åˆæ²¡è¢«fluentdåŠæ—¶ç›‘å¬èµ·æ¥çš„é—®é¢˜ã€‚&lt;/li&gt;
&lt;li&gt;parse ä½¿ç”¨jsonè§£æï¼Œå› ä¸ºdockerçš„logging driverç”¨çš„json-file&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ›´å¤šsourceæ’ä»¶è§ï¼šhttps://docs.fluentd.org/input&lt;/p&gt;
&lt;h4 id=&#34;filter&#34;&gt;filter&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;æŒ‡å®štag pattern&lt;/li&gt;
&lt;li&gt;@type parser ä½¿ç”¨parseræ’ä»¶ &lt;a href=&#34;https://docs.fluentd.org/filter/parser&#34;&gt;https://docs.fluentd.org/filter/parser&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;key_name éœ€è¦parseçš„å­—æ®µå&lt;/li&gt;
&lt;li&gt;remove_key_name_field å› ä¸ºæˆ‘ä»¬åªéœ€è¦logå­—æ®µçš„jsonå†…å®¹ï¼Œlogå­—æ®µæœ¬èº«ä¸éœ€è¦ä¿ç•™&lt;/li&gt;
&lt;li&gt;parse è§£æä¸ºjsonï¼Œå› ä¸ºæˆ‘ä»¬çš„åº”ç”¨æ—¥å¿—æ˜¯jsonæ ¼å¼è¾“å‡ºçš„&lt;/li&gt;
&lt;li&gt;@type record_transformer ä½¿ç”¨record_transformeræ’ä»¶ &lt;a href=&#34;https://docs.fluentd.org/filter/record_transformer&#34;&gt;https://docs.fluentd.org/filter/record_transformer&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;record æ–°å¢å­—æ®µ&lt;/li&gt;
&lt;li&gt;${tag_parts[5]} é¢„å®šä¹‰çš„å˜é‡ï¼Œtag_partsæ˜¯tagå­—ç¬¦ä¸²è¢«&amp;rdquo;.&amp;ldquo;åˆ‡åˆ†åçš„æ•°ç»„ï¼Œç¬¬6ä¸ªä»£è¡¨çš„æ˜¯container_id&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;quot;#{Socket.gethostname}&amp;quot;&lt;/code&gt; rubyå†…çš„å˜é‡&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æ›´å¤šfilteræ’ä»¶è§ï¼šhttps://docs.fluentd.org/filter&lt;/p&gt;
&lt;h4 id=&#34;match&#34;&gt;match&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;æŒ‡å®štag pattern&lt;/li&gt;
&lt;li&gt;@type stdout ä½¿ç”¨stdoutæ’ä»¶ï¼Œç”¨äºæ¼”ç¤º &lt;a href=&#34;https://docs.fluentd.org/output/stdout&#34;&gt;https://docs.fluentd.org/output/stdout&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;å¯åŠ¨fluentd&#34;&gt;å¯åŠ¨fluentd&lt;/h3&gt;
&lt;p&gt;æ³¨æ„æŸ¥çœ‹æ—¥å¿—ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# /opt/td-agent/embedded/bin/fluentd -c docker.container.log.conf
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;ç”Ÿæˆæ—¥å¿—&#34;&gt;ç”Ÿæˆæ—¥å¿—&lt;/h3&gt;
&lt;p&gt;JSONæ ¼å¼è¾“å‡ºæ¯ä¸€è¡Œæ—¥å¿—ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# docker run -it busybox echo &#39;{&amp;quot;user&amp;quot;:1,&amp;quot;num&amp;quot;:2}&#39;
{&amp;quot;user&amp;quot;:1,&amp;quot;num&amp;quot;:2}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è§‚å¯Ÿ &lt;code&gt;/var/lib/docker/containers/*/*-json.log&lt;/code&gt;æ—¥å¿—å†…å®¹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{&amp;quot;log&amp;quot;:&amp;quot;{\&amp;quot;user\&amp;quot;:1,\&amp;quot;num\&amp;quot;:2}\r\n&amp;quot;,&amp;quot;stream&amp;quot;:&amp;quot;stdout&amp;quot;,&amp;quot;time&amp;quot;:&amp;quot;2020-04-02T12:25:50.877037148Z&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;fluentd stdoutè¾“å‡ºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{&amp;quot;user&amp;quot;:1,&amp;quot;num&amp;quot;:2,&amp;quot;container_id&amp;quot;:&amp;quot;e4fb94ee2d067450eeaf15837ed1497e2b7eb2f6754ba4eec1792ee37e31f12f&amp;quot;,&amp;quot;hostname&amp;quot;:&amp;quot;ubuntu-parallel&amp;quot;}
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;è¾“å‡ºä»stdoutæ”¹ä¸ºelasticsearch&#34;&gt;è¾“å‡ºä»stdoutæ”¹ä¸ºelasticsearch&lt;/h3&gt;
&lt;h4 id=&#34;å¯åŠ¨es&#34;&gt;å¯åŠ¨ES&lt;/h4&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-docker.html&#34;&gt;https://www.elastic.co/guide/en/elastic-stack-get-started/current/get-started-docker.html&lt;/a&gt;ï¼Œä½¿ç”¨docker-composeå¯åŠ¨eså’ŒkibanaæœåŠ¡ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# docker-compose up
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;ä¿®æ”¹match&#34;&gt;ä¿®æ”¹match&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;match docker.var.lib.docker.containers.*.*.log&amp;gt;
  @type elasticsearch
  host localhost
  port 9200
  logstash_format true
&amp;lt;/match&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å‚è€ƒï¼šhttps://docs.fluentd.org/output/elasticsearch&lt;/p&gt;
&lt;h4 id=&#34;å¯åŠ¨fluentd-1&#34;&gt;å¯åŠ¨fluentd&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;root@ubuntu-parallel:~# /opt/td-agent/embedded/bin/fluentd -c docker.container.log.es.conf
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;kibanaæ—¥å¿—åˆ†æ&#34;&gt;kibanaæ—¥å¿—åˆ†æ&lt;/h4&gt;
&lt;p&gt;å› ä¸ºESçš„æ—¥å¿—å·²ç»æ˜¯JSONæ ¼å¼è¾“å‡ºçš„ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦é¢å¤–é€ æ•°æ®äº†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200403001746670.png&#34; alt=&#34;image-20200403001746670&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;å®¹å™¨ä¸Šä¸‹æ–‡ä¿¡æ¯&#34;&gt;å®¹å™¨ä¸Šä¸‹æ–‡ä¿¡æ¯&lt;/h3&gt;
&lt;p&gt;å¯ä»¥è€ƒè™‘è¿™ä¸ªfilteræ’ä»¶ &lt;a href=&#34;https://github.com/zsoltf/fluent-plugin-docker_metadata_elastic_filter&#34;&gt;https://github.com/zsoltf/fluent-plugin-docker_metadata_elastic_filter&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;filter docker.var.lib.docker.containers.*.*.log&amp;gt;
  type docker_metadata_elastic
&amp;lt;/filter&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æ–°å¢ docker  ç»“æ„ä½“ï¼ŒåŒ…å«é•œåƒåç§°ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{
  &amp;quot;log&amp;quot;: &amp;quot;2015/05/05 19:54:41 \n&amp;quot;,
  &amp;quot;stream&amp;quot;: &amp;quot;stderr&amp;quot;,
  &amp;quot;docker&amp;quot;: {
    &amp;quot;id&amp;quot;: &amp;quot;df14e0d5ae4c07284fa636d739c8fc2e6b52bc344658de7d3f08c36a2e804115&amp;quot;,
    &amp;quot;name&amp;quot;: &amp;quot;k8s_fabric8-console-container.efbd6e64_fabric8-console-controller-9knhj_default_8ae2f621-f360-11e4-8d12-54ee7527188d_7ec9aa3e&amp;quot;,
    &amp;quot;container_hostname&amp;quot;: &amp;quot;fabric8-console-controller-9knhj&amp;quot;,
    &amp;quot;image&amp;quot;: &amp;quot;fabric8/hawtio-kubernetes:latest&amp;quot;,
    &amp;quot;image_id&amp;quot;: &amp;quot;b2bd1a24a68356b2f30128e6e28e672c1ef92df0d9ec01ec0c7faea5d77d2303&amp;quot;,
    &amp;quot;labels&amp;quot;: {}
  }
}
&lt;/code&gt;&lt;/pre&gt;- https://xujiahua.github.io/posts/20200402-use-fluentd/ - </description>
        </item>
    
    
    
        <item>
        <title>Google Vision API</title>
        <link>https://xujiahua.github.io/posts/20200401-google-vision-api/</link>
        <pubDate>Wed, 01 Apr 2020 14:20:51 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200401-google-vision-api/</guid>
        <description>è®¸å˜‰åçš„ç¬”è®° https://xujiahua.github.io/posts/20200401-google-vision-api/ -&lt;h2 id=&#34;ç›®æ ‡&#34;&gt;ç›®æ ‡&lt;/h2&gt;
&lt;p&gt;ä¸šåŠ¡ä¸Šéœ€è¦è¯†åˆ«å‡ºæ–‡æœ¬ã€å›¾åƒæ•æ„Ÿå†…å®¹ï¼Œé™ä½ä¸šåŠ¡é£é™©ã€‚&lt;/p&gt;
&lt;p&gt;è°ƒç”¨ä¸‹äº‘æœåŠ¡çš„äº§å“ã€‚&lt;/p&gt;
&lt;h2 id=&#34;google-cloud-platform&#34;&gt;Google Cloud Platform&lt;/h2&gt;
&lt;p&gt;GCPä¸Šï¼Œå›¾åƒè¯†åˆ«æœ‰ä¸¤ä¸ªäº§å“ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Vision API ç›´æ¥ä½¿ç”¨é¢„å…ˆè®­ç»ƒçš„æ¨¡å‹&lt;/li&gt;
&lt;li&gt;AutoML è¿ç§»å­¦ä¹ ï¼Œä½¿ç”¨ç”¨æˆ·æäº¤çš„æ–°åˆ†ç±»æ•°æ®ï¼Œè®­ç»ƒæ¨¡å‹ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å…³äºæ–‡æœ¬è¯†åˆ«çš„äº§å“æ˜¯ç±»ä¼¼çš„ï¼Œä¹Ÿåˆ†ç›´æ¥ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹å’Œè¿ç§»å­¦ä¹ é‡æ–°è®­ç»ƒã€‚&lt;/p&gt;
&lt;h2 id=&#34;vision-apiå›¾åƒå†…å®¹è¯†åˆ«&#34;&gt;Vision APIï¼šå›¾åƒå†…å®¹è¯†åˆ«&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Google Vision APIçš„æ¨¡å‹å·²ç»æœ‰å®¡æ ¸å†…å®¹çš„èƒ½åŠ›ï¼šæš´åŠ›ã€æˆäººå†…å®¹çš„è¯†åˆ«ã€‚&lt;/li&gt;
&lt;li&gt;æä¾›APIï¼Œä¹Ÿæä¾›äº†å„ä¸ªè¯­è¨€çš„SDKã€‚&lt;/li&gt;
&lt;li&gt;ä¸éœ€è¦å¼€å‘è€…è®­ç»ƒæ¨¡å‹ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200401145549783.png&#34; alt=&#34;image-20200401145549783&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200401145658730.png&#34; alt=&#34;image-20200401145658730&#34;&gt;&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼šhttps://cloud.google.com/vision?hl=zh-cn&lt;/p&gt;
&lt;h3 id=&#34;è¯•ç”¨&#34;&gt;è¯•ç”¨&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200401142058025.png&#34; alt=&#34;image-20200401142058025&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;å®‰å…¨æœç´¢çš„åˆ†ç±»è¯´æ˜&#34;&gt;å®‰å…¨æœç´¢çš„åˆ†ç±»è¯´æ˜&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200401144423857.png&#34; alt=&#34;image-20200401144423857&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Adult æˆäººå†…å®¹&lt;/li&gt;
&lt;li&gt;Spoof æ¶æï¼Œæ¯”å¦‚æ¶ææ”¿æ²»äººç‰©&lt;/li&gt;
&lt;li&gt;Medical åŒ»ç–—å½±åƒ&lt;/li&gt;
&lt;li&gt;Violence æš´åŠ›å†…å®¹&lt;/li&gt;
&lt;li&gt;Racy çŒ¥äºµç±»ï¼Œç±»ä¼¼æˆäººå†…å®¹&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å‚è€ƒï¼šhttps://cloud.google.com/vision/docs/reference/rpc/google.cloud.vision.v1?hl=zh-cn#google.cloud.vision.v1.SafeSearchAnnotation&lt;/p&gt;
&lt;h3 id=&#34;å¯¹æ¥æµç¨‹&#34;&gt;å¯¹æ¥æµç¨‹&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200401143626559.png&#34; alt=&#34;image-20200401143626559&#34;&gt;&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼šhttps://codelabs.developers.google.com/codelabs/cloud-vision-intro/index.html?index=..%2F..cloudai&amp;amp;hl=zh-cn&amp;amp;_ga=2.102874504.925825070.1585721382-1910642988.1585296097#0&lt;/p&gt;
&lt;p&gt;æ³¨æ„ï¼Œå›¾åƒä¸ä¸€å®šéœ€è¦ä¸Šä¼ åˆ°Googleçš„äº‘å­˜å‚¨ã€‚&lt;/p&gt;
&lt;p&gt;å¼€å‘å¯¹æ¥å‚è€ƒï¼šæ£€æµ‹éœ²éª¨å†…å®¹ï¼ˆå®‰å…¨æœç´¢ï¼‰https://cloud.google.com/vision/docs/detecting-safe-search?hl=zh-cn&lt;/p&gt;
&lt;h3 id=&#34;demo&#34;&gt;DEMO&lt;/h3&gt;
&lt;p&gt;åˆ›å»ºæœåŠ¡è´¦å·ã€åˆ›å»ºå¯†é’¥ï¼Œè‡ªåŠ¨ä¸‹è½½jsonæ–‡ä»¶ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200401160832697.png&#34; alt=&#34;image-20200401160832697&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200401161206429.png&#34; alt=&#34;image-20200401161206429&#34;&gt;&lt;/p&gt;
&lt;p&gt;codeï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/GoogleCloudPlatform/golang-samples/blob/master/vision/detect/README.md&#34;&gt;https://github.com/GoogleCloudPlatform/golang-samples/blob/master/vision/detect/README.md&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;è¯·æ±‚æ¬¡æ•°é™åˆ¶&#34;&gt;è¯·æ±‚æ¬¡æ•°é™åˆ¶&lt;/h3&gt;
&lt;p&gt;å¯¹è¯·æ±‚å†…å®¹å¤§å°æœ‰é™åˆ¶å¤–ï¼Œéœ€è¦æ³¨æ„è¯·æ±‚é…é¢ï¼Œæ¯åˆ†é’Ÿè¯·æ±‚æ•°1800ï¼ŒQPSä¹Ÿå°±æ˜¯30ã€‚å¦‚æœæ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œéœ€è¦åœ¨å¹³å°ç”³è¯·å¢åŠ é…é¢ã€‚&lt;/p&gt;
&lt;p&gt;ä½¿ç”¨é»˜è®¤é…é¢ï¼Œä¸šåŠ¡ä¸Šéœ€è¦è€ƒè™‘é‡‡æ ·æ•°æ®ï¼Œå†è°ƒç”¨Vision APIã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒ &lt;a href=&#34;https://cloud.google.com/vision/quotas?hl=zh-cn&#34;&gt;https://cloud.google.com/vision/quotas?hl=zh-cn&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;è¯·æ±‚å“åº”æ—¶é—´&#34;&gt;è¯·æ±‚å“åº”æ—¶é—´&lt;/h3&gt;
&lt;p&gt;è¯·æ±‚å“åº”æ—¶é—´ï¼Œå–å†³äºä¸¤ä¸ªå› ç´ ï¼š&lt;/p&gt;
&lt;h4 id=&#34;ä¸Šä¼ æ•°æ®å¤§å°&#34;&gt;ä¸Šä¼ æ•°æ®å¤§å°&lt;/h4&gt;
&lt;p&gt;è¶Šå¤§è¶Šæ…¢ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ‰‹æœºæ‹ç…§è½¯ä»¶ç”Ÿæˆçš„å›¾åƒä¸€èˆ¬3Mï¼Œå»ºè®®å›¾åƒå‹ç¼©åä¸Šä¼ ã€‚&lt;/li&gt;
&lt;li&gt;è€ƒè™‘gcloudä¸Šå…ˆå­˜å‚¨å›¾åƒæ–‡ä»¶ã€‚å‚è€ƒ &lt;a href=&#34;https://medium.com/bankify-tech-blog/how-to-optimize-the-speed-of-google-vision-api-cdc5e452104b&#34;&gt;https://medium.com/bankify-tech-blog/how-to-optimize-the-speed-of-google-vision-api-cdc5e452104b&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;vision-apiæœ¬èº«&#34;&gt;Vision APIæœ¬èº«&lt;/h4&gt;
&lt;p&gt;å¯¹ä¸€å¼ 249Kçš„å›¾åƒè¿›è¡Œç®€å•å‹æµ‹ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ ll demo/trump.jpg 
-rw-r--r--  &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; jiahua  staff   249K Apr  &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; 14:14 demo/trump.jpg
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Go benchmarkã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;BenchmarkDetectSafeSearchForFile&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;b&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;testing&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;B&lt;/span&gt;) {
	&lt;span style=&#34;color:#66d9ef&#34;&gt;for&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;;&lt;span style=&#34;color:#a6e22e&#34;&gt;i&lt;/span&gt;&amp;lt;&lt;span style=&#34;color:#a6e22e&#34;&gt;b&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;N&lt;/span&gt;;&lt;span style=&#34;color:#a6e22e&#34;&gt;i&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;++&lt;/span&gt;{
		&lt;span style=&#34;color:#a6e22e&#34;&gt;result&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;DetectSafeSearchForFile&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;demo/trump.jpg&amp;#34;&lt;/span&gt;)
		&lt;span style=&#34;color:#a6e22e&#34;&gt;assert&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Equal&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;b&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt;)
		&lt;span style=&#34;color:#a6e22e&#34;&gt;spew&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Dump&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;result&lt;/span&gt;)
	}
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;è¯†åˆ«å›¾åƒå¤§æ¦‚éœ€è¦1ç§’ã€‚å®é™…ä¸šåŠ¡ä¸­ä½¿ç”¨ï¼Œå»ºè®®å¼‚æ­¥å¤„ç†ï¼Œäº‹åå¤„ç†ï¼Œä¸ç„¶å¤ªå½±å“æ­£å¸¸ä½“éªŒäº†ã€‚&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-bash&#34; data-lang=&#34;bash&#34;&gt;$ go test -v -bench&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;DetectSafeSearchForFile -benchtime&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;30s

BenchmarkDetectSafeSearchForFile-8            &lt;span style=&#34;color:#ae81ff&#34;&gt;33&lt;/span&gt;        &lt;span style=&#34;color:#ae81ff&#34;&gt;1011378355&lt;/span&gt; ns/op
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;natural-language-api-æ–‡æœ¬å†…å®¹è¯†åˆ«&#34;&gt;Natural Language APIï¼š æ–‡æœ¬å†…å®¹è¯†åˆ«&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://cloud.google.com/natural-language/docs/how-to?hl=zh-cn&#34;&gt;https://cloud.google.com/natural-language/docs/how-to?hl=zh-cn&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&#34;å†…å®¹åˆ†ç±»&#34;&gt;å†…å®¹åˆ†ç±»&lt;/h3&gt;
&lt;p&gt;å†…å®¹åˆ†ç±»æ²¡æœ‰æˆ‘ä»¬å…³æ³¨çš„æ•æ„Ÿå†…å®¹åˆ†ç±»ã€‚&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼šhttps://cloud.google.com/natural-language/docs/categories?hl=zh-cn&lt;/p&gt;
&lt;p&gt;é€šè¿‡ç®€å•çš„å…³é”®å­—è¿‡æ»¤å§ã€‚&lt;/p&gt;
- https://xujiahua.github.io/posts/20200401-google-vision-api/ - </description>
        </item>
    
    
    
        <item>
        <title>ä½¿ç”¨ Docker Machine</title>
        <link>https://xujiahua.github.io/posts/20200331-use-docker-machine/</link>
        <pubDate>Tue, 31 Mar 2020 09:53:05 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200331-use-docker-machine/</guid>
        <description>è®¸å˜‰åçš„ç¬”è®° https://xujiahua.github.io/posts/20200331-use-docker-machine/ -&lt;h2 id=&#34;ç®€ä»‹&#34;&gt;ç®€ä»‹&lt;/h2&gt;
&lt;p&gt;Docker Machine lets you create Docker hosts on your computer, on cloud providers, and inside your own data center. It creates servers, installs Docker on them, then configures the Docker client to talk to them.&lt;/p&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/docker/machine&#34;&gt;https://github.com/docker/machine&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.docker.com/machine/overview/&#34;&gt;https://docs.docker.com/machine/overview/&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;../../images/machine.png&#34; alt=&#34;Docker Machine&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;vs-vagrant&#34;&gt;vs. Vagrant&lt;/h2&gt;
&lt;h3 id=&#34;ä¸vagrantçš„äº¤é›†&#34;&gt;ä¸Vagrantçš„äº¤é›†&lt;/h3&gt;
&lt;p&gt;ç›®å‰ä½¿ç”¨ Vagrant æ­ Docker ç¯å¢ƒçš„æ­¥éª¤å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;vagrant init {box_name}ï¼Œä¸‹è½½ä¸€ä¸ªåŸºç¡€çš„è™šæ‹Ÿæœºé•œåƒï¼Œæ¯”å¦‚centosï¼Œå¹¶åˆ›å»ºä¸€ä¸ªVagrantfileã€‚&lt;/li&gt;
&lt;li&gt;Vagrantfileä¸­è®¾ç½®è™šæ‹Ÿæœºhostnameã€‚&lt;/li&gt;
&lt;li&gt;Vagrantfileä¸­è®¾ç½®Private networkï¼Œä½¿å¾—å‡ ä¸ªVMå¯ä»¥äº’ç›¸é€šä¿¡ã€‚&lt;/li&gt;
&lt;li&gt;VMå†…å®‰è£…dockerè½¯ä»¶ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¦‚æœç”¨ä¸Šäº†docker-machineï¼Œåªè¦ä¸€è¡Œå‘½ä»¤ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸Šï¼Œdocker-machine æ¯” Vagrant æ–¹ä¾¿äº†å¾ˆå¤šã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker-machine create -d virtualbox {host_name}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;VMçš„ç®¡ç†ï¼Œvagrantå‘½ä»¤éœ€è¦åœ¨Vagrantfileæ‰€åœ¨ç›®å½•æ‰§è¡Œã€‚è€Œdocker-machineå¯ä»¥åœ¨ä»»ä½•ç›®å½•ç®¡ç†VMã€‚&lt;/p&gt;
&lt;h3 id=&#34;å…¶ä»–ç‰¹è‰²&#34;&gt;å…¶ä»–ç‰¹è‰²&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;é€šè¿‡å…¶ä»–driverï¼Œå¯ä»¥å®‰è£…ç®¡ç†äº‘ä¸»æœºæˆ–æ˜¯ç§æœ‰æ•°æ®ä¸­å¿ƒï¼Œè€Œä¸ä»…ä»…æ˜¯virtualboxã€‚&lt;/li&gt;
&lt;li&gt;é€šè¿‡eval &amp;ldquo;$(docker-machine env default)&amp;quot;ï¼Œè¦†ç›–ç¯å¢ƒå˜é‡DOCKER_HOSTï¼Œä½¿å¾—æœ¬åœ°docker clientè®¿é—®VMå†…çš„docker daemonã€‚&lt;/li&gt;
&lt;li&gt;æ›´å¤šå®ç”¨å‘½ä»¤ï¼Œå‚è€ƒ &lt;a href=&#34;https://docs.docker.com/machine/get-started/&#34;&gt;https://docs.docker.com/machine/get-started/&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
- https://xujiahua.github.io/posts/20200331-use-docker-machine/ - </description>
        </item>
    
    
    
        <item>
        <title>Docker Networkå°ç»“</title>
        <link>https://xujiahua.github.io/posts/20200321-docker-network/</link>
        <pubDate>Sat, 21 Mar 2020 14:10:40 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200321-docker-network/</guid>
        <description>è®¸å˜‰åçš„ç¬”è®° https://xujiahua.github.io/posts/20200321-docker-network/ -&lt;p&gt;Dockerç½‘ç»œéå¸¸å€¼å¾—å­¦ä¹ ã€‚å¯¹Dockerä¸ç†Ÿçš„åŒå­¦ï¼Œå»ºè®®å…ˆçœ‹ä¸€äº›å…¥é—¨èµ„æ–™ã€‚&lt;/p&gt;
&lt;h2 id=&#34;docker-å­¦ä¹ èµ„æ–™&#34;&gt;Docker å­¦ä¹ èµ„æ–™&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Docker â€” ä»å…¥é—¨åˆ°å®è·µ  &lt;a href=&#34;https://www.yuque.com/grasilife/docker&#34;&gt;https://www.yuque.com/grasilife/docker&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Docker Kubernetes Lab Handbook &lt;a href=&#34;https://docker-k8s-lab.readthedocs.io/en/latest/index.html&#34;&gt;https://docker-k8s-lab.readthedocs.io/en/latest/index.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;ã€ŒDockerè¿›é˜¶ä¸å®æˆ˜ã€åä¸ºDockerå®è·µå°ç»„&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;å•æœºç½‘ç»œ&#34;&gt;å•æœºç½‘ç»œ&lt;/h2&gt;
&lt;p&gt;ï¼ˆå»ºè®®åœ¨Linuxç³»ç»Ÿä¸Šå®éªŒã€‚ï¼‰&lt;/p&gt;
&lt;p&gt;Dockerå®‰è£…å®Œåï¼Œé»˜è®¤æœ‰ä¸‰ä¸ªï¼ˆä¸‰ç§ï¼‰ç½‘ç»œã€‚åˆ†åˆ«æ˜¯é»˜è®¤çš„bridgeæ¨¡å¼ï¼Œhostæ¨¡å¼ï¼Œnoneæ¨¡å¼ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
51cbe7a9bb19        bridge              bridge              local
7182ef9fa8c4        host                host                local
bd80d0dedaa8        none                null                local
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å‚è€ƒï¼šhttps://docs.docker.com/network/&lt;/p&gt;
&lt;h3 id=&#34;noneæ¨¡å¼---netnone&#34;&gt;noneæ¨¡å¼ &amp;ndash;net=none&lt;/h3&gt;
&lt;p&gt;æ— ç½‘ç»œã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# docker run --net=none --rm -it alpine ip addr show
1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;hostæ¨¡å¼---nethost&#34;&gt;hostæ¨¡å¼ &amp;ndash;net=host&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;å®¹å™¨å…±ç”¨å®¿ä¸»æœºçš„ç½‘ç»œã€‚ä½†æ˜¯ï¼Œå®¹å™¨çš„å…¶ä»–æ–¹é¢ï¼Œå¦‚æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹åˆ—è¡¨ç­‰è¿˜æ˜¯å’Œå®¿ä¸»æœºéš”ç¦»çš„ã€‚&lt;/li&gt;
&lt;li&gt;å®¹å™¨ä¸ä¼šç”³è¯·ç‹¬ç«‹çš„IPã€‚&lt;/li&gt;
&lt;li&gt;å®¹å™¨ç”³è¯·çš„ç«¯å£å ç”¨å®¿ä¸»æœºçš„ç«¯å£èµ„æºã€‚&lt;/li&gt;
&lt;li&gt;-pç­‰ç«¯å£æ˜ å°„å‘½ä»¤ä¸èµ·ä½œç”¨ï¼šWARNING: Published ports are discarded when using host network mode&lt;/li&gt;
&lt;li&gt;æ€§èƒ½ä¸Šæ¯”è¾ƒå¥½ï¼Œå› ä¸ºæ²¡æœ‰åœ°å€è½¬æ¢ã€‚Host mode networking can be useful to optimize performance, and in situations where a container needs to handle a large range of ports, as it does not require network address translation (NAT), and no â€œuserland-proxyâ€ is created for each port.&lt;/li&gt;
&lt;li&gt;Linux ONLYã€‚The host networking driver only works on Linux hosts, and is not supported on Docker Desktop for Mac, Docker Desktop for Windows, or Docker EE for Windows Server.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;../../images/907596-20170517105727775-430532496.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.docker.com/network/host/&#34;&gt;https://docs.docker.com/network/host/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Networking using the host network &lt;a href=&#34;https://docs.docker.com/network/network-tutorial-host/&#34;&gt;https://docs.docker.com/network/network-tutorial-host/&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;å®éªŒ&#34;&gt;å®éªŒ&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# docker run --net=host --rm -it alpine ip addr show
1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eno1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc fq_codel state UP qlen 1000
    link/ether 10:7b:44:b0:b1:37 brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.106/24 brd 192.168.0.255 scope global dynamic eno1
       valid_lft 6663sec preferred_lft 6663sec
    inet6 fe80::e0c5:55dc:fba0:549b/64 scope link
       valid_lft forever preferred_lft forever
5: docker0: &amp;lt;NO-CARRIER,BROADCAST,MULTICAST,UP&amp;gt; mtu 1500 qdisc noqueue state DOWN
    link/ether 02:42:8c:6e:08:4d brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:8cff:fe6e:84d/64 scope link
       valid_lft forever preferred_lft forever

# ip addr show
1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eno1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 10:7b:44:b0:b1:37 brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.106/24 brd 192.168.0.255 scope global dynamic noprefixroute eno1
       valid_lft 6619sec preferred_lft 6619sec
    inet6 fe80::e0c5:55dc:fba0:549b/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
5: docker0: &amp;lt;NO-CARRIER,BROADCAST,MULTICAST,UP&amp;gt; mtu 1500 qdisc noqueue state DOWN group default
    link/ether 02:42:8c:6e:08:4d brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:8cff:fe6e:84d/64 scope link
       valid_lft forever preferred_lft forever
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å®¹å™¨åªæ˜¯éš”ç¦»é™¤äº†ç½‘ç»œä¹‹å¤–çš„èµ„æºã€‚å› ä¸ºä½¿ç”¨äº†å®¿ä¸»æœºçš„ç½‘ç»œï¼Œæ‰€ä»¥å®¹å™¨è¿›ç¨‹å¯ä»¥ä¸å…¶ä»–ä¸»æœºè¿›ç¨‹äº’ç›¸é€šä¿¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ç«¯å£å†²çªçš„é—®é¢˜ï¼Œä»¥åŠå®‰å…¨çš„é—®é¢˜ï¼ˆå…±ç”¨äº†å®¿ä¸»æœºçš„èµ„æºï¼‰ã€‚&lt;/p&gt;
&lt;h3 id=&#34;bridgeæ¨¡å¼---netname_it_youself&#34;&gt;bridgeæ¨¡å¼ &amp;ndash;net={name_it_youself}&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;Dockeré»˜è®¤çš„ç½‘ç»œæ¨¡å¼ã€‚ä¸åŠ &amp;ndash;netå‚æ•°ï¼Œå°±é»˜è®¤é‡‡ç”¨è¿™ç§ç½‘ç»œæ¨¡å¼ã€‚&lt;/li&gt;
&lt;li&gt;ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿç½‘ç»œã€‚&lt;/li&gt;
&lt;li&gt;å®¿ä¸»æœºç½‘ç»œå¯¹å®¹å™¨ç½‘ç»œæ˜¯æ— æ„ŸçŸ¥çš„ï¼Œéœ€è¦è®©å®¹å™¨çš„è¿›ç¨‹ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºçš„ç«¯å£ä¸Šï¼ŒåŒæ ·ï¼Œæ˜ å°„éœ€è¦æ³¨æ„ç«¯å£å†²çªçš„é—®é¢˜ã€‚&lt;/li&gt;
&lt;li&gt;æ¯ä¸ªContaineréƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„IPã€‚&lt;code&gt;docker network inspect bridge&lt;/code&gt; å¯æŸ¥çœ‹ã€‚&lt;/li&gt;
&lt;li&gt;åŒä¸€ä¸ªè™šæ‹Ÿç½‘ç»œä¸‹çš„å®¹å™¨å¯ä»¥äº’ç›¸é€šä¿¡ã€‚&lt;/li&gt;
&lt;li&gt;å®¹å™¨å¯ä¸å®¿ä¸»æœºé€šä¿¡ã€‚&lt;/li&gt;
&lt;li&gt;å®¹å™¨å¯é€šè¿‡å®¿ä¸»æœºä¸å…¶ä»–ç½‘ç»œé€šä¿¡ã€‚åªè¦å®¿ä¸»æœºèƒ½åˆ°ï¼Œå®¹å™¨å°±èƒ½åˆ°ã€‚æœ‰ç‚¹åƒæ˜¯VMWareä¸­çš„NATæ¨¡å¼ã€‚åŒæ ·å«bridgeï¼ŒVMWareçš„bridgeæ¨¡å¼è·ŸDocker bridgeå®Œå…¨ä¸åŒã€‚&lt;/li&gt;
&lt;li&gt;åˆ›å»ºä¸€ä¸ªæ–°çš„bridgeï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å­ç½‘ã€‚&lt;code&gt;docker network create -d bridge my_bridge&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;æ¡¥æ¥ç½‘ç»œåªå¯¹ä¸€ä¸ªDocker daemon hostä¸Šçš„å®¹å™¨ç®¡ç”¨ï¼Œå¤šæœºå°±ä¸è¡Œäº†ï¼Œdocker-composeä¹Ÿåªèƒ½åœ¨å•æœºä¸Šè·‘ï¼Œç”Ÿäº§æ²¡æ³•ç”¨ã€‚Bridge networks apply to containers running on the &lt;strong&gt;same Docker daemon host&lt;/strong&gt;. For communication among containers running on different Docker daemon hosts, you can either manage routing at the OS level, or you can use an overlay network.&lt;/li&gt;
&lt;li&gt;å»ºè®®ä½¿ç”¨è‡ªå®šä¹‰çš„bridgeç½‘ç»œã€‚&lt;/li&gt;
&lt;li&gt;æœ€å®ç”¨çš„ï¼Œè‡ªå®šä¹‰ç½‘ç»œå¯ä»¥é€šè¿‡å®¹å™¨åç§°è€Œä¸æ˜¯IPä¸å…¶ä»–å®¹å™¨é€šä¿¡ï¼Œè€Œé»˜è®¤ç½‘ç»œåªèƒ½é€šè¿‡IPã€‚User-defined bridges provide automatic DNS resolution between containers.&lt;/li&gt;
&lt;li&gt;User-defined bridges provide better isolation.&lt;/li&gt;
&lt;li&gt;Containers can be attached and detached from user-defined networks on the fly.&lt;/li&gt;
&lt;li&gt;ç½‘ç»œæ‹“æ‰‘å¦‚ä¸‹ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;../../images/bridge_network.jpg&#34; alt=&#34;â€œdocker bridge networkâ€çš„å›¾ç‰‡æœç´¢ç»“æœ&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;å‚è€ƒ-1&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&#34;https://docs.docker.com/network/bridge/&#34;&gt;https://docs.docker.com/network/bridge/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Networking with standalone containers &lt;a href=&#34;https://docs.docker.com/network/network-tutorial-standalone/&#34;&gt;https://docs.docker.com/network/network-tutorial-standalone/&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;å®éªŒ-1&#34;&gt;å®éªŒ&lt;/h4&gt;
&lt;p&gt;TODO&lt;/p&gt;
&lt;h3 id=&#34;å®¹å™¨æ¨¡å¼---netcontainerbase_container&#34;&gt;å®¹å™¨æ¨¡å¼ &amp;ndash;net=container:base_container&lt;/h3&gt;
&lt;p&gt;å…±ç”¨å…¶ä»–å®¹å™¨çš„ç½‘ç»œæ ˆï¼Œå…¶ä»–èµ„æºå®¹å™¨éš”ç¦»ã€‚è¿™ä¸ªåœ¨Service Meshçš„åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/907596-20170517110100869-2022531474.jpg&#34; alt=&#34;img&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;å®éªŒ-2&#34;&gt;å®éªŒ&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# docker run -it --name=base_container alpine /bin/ash
/ # ip addr show
1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
8: eth0@if9: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&amp;gt; mtu 1500 qdisc noqueue state UP
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
       

# docker run --net=container:base_container --rm -it alpine ip addr show
1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
8: eth0@if9: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&amp;gt; mtu 1500 qdisc noqueue state UP
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever

&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;è·¨ä¸»æœºç½‘ç»œ&#34;&gt;è·¨ä¸»æœºç½‘ç»œ&lt;/h2&gt;
&lt;p&gt;githubä¸Šæœç´¢æœ‰å…³Container networkingçš„é¡¹ç›®ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200330115410819.png&#34; alt=&#34;image-20200330115410819&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;docker-overlay&#34;&gt;Docker Overlay&lt;/h3&gt;
&lt;p&gt;å®˜æ–¹æä¾›çš„æ–¹æ¡ˆã€‚ä¹‹å‰æ˜¯éœ€è¦etcdè¾…åŠ©çš„ã€‚Docker Engine 1.12 integrated the control plane state into Docker Engine so that an external store is no longer required.&lt;/p&gt;
&lt;h3 id=&#34;weave&#34;&gt;Weave&lt;/h3&gt;
&lt;p&gt;Weave Net creates a virtual network that connects Docker containers across multiple hosts and enables their automatic discovery.  å‚è€ƒï¼šhttps://www.weave.works/docs/net/latest/overview/&lt;/p&gt;
&lt;p&gt;åŸç†æ˜¯æ‰€æœ‰å®¹å™¨éƒ½è¿å…¥ä¸€ä¸ªè™šæ‹Ÿç½‘ç»œ weave networkï¼Œæ‰€æœ‰åŠ å…¥è¿™ä¸ªç½‘ç»œçš„å®¹å™¨éƒ½æœ‰ä¸€å—weaveç½‘å¡ã€‚è¦æ±‚æ¯å°å®¿ä¸»æœºå¯åŠ¨weaveã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/weave1.png&#34; alt=&#34;ä½¿ç”¨Weave å®ç°Docker å¤šå®¿ä¸»æœºäº’è”- è¿ç»´ä¹‹ç¾&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;å®éªŒ-3&#34;&gt;å®éªŒ&lt;/h4&gt;
&lt;p&gt;å®éªŒå‚è€ƒï¼šhttps://www.weave.works/docs/net/latest/install/using-weave/&lt;/p&gt;
&lt;p&gt;Dockerå¯ä»¥é€šè¿‡æ’ä»¶å½¢å¼æ¥é›†æˆå…¶ä»–ç½‘ç»œé©±åŠ¨ã€‚çœ‹è¯´æ˜weaveè¯´æ˜ï¼Œè¿™ç§åªé€‚åˆSwarmæ¨¡å¼ã€‚æ‰€ä»¥æˆ‘ä»¬å®éªŒä¸é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚Before using the plugin, please keep in mind the plugin works only in Swarm mode and requires Docker version 1.13 or later. &lt;a href=&#34;https://www.weave.works/docs/net/latest/install/plugin/plugin-v2/&#34;&gt;https://www.weave.works/docs/net/latest/install/plugin/plugin-v2/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;è™šæ‹Ÿæœºç¯å¢ƒæ­å»ºï¼Œåˆ›å»ºä¸¤å°è™šæ‹Ÿæœºã€‚æ³¨æ„åœ¨åŒä¸€ä¸ªç½‘ç»œä¸‹ã€‚å‚è€ƒï¼šhttps://www.vagrantup.com/docs/networking/private_network.html&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;vagrant init centos/7
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;ï¼ˆå¿«é€Ÿï¼‰å®‰è£…Dockerã€‚å‚è€ƒï¼šhttps://www.yuque.com/grasilife/docker/install-centos#ccbf609c&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# curl -fsSL get.docker.com -o get-docker.sh
# sh get-docker.sh --mirror Aliyun
# systemctl enable docker
# systemctl start docker
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å®‰è£…weaveã€‚å‚è€ƒï¼šhttps://www.weave.works/docs/net/latest/install/installing-weave/&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# curl -L git.io/weave -o /usr/bin/weave
# chmod a+x /usr/bin/weave
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;weaveç½‘ç»œå¯åŠ¨ï¼Œç½‘ç»œçš„åˆ†é…å°†æœ‰weaveæ¥å¤„ç†ã€‚&lt;code&gt;eval $(weave env)&lt;/code&gt; è¦†ç›–äº† DOCKER_HOST ä¸º unix:///var/run/weave/weave.sockã€‚ç›¸å½“äºåŠ«æŒäº†dockerå®¢æˆ·ç«¯ä¸docker daemonçš„é€šä¿¡ã€‚å‚è€ƒï¼šhttps://www.youtube.com/watch?v=kihQCCT1ykE&amp;amp;feature=youtu.be&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@host2 vagrant]# weave launch
[root@host2 vagrant]# eval $(weave env)

# join host2
[root@host1 vagrant]# weave launch $host2
[root@host1 vagrant]# eval $(weave env)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è¿é€šæµ‹è¯•ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# start tcp server on container in host2
[root@host2 vagrant]# docker run --name hello busybox nc -lp 8888

# ping from container in host1 to container in host2
[root@host1 vagrant]# docker run --rm -it busybox ping hello
PING hello (10.32.0.1): 56 data bytes
64 bytes from 10.32.0.1: seq=0 ttl=64 time=3.936 ms
64 bytes from 10.32.0.1: seq=1 ttl=64 time=0.616 ms

# tcp test from container in host1 to container in host2
[root@host1 vagrant]# docker run --rm -it busybox sh
/ # echo &amp;quot;hello world!&amp;quot; | nc hello 8888
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;æŸ¥çœ‹å®¹å™¨ç½‘å¡ï¼Œèƒ½çœ‹åˆ°ethweç½‘å¡ï¼Œä¸weaveæœ‰å…³ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[root@host2 vagrant]# docker run --rm busybox ip addr
1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
41: eth0@if42: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&amp;gt; mtu 1500 qdisc noqueue
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
43: ethwe@if44: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&amp;gt; mtu 1376 qdisc noqueue
    link/ether ca:97:90:14:18:5e brd ff:ff:ff:ff:ff:ff
    inet 10.32.0.2/12 brd 10.47.255.255 scope global ethwe
       valid_lft forever preferred_lft forever

[root@host1 vagrant]# docker run --rm busybox ip addr
1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
29: eth0@if30: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&amp;gt; mtu 1500 qdisc noqueue
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
31: ethwe@if32: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&amp;gt; mtu 1376 qdisc noqueue
    link/ether da:f2:40:0a:1e:d7 brd ff:ff:ff:ff:ff:ff
    inet 10.44.0.0/12 brd 10.47.255.255 scope global ethwe
       valid_lft forever preferred_lft forever
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;æ€»ç»“ä¸‹weaveç‰¹ç‚¹&#34;&gt;æ€»ç»“ä¸‹Weaveç‰¹ç‚¹&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;é€šè¿‡åŠ«æŒDocker clientä¸daemonçš„æ–¹å¼å·¥ä½œã€‚&lt;/li&gt;
&lt;li&gt;åˆ›å»ºå®¹å™¨çš„è¯·æ±‚è¢«åŠ«æŒï¼Œweaveä¸ºå®¹å™¨æ³¨å…¥äº†weaveç½‘ç»œã€‚&lt;/li&gt;
&lt;li&gt;ä¸ä¾èµ–etcdæˆ–æ˜¯consulç­‰kvæ•°æ®åº“ã€‚&lt;/li&gt;
&lt;li&gt;é›†ç¾¤æ‰©å®¹ï¼Œå¢åŠ å®¿ä¸»æœºï¼Œéœ€è¦å°†å®¿ä¸»æœºé…ç½®ä¸ºweaveèŠ‚ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;å®¹å™¨éƒ¨ç½²ï¼Œæ ¹æ®èµ„æºåˆ©ç”¨ç‡ï¼Œéƒ¨ç½²åˆ°å“ªä¸ªå®¿ä¸»æœºèŠ‚ç‚¹ã€‚æ²¡æœ‰å®¹å™¨ç¼–æ’å·¥å…·ï¼Œæ¯”å¦‚Kubernetesï¼Œè¿˜æ˜¯æŒºä¸æ–¹ä¾¿çš„ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;flannel&#34;&gt;Flannel&lt;/h3&gt;
&lt;p&gt;Flannelä¸ºæ¯ä¸ªhoståˆ†é…ä¸€ä¸ªsubnetï¼Œå®¹å™¨ä»subnetä¸­åˆ†é…IPï¼Œè¿™äº›IPå¯ä»¥åœ¨hosté—´è·¯ç”±ï¼Œå®¹å™¨é—´æ— éœ€ä½¿ç”¨natå’Œç«¯å£æ˜ å°„å³å¯å®ç°è·¨ä¸»æœºé€šä¿¡ã€‚æ¯ä¸ªsubnetéƒ½æ˜¯ä»ä¸€ä¸ªæ›´å¤§çš„IPæ± ä¸­åˆ’åˆ†çš„ï¼Œflannelä¼šåœ¨æ¯ä¸ªä¸»æœºä¸Šè¿flanneldçš„agentï¼Œè´Ÿè´£ä»æ± å­ä¸­åˆ†é…subnetã€‚&lt;/p&gt;
&lt;p&gt;Flannelä½¿ç”¨etcdå­˜æ”¾ç½‘ç»œé…ç½®ã€å·²åˆ†é…çš„subnetã€hostçš„IPç­‰ä¿¡æ¯ï¼ŒFlannelæ•°æ®åŒ…åœ¨ä¸»æœºé—´è½¬å‘æ˜¯ç”±backendå®ç°çš„ï¼Œç›®å‰å·²ç»æ”¯æŒUDPã€VxLANã€host-gwã€AWS VPCå’ŒGCEè·¯ç”±ç­‰å¤šç§backendã€‚https://www.cnblogs.com/itzgr/p/10172004.html&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/docker-flannel.png&#34; alt=&#34;../_images/docker-flannel.png&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;å®éªŒ-4&#34;&gt;å®éªŒ&lt;/h4&gt;
&lt;p&gt;ä½¿ç”¨docker-machineåˆ›å»ºäº†ä¸‰å°è™šæ‹Ÿæœºã€‚&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;èŠ‚ç‚¹&lt;/th&gt;
&lt;th&gt;IP&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;etcd&lt;/td&gt;
&lt;td&gt;192.168.99.105&lt;/td&gt;
&lt;td&gt;å®‰è£…etcd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;node01&lt;/td&gt;
&lt;td&gt;192.168.99.108&lt;/td&gt;
&lt;td&gt;å®‰è£…docker, flannel&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;node02&lt;/td&gt;
&lt;td&gt;192.168.99.109&lt;/td&gt;
&lt;td&gt;å®‰è£…docker, flannel&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;å‚è€ƒï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Multi-Host Networking Overlay with Flannel &lt;a href=&#34;https://docker-k8s-lab.readthedocs.io/en/latest/docker/docker-flannel.html&#34;&gt;https://docker-k8s-lab.readthedocs.io/en/latest/docker/docker-flannel.html&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Running flannel &lt;a href=&#34;https://github.com/coreos/flannel/blob/master/Documentation/running.md&#34;&gt;https://github.com/coreos/flannel/blob/master/Documentation/running.md&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;etcdé›†ç¾¤æ­å»ºï¼Œéœ€è¦å…¼å®¹etcd2ï¼Œå› ä¸ºflannelä¾èµ–etcd2ã€‚https://github.com/coreos/flannel/issues/1191&lt;/p&gt;
&lt;p&gt;é…ç½®ä¸€ä¸ªç½‘æ®µï¼Œå†™å…¥etcdã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker@etcd01:~$ etcd -listen-client-urls=&amp;quot;http://0.0.0.0:2379&amp;quot; --advertise-client-urls=&amp;quot;http://192.168.99.105:2379&amp;quot; --enable-v2

docker@etcd01:~$ ETCDCTL_API=2 etcdctl set /coreos.com/network/config &#39;{ &amp;quot;Network&amp;quot;: &amp;quot;10.5.0.0/16&amp;quot;, &amp;quot;Backend&amp;quot;: {&amp;quot;Type&amp;quot;: &amp;quot;vxlan&amp;quot;}}&#39;

docker@etcd01:~$ ETCDCTL_API=2 etcdctl get /coreos.com/network/config
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;flanneldä¼šè¯»å–etcdé…ç½®ï¼Œå¹¶ä¸ºè¯¥ä¸»æœºåˆ†é…å­ç½‘æ®µã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@node01:~# ./flanneld-amd64 -etcd-endpoints=&amp;quot;http://192.168.99.105:2379&amp;quot; -iface=192.168.99.108
&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code&gt;root@node02:~# ./flanneld-amd64 -etcd-endpoints=&amp;quot;http://192.168.99.105:2379&amp;quot; -iface=192.168.99.109
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¯ä»¥çœ‹åˆ°ï¼Œä¸»æœºä¸Šæœ‰äº†æ–°ç½‘å¡ï¼Œå­ç½‘æ®µä¹Ÿä¼šå†™å…¥etcdã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker@etcd01:~$ ETCDCTL_API=2 etcdctl ls /coreos.com/network/subnets
/coreos.com/network/subnets/10.5.94.0-24
/coreos.com/network/subnets/10.5.90.0-24
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;é…ç½®docker daemonå‚æ•°ï¼Œboot2docker linuxé…ç½®å¦‚ä¸‹ï¼šå‚è€ƒ &lt;a href=&#34;https://github.com/boot2docker/boot2docker/issues/508&#34;&gt;https://github.com/boot2docker/boot2docker/issues/508&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;node01é‡æ–°é…ç½®docker daemonï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@node01:~# /etc/init.d/docker stop
Stopping dockerd (5350)

root@node01:~# source /run/flannel/subnet.env

root@node01:~# echo EXTRA_ARGS=\&amp;quot;--bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU}\&amp;quot; &amp;gt;&amp;gt; /var/lib/boot2docker/profile
root@node01:~# cat /var/lib/boot2docker/profile

EXTRA_ARGS=&#39;
--label provider=virtualbox

&#39;
CACERT=/var/lib/boot2docker/ca.pem
DOCKER_HOST=&#39;-H tcp://0.0.0.0:2376&#39;
DOCKER_STORAGE=overlay2
DOCKER_TLS=auto
SERVERKEY=/var/lib/boot2docker/server-key.pem
SERVERCERT=/var/lib/boot2docker/server.pem

EXTRA_ARGS=&amp;quot;--bip=10.5.94.1/24 --mtu=1450&amp;quot;

root@node01:~# /etc/init.d/docker start
Starting dockerd
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;node02é‡æ–°é…ç½®docker daemonï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@node02:~# /etc/init.d/docker stop
Stopping dockerd (2624)

root@node02:~# source /run/flannel/subnet.env

root@node02:~# echo EXTRA_ARGS=\&amp;quot;--bip=${FLANNEL_SUBNET} --mtu=${FLANNEL_MTU}\&amp;quot; &amp;gt;&amp;gt; /var/lib/boot2docker/profile
root@node02:~# cat /var/lib/boot2docker/profile

EXTRA_ARGS=&#39;
--label provider=virtualbox

&#39;
CACERT=/var/lib/boot2docker/ca.pem
DOCKER_HOST=&#39;-H tcp://0.0.0.0:2376&#39;
DOCKER_STORAGE=overlay2
DOCKER_TLS=auto
SERVERKEY=/var/lib/boot2docker/server-key.pem
SERVERCERT=/var/lib/boot2docker/server.pem


EXTRA_ARGS=&amp;quot;--bip=10.5.90.1/24 --mtu=1450&amp;quot;

root@node02:~# /etc/init.d/docker start
Starting dockerd
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;è¿é€šæµ‹è¯•ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@node01:~# docker run -it busybox
/ # ip a
1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: sit0@NONE: &amp;lt;NOARP&amp;gt; mtu 1480 qdisc noop qlen 1000
    link/sit 0.0.0.0 brd 0.0.0.0
10: eth0@if11: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&amp;gt; mtu 1450 qdisc noqueue
    link/ether 02:42:0a:05:5e:02 brd ff:ff:ff:ff:ff:ff
    inet 10.5.94.2/24 brd 10.5.94.255 scope global eth0
       valid_lft forever preferred_lft forever
/ # nc -lp 8888

root@node02:~# docker run -it busybox
/ # ip a
1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu 65536 qdisc noqueue qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: sit0@NONE: &amp;lt;NOARP&amp;gt; mtu 1480 qdisc noop qlen 1000
    link/sit 0.0.0.0 brd 0.0.0.0
10: eth0@if11: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&amp;gt; mtu 1450 qdisc noqueue
    link/ether 02:42:0a:05:5a:02 brd ff:ff:ff:ff:ff:ff
    inet 10.5.90.2/24 brd 10.5.90.255 scope global eth0
       valid_lft forever preferred_lft forever
/ # echo &amp;quot;hello world!&amp;quot; | nc 10.5.94.2 8888
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;æ€»ç»“flannelç‰¹ç‚¹&#34;&gt;æ€»ç»“Flannelç‰¹ç‚¹&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;ä¾èµ–etcd2ï¼Œåœ¨Kubernetesç¯å¢ƒé‡Œä¾èµ–Kubernetes APIï¼ˆå°è£…etcdï¼‰ã€‚å­˜å‚¨ç½‘æ®µä¸è·¯ç”±è¡¨ï¼Ÿ&lt;/li&gt;
&lt;li&gt;ä¸ä¾µå…¥dockerå®¹å™¨ã€‚è¿™æ˜¯æ¯”weaveä¼˜é›…çš„åœ°æ–¹ã€‚&lt;/li&gt;
&lt;li&gt;æ•´ä½“æ€è·¯ï¼Œå…ˆåˆ’åˆ†ä¸€ä¸ªå¤§çš„ç½‘æ®µï¼Œä¸ºæ¯å°åŠ å…¥çš„ä¸»æœºä»å¤§çš„ç½‘æ®µé‡Œåˆ†é…å°çš„ç½‘æ®µï¼Œä¸ºdockerå®¹å™¨ä»å°ç½‘æ®µé‡Œåˆ†é…IPã€‚&lt;/li&gt;
&lt;/ol&gt;
- https://xujiahua.github.io/posts/20200321-docker-network/ - </description>
        </item>
    
    
    
        <item>
        <title>Go Web é¡¹ç›®æ¡†æ¶</title>
        <link>https://xujiahua.github.io/posts/20200320-go-web-project/</link>
        <pubDate>Fri, 20 Mar 2020 15:24:22 +0800</pubDate>
        
        <guid>https://xujiahua.github.io/posts/20200320-go-web-project/</guid>
        <description>è®¸å˜‰åçš„ç¬”è®° https://xujiahua.github.io/posts/20200320-go-web-project/ -&lt;h2 id=&#34;å¸¸ç”¨å¼€æºåº“&#34;&gt;å¸¸ç”¨å¼€æºåº“&lt;/h2&gt;
&lt;h3 id=&#34;ä¾èµ–åŒ…ç®¡ç†-go-modules&#34;&gt;ä¾èµ–åŒ…ç®¡ç† Go Modules&lt;/h3&gt;
&lt;p&gt;Go Modulesã€‚Go ä»1.11ç‰ˆæœ¬å¼€å§‹æ”¯æŒï¼ŒGo 1.14è¢«è®¤ä¸ºæ˜¯ç”Ÿäº§å¯ç”¨äº†ã€‚ä¸ªäººç”¨è¿‡æœ€æ–¹ä¾¿çš„Goä¾èµ–åŒ…ç®¡ç†å·¥å…·äº†ã€‚&lt;/p&gt;
&lt;p&gt;ç‰ˆæœ¬ç®¡ç†ä¸­ç»´æŠ¤ &lt;code&gt;go.mod&lt;/code&gt;/&lt;code&gt;go.sum&lt;/code&gt; ä¸¤ä¸ªæ–‡ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200320152954581.png&#34; alt=&#34;image-20200320152954581&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;å‚è€ƒ&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;Using Go Modules &lt;a href=&#34;https://blog.golang.org/using-go-modules&#34;&gt;https://blog.golang.org/using-go-modules&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;å‘½ä»¤è¡Œæ¡†æ¶-corba&#34;&gt;å‘½ä»¤è¡Œæ¡†æ¶ Corba&lt;/h3&gt;
&lt;p&gt;Corbaã€‚ç¬¬ä¸€æ¬¡çœ‹åˆ°ï¼Œæ˜¯åœ¨ç¿»çœ‹ Hyperledger Fabric çš„æ—¶å€™ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/ad566232-814f-11e5-9cd0-aa101788c117.png&#34; alt=&#34;cobra logo&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å­å‘½ä»¤ï¼ŒåµŒå¥—çš„å­å‘½ä»¤ã€‚&lt;/li&gt;
&lt;li&gt;å¢å¼ºç‰ˆæœ¬çš„flagsã€‚&lt;/li&gt;
&lt;li&gt;é¡¹ç›®æ¨¡æ¿çš„ç”Ÿæˆå·¥å…·ã€‚&lt;/li&gt;
&lt;li&gt;ç”Ÿæˆå·¥å…·ä¹Ÿè‡ªåŠ¨å¼•å…¥äº†Viperè¿™ä¸ªåŒ…ã€‚Corbaä¸Viperç”±ä¸€ä¸ªä½œè€…å¼€å‘ï¼Œä¸¤ä¸ªé¡¹ç›®é…åˆä½¿ç”¨éå¸¸æ–¹ä¾¿ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å»ºè®®ä½¿ç”¨Cobraå‘½ä»¤è¡Œå·¥å…·ç”Ÿæˆé¡¹ç›®æ¨¡æ¿ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  â–¾ appName/
    â–¾ cmd/
        add.go
        your.go
        commands.go
        here.go
      main.go
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;å‚è€ƒ-1&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;A Commander for modern Go CLI interactions &lt;a href=&#34;https://github.com/spf13/cobra&#34;&gt;https://github.com/spf13/cobra&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Cobra Generator &lt;a href=&#34;https://github.com/spf13/cobra/blob/master/cobra/README.md&#34;&gt;https://github.com/spf13/cobra/blob/master/cobra/README.md&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;é…ç½®ç®¡ç†-viper&#34;&gt;é…ç½®ç®¡ç† Viper&lt;/h3&gt;
&lt;p&gt;Viperã€‚å¸¸å¸¸ä¸Corbaæ­é…ä½¿ç”¨ã€‚æŠ„ä¸€æ®µå®˜æ–¹ç®€ä»‹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/998df88a-8151-11e5-9448-4736db51020d.png&#34; alt=&#34;viper logo&#34;&gt;&lt;/p&gt;
&lt;p&gt;Viper is a complete configuration solution for Go applications including 12-Factor apps. It is designed to work within an application, and can handle all types of configuration needs and formats. It supports:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;setting defaults è®¾ç½®é»˜è®¤å€¼ã€‚ç¤ºä¾‹ï¼š&lt;code&gt;viper.SetDefault(&amp;quot;subject&amp;quot;, &amp;quot;World&amp;quot;)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;reading from JSON, TOML, YAML, HCL, envfile and Java properties config files æ”¯æŒå„ç§é…ç½®æ–‡ä»¶æ ¼å¼ï¼ŒTOMLæ¯”è¾ƒåˆæˆ‘å£å‘³ã€‚åœ¨ä½¿ç”¨viperä¹‹å‰çš„é…ç½®æ–‡ä»¶è¯»å–æ–¹å¼ï¼Œä¸€èˆ¬éƒ½æ˜¯é…ç½®æ–‡ä»¶å¯¹åº”ä¸€ä¸ªGoçš„modelï¼Œé€šè¿‡ååºåˆ—åŒ–è¯»å…¥ç¨‹åºã€‚ç°åœ¨çœ‹æ¥éå¸¸ç²—ç³™ã€‚&lt;/li&gt;
&lt;li&gt;live watching and re-reading of config files (optional)&lt;/li&gt;
&lt;li&gt;reading from environment variables è¯»å–ç¯å¢ƒå˜é‡ã€‚ä»£ç å’Œé…ç½®ä¸¥æ ¼åˆ†ç¦»ï¼Œé…ç½®æ–‡ä»¶ç®—æ˜¯ä¸€ç§ä¸é”™çš„é€‰æ‹©ï¼Œ12-Factoræ›´æ¨èå°†åº”ç”¨çš„é…ç½®å­˜å‚¨äºç¯å¢ƒå˜é‡ä¸­ï¼Œå‚è€ƒï¼šhttps://12factor.net/zh_cn/config&lt;/li&gt;
&lt;li&gt;reading from remote config systems (etcd or Consul), and watching changes è¯»é…ç½®ä¸­å¿ƒã€‚&lt;/li&gt;
&lt;li&gt;reading from command line flags ç¤ºä¾‹ï¼š&lt;code&gt;viper.BindPFlag(&amp;quot;subject&amp;quot;, helloCmd.Flags().Lookup(&amp;quot;subject&amp;quot;))&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;reading from buffer&lt;/li&gt;
&lt;li&gt;setting explicit values&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Viper can be thought of as a registry for all of your applications configuration needs.&lt;/p&gt;
&lt;h4 id=&#34;å…³äºè¯»ç¯å¢ƒå˜é‡&#34;&gt;å…³äºè¯»ç¯å¢ƒå˜é‡&lt;/h4&gt;
&lt;p&gt;AutomaticEnv is a powerful helper especially when combined with SetEnvPrefix. When called, Viper will check for an environment variable any time a viper.Get request is made. &lt;strong&gt;It will apply the following rules. It will check for a environment variable with a name matching the key uppercased&lt;/strong&gt; and prefixed with the EnvPrefix if set.&lt;/p&gt;
&lt;p&gt;ç¯å¢ƒå˜é‡åæ˜¯æœ‰è¦æ±‚çš„ï¼Œé»˜è®¤æ˜¯å¤§å†™+ä¸‹åˆ’çº¿ç»„åˆã€‚å¦‚æœè®¾ç½®äº†EnvPrefixï¼Œç¯å¢ƒå˜é‡åéœ€è¦åŠ ä¸Šå‰ç¼€åŠ ä¸‹åˆ’çº¿ã€‚&lt;/p&gt;
&lt;p&gt;vip.GetXXX(var) è¿™é‡Œçš„varå€’æ˜¯å¤§å°å†™éšæ„çš„ï¼Œå› ä¸ºviperå†…éƒ¨ç»Ÿä¸€å°å†™å¤„ç†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200321181144230.png&#34; alt=&#34;image-20200321181144230&#34;&gt;&lt;/p&gt;
&lt;p&gt;å¦‚æœç¯å¢ƒå˜é‡åå¹¶ä¸æ»¡è¶³ç»„åˆæ€ä¹ˆåŠå‘¢ã€‚ä½¿ç”¨BindEnvï¼Œç»‘å®škeyä¸ç¯å¢ƒå˜é‡åä¹‹é—´çš„å…³ç³»ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„çº¦å®šã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;BindEnv&lt;/code&gt; takes one or two parameters. The first parameter is the key name, the second is the name of the environment variable. The name of the environment variable is case sensitive. If the ENV variable name is not provided, then Viper will automatically assume that the ENV variable matches the following format: prefix + &amp;ldquo;_&amp;rdquo; + the key name in ALL CAPS. &lt;strong&gt;When you explicitly provide the ENV variable name (the second parameter), it does not automatically add the prefix.&lt;/strong&gt; For example if the second parameter is &amp;ldquo;id&amp;rdquo;, Viper will look for the ENV variable &amp;ldquo;ID&amp;rdquo;.&lt;/p&gt;
&lt;h4 id=&#34;å‚è€ƒ-2&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;Go configuration with fangs &lt;a href=&#34;https://github.com/spf13/viper&#34;&gt;https://github.com/spf13/viper&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;æ—¥å¿—-logrus&#34;&gt;æ—¥å¿— logrus&lt;/h3&gt;
&lt;p&gt;Logrusæä¾›çš„æ—¥å¿—åŠŸèƒ½å¾ˆä¸°å¯Œã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/687474703a2f2f692e696d6775722e636f6d2f68546556776d4a2e706e67.png&#34; alt=&#34;:walrus:&#34;&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;JSONã€TEXTæ ¼å¼è¾“å‡ºã€‚JSONå¾ˆæ–¹ä¾¿è§£æï¼Œé…åˆESå­˜å‚¨æ—¥å¿—ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h4 id=&#34;å‚è€ƒ-3&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;Structured, pluggable logging for Go. &lt;a href=&#34;https://github.com/sirupsen/logrus&#34;&gt;https://github.com/sirupsen/logrus&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;è·¯ç”±åº“--grollia-mux&#34;&gt;è·¯ç”±åº“  grollia mux&lt;/h3&gt;
&lt;p&gt;æ‘˜æŠ„å®˜æ–¹ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/68747470733a2f2f636c6f75642d63646e2e7175657374696f6e61626c652e73657276696365732f676f72696c6c612d69636f6e2d36342e706e67.png&#34; alt=&#34;Gorilla Logo&#34;&gt;&lt;/p&gt;
&lt;p&gt;Package &lt;code&gt;gorilla/mux&lt;/code&gt; implements a request router and dispatcher for matching incoming requests to their respective handler.&lt;/p&gt;
&lt;p&gt;The name mux stands for &amp;ldquo;HTTP request multiplexer&amp;rdquo;. Like the standard &lt;code&gt;http.ServeMux&lt;/code&gt;, &lt;code&gt;mux.Router&lt;/code&gt; matches incoming requests against a list of registered routes and calls a handler for the route that matches the URL or other conditions. The main features are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;It implements the &lt;code&gt;http.Handler&lt;/code&gt; interface so it is compatible with the standard &lt;code&gt;http.ServeMux&lt;/code&gt;. Go æä¾›çš„http.Handler æ¥å£å¤ªå…·æœ‰æ‰©å±•æ€§äº†ã€‚&lt;/li&gt;
&lt;li&gt;Requests can be matched based on URL host, path, path prefix, schemes, header and query values, HTTP methods or using custom matchers. ä¸°å¯Œçš„è·¯ç”±åŒ¹é…è§„åˆ™ï¼Œhostã€pathã€headerã€query stringéƒ½å¯ä»¥ã€‚&lt;/li&gt;
&lt;li&gt;URL hosts, paths and query values can have variables with an optional regular expression.&lt;/li&gt;
&lt;li&gt;Registered URLs can be built, or &amp;ldquo;reversed&amp;rdquo;, which helps maintaining references to resources.&lt;/li&gt;
&lt;li&gt;Routes can be used as subrouters: nested routes are only tested if the parent route matches. This is useful to define groups of routes that share common conditions like a host, a path prefix or other repeated attributes. As a bonus, this optimizes request matching. åˆ†ç»„åŠŸèƒ½ï¼ŒRESTfulæ¥å£æŒ‰ç…§å®ä½“åˆ†ç»„ï¼Œå¾ˆå®ç”¨ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å¯ä»¥æ­é…åŒç³»åˆ—çš„middlewareé¡¹ç›®ä½¿ç”¨ï¼šhttps://github.com/gorilla/handlersã€‚&lt;/p&gt;
&lt;h4 id=&#34;å‚è€ƒ-4&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;A powerful HTTP router and URL matcher for building Go web servers &lt;a href=&#34;https://github.com/gorilla/mux&#34;&gt;https://github.com/gorilla/mux&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;A collection of useful middleware for Go HTTP services &amp;amp; web applications &lt;a href=&#34;https://github.com/gorilla/handlers&#34;&gt;https://github.com/gorilla/handlers&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Web Server Graceful Shutdown &lt;a href=&#34;https://github.com/gorilla/mux#graceful-shutdown&#34;&gt;https://github.com/gorilla/mux#graceful-shutdown&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;orm-gorm&#34;&gt;ORM gorm&lt;/h3&gt;
&lt;p&gt;æ–‡æ¡£å¾ˆä¸°å¯Œã€‚åŠŸèƒ½å¾ˆå®ç”¨ã€‚æ‘˜æŠ„å®˜æ–¹æ–‡æ¡£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Full-Featured ORM (almost)&lt;/li&gt;
&lt;li&gt;Associations (Has One, Has Many, Belongs To, Many To Many, Polymorphism)&lt;/li&gt;
&lt;li&gt;Hooks (Before/After Create/Save/Update/Delete/Find)&lt;/li&gt;
&lt;li&gt;Preloading (eager loading)&lt;/li&gt;
&lt;li&gt;Transactions&lt;/li&gt;
&lt;li&gt;Composite Primary Key&lt;/li&gt;
&lt;li&gt;SQL Builder&lt;/li&gt;
&lt;li&gt;Auto Migrations è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„ã€‚&lt;/li&gt;
&lt;li&gt;Logger&lt;/li&gt;
&lt;li&gt;Extendable, write Plugins based on GORM callbacks&lt;/li&gt;
&lt;li&gt;Every feature comes with tests&lt;/li&gt;
&lt;li&gt;Developer Friendly&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;å‚è€ƒ-5&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;GORM Guides &lt;a href=&#34;https://gorm.io/docs/&#34;&gt;https://gorm.io/docs/&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;http-client-grequests&#34;&gt;HTTP client grequests&lt;/h3&gt;
&lt;p&gt;å·ç§° Python Requests çš„Go cloneã€‚ç”¨ç€ä¸é”™ã€‚&lt;/p&gt;
&lt;h4 id=&#34;å‚è€ƒ-6&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;A Go &amp;ldquo;clone&amp;rdquo; of the great and famous Requests library &lt;a href=&#34;https://github.com/levigross/grequests&#34;&gt;https://github.com/levigross/grequests&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;errors-githubcompkgerrors&#34;&gt;Errors github.com/pkg/errors&lt;/h3&gt;
&lt;p&gt;å†…ç½®çš„errorså¤ªå¼±äº†ã€‚è¿”å›äº†errorï¼Œä½†æ˜¯å‘¢ï¼Œæ²¡æœ‰è¿”å›ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚è¿™ä¸ªåº“è§£å†³çš„æ˜¯è¿™ä¸ªé—®é¢˜ã€‚&lt;/p&gt;
&lt;h4 id=&#34;å‚è€ƒ-7&#34;&gt;å‚è€ƒ&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;Simple error handling primitives &lt;a href=&#34;https://github.com/pkg/errors&#34;&gt;https://github.com/pkg/errors&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;ä¾èµ–æ³¨å…¥æ¡†æ¶-wire&#34;&gt;ä¾èµ–æ³¨å…¥æ¡†æ¶ wire&lt;/h3&gt;
&lt;p&gt;åŸºäºä»£ç ç”Ÿæˆçš„ä¾èµ–æ³¨å…¥æ¡†æ¶ã€‚å°é¡¹ç›®æ²¡å¿…è¦ä½¿ç”¨ã€‚&lt;/p&gt;
&lt;h3 id=&#34;rpcæ¡†æ¶-grpc&#34;&gt;RPCæ¡†æ¶ gRPC&lt;/h3&gt;
&lt;p&gt;è·¨è¿›ç¨‹ï¼Œè·¨è¯­è¨€é€šä¿¡ã€‚&lt;/p&gt;
&lt;h2 id=&#34;å¸¸ç”¨å·¥å…·&#34;&gt;å¸¸ç”¨å·¥å…·&lt;/h2&gt;
&lt;h3 id=&#34;makefile&#34;&gt;Makefile&lt;/h3&gt;
&lt;p&gt;å°†å¸¸ç”¨çš„å‘½ä»¤æ”¾åœ¨Makefileé‡Œç®¡ç†ã€‚æ¯”å¦‚æ ¼å¼åŒ–ä»£ç  ï¼Œç¼–è¯‘ï¼Œæ‰“åŒ…ï¼Œå¼€å‘ç¯å¢ƒè¿è¡Œç­‰ç­‰ï¼Œå¹¶ç»´æŠ¤å¥½ä¾èµ–å…³ç³»ã€‚&lt;/p&gt;
&lt;p&gt;ä¸è¦å†™ä¸€å †.shè„šæœ¬äº†ã€‚&lt;/p&gt;
&lt;h3 id=&#34;docker&#34;&gt;Docker&lt;/h3&gt;
&lt;p&gt;ç»´æŠ¤ä¸€ä»½Dockerfileï¼Œé¡¹ç›®äº¤ä»˜ç‰©é€šè¿‡åˆ¶ä½œæˆDockeré•œåƒåˆ†å‘ã€‚æ¯”å¦‚ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Dockerfile
FROM alpine:latest
WORKDIR /app
COPY ./dist .
ENTRYPOINT [&amp;quot;./app&amp;quot;, &amp;quot;serve&amp;quot;]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;å¯ä»¥é€šè¿‡Dockeræ¥æ„å»ºGoé¡¹ç›®ï¼ˆä¸€ä¸ªä¸¤é˜¶æ®µçš„Dockerfileï¼‰ã€‚ä¹Ÿå¯ä»¥åƒæˆ‘è¿™æ ·ï¼Œåœ¨å®¿ä¸»æœºå°±æ„å»ºå¥½ï¼ŒDockerfileåªéœ€è¦COPYç¼–è¯‘äº§ç‰©å³å¯ã€‚&lt;/p&gt;
&lt;h3 id=&#34;swagger&#34;&gt;Swagger&lt;/h3&gt;
&lt;p&gt;ç›®å‰æ²¡æœ‰æ–¹ä¾¿çš„ç”Ÿæˆæ–¹æ³•ï¼Œå¾—æ‰‹å†™æ³¨é‡Šï¼&lt;/p&gt;
&lt;h2 id=&#34;é¡¹ç›®ç»“æ„&#34;&gt;é¡¹ç›®ç»“æ„&lt;/h2&gt;
&lt;p&gt;Go webé¡¹ç›®ç»“æ„æ²¡æœ‰å®šå¼ï¼Œæ¯ä¸ªäººçš„é£æ ¼éƒ½ä¸ä¸€æ ·ã€‚å‚è€ƒäº†è¿™ä¸ªç³»åˆ—æ–‡ç« ï¼Œè§‰å¾—ä¸é”™ï¼Œç‰¹åˆ«æ˜¯ç¬¬äºŒç¯‡ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Go Web Application Structure - Part 1 &lt;a href=&#34;https://aaf.engineering/go-web-application-structure-pt-1/&#34;&gt;https://aaf.engineering/go-web-application-structure-pt-1/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Go Web Application Structure - Part 2 - Routing/Serving&lt;/strong&gt; &lt;a href=&#34;https://aaf.engineering/go-web-application-structure-part-2/&#34;&gt;https://aaf.engineering/go-web-application-structure-part-2/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Go Web Application Structure - Part 3 - The Database &lt;a href=&#34;https://aaf.engineering/go-web-application-structure-part-3/&#34;&gt;https://aaf.engineering/go-web-application-structure-part-3/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Go Web Application Structure - Part 4 - Database Migrations &amp;amp; Business Logic &lt;a href=&#34;https://aaf.engineering/go-web-application-structure-part-4/&#34;&gt;https://aaf.engineering/go-web-application-structure-part-4/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;code &lt;a href=&#34;https://github.com/theaaf/todos&#34;&gt;https://github.com/theaaf/todos&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å±‚çº§è°ƒç”¨é“¾ï¼šcmd -&amp;gt; api -&amp;gt; app -&amp;gt; dbã€‚model/configæ¨ªåˆ‡ï¼Œå…¶å®ƒå±‚å…±äº«ä¹‹ã€‚&lt;/p&gt;
&lt;h3 id=&#34;model-database-models&#34;&gt;model: database models&lt;/h3&gt;
&lt;p&gt;æ¨¡å‹å®ä½“ï¼Œé€šè¿‡åˆ†æéœ€æ±‚å»ºæ¨¡ï¼Œåˆç†çš„å»ºæ¨¡ä¾¿äºåæœŸç»´æŠ¤ã€‚&lt;/p&gt;
&lt;p&gt;æ¨ªåˆ‡å±‚ã€‚å…¶ä»–æ¯å±‚éƒ½ä¼šç”¨åˆ°ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200320170405357.png&#34; alt=&#34;image-20200320170405357&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;config&#34;&gt;config&lt;/h3&gt;
&lt;p&gt;æ¨ªåˆ‡å±‚ã€‚&lt;/p&gt;
&lt;p&gt;å¹¶æ²¡æœ‰è‡ªå·±ç‹¬ç«‹çš„åŒ…ï¼Œè€Œæ˜¯å…¶ä»–æ¯å±‚éƒ½å¯ä»¥æ ¹æ®éœ€è¦ï¼Œæœ‰ä¸€ä¸ªè‡ªå·±ç‹¬ç«‹çš„Configç»“æ„ä½“ã€‚é€šè¿‡ä¸€ä¸ªå…¨å±€çš„Viperå˜é‡ï¼Œå–å‡ºè¯¥å±‚å…³å¿ƒçš„é…ç½®å˜é‡ï¼ˆæˆ–æ˜¯ä»é…ç½®æ–‡ä»¶ï¼Œæˆ–æ˜¯ä»ç¯å¢ƒå˜é‡ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;æ¯”å¦‚æ•°æ®å±‚çš„configï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200320170301550.png&#34; alt=&#34;image-20200320170301550&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;db-database-operations&#34;&gt;db: database operations&lt;/h3&gt;
&lt;p&gt;æ•°æ®æŒä¹…åŒ–å±‚ï¼Œåº•å±‚ã€‚CRUDæ“ä½œçš„å°è£…ã€‚é€šè¿‡â€œæ„é€ å‡½æ•°â€åšä¾èµ–æ³¨å…¥ï¼Œæ–¹ä¾¿å•å…ƒæµ‹è¯•ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200320170627650.png&#34; alt=&#34;image-20200320170627650&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;app-business-logic&#34;&gt;app: business logic&lt;/h3&gt;
&lt;p&gt;ä¸šåŠ¡é€»è¾‘å±‚ï¼Œä¸­å±‚ï¼Œæ ¸å¿ƒå±‚ã€‚è°ƒç”¨æ•°æ®å±‚ï¼ŒåŠå…¶ä»–åº•å±‚æœåŠ¡ï¼Œæ¯”å¦‚S3äº‘å­˜å‚¨ç­‰ã€‚&lt;/p&gt;
&lt;h4 id=&#34;ä¸‰ç±»é”™è¯¯&#34;&gt;ä¸‰ç±»é”™è¯¯&lt;/h4&gt;
&lt;p&gt;è¯¥å±‚æ–¹æ³•è¿”å›çš„é”™è¯¯å¯ä»¥åˆ†ä¸‰ç±»ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ValidationError è¾“å…¥ä¸æ­£ç¡®ï¼Œæ ¡éªŒä¸é€šè¿‡ï¼Œæ¯”å¦‚æ‰‹æœºå·é•¿åº¦ä¸å¯¹ã€‚å¯¹åº”çš„HTTPçŠ¶æ€ç ï¼š400ã€‚&lt;/li&gt;
&lt;li&gt;UserError è®¤è¯é”™è¯¯ï¼Œæ¯”å¦‚ç”¨æˆ·ç™»å½•å¤±è´¥ï¼Œç”¨æˆ·æ²¡æœ‰æƒé™ã€‚å¯¹åº”çš„HTTPçŠ¶æ€ç ï¼š401, 403ã€‚&lt;/li&gt;
&lt;li&gt;ServerError ç³»ç»Ÿé”™è¯¯ï¼Œæ¯”å¦‚æ•°æ®åº“è¿ä¸ä¸Šï¼Œä¹Ÿä¸éœ€è¦ç‰¹åˆ«å®šä¹‰ServerErrorï¼šåªè¦errorä¸æ˜¯ValidationErrorï¼ŒUserErrorï¼Œå°±æ˜¯ServerErrorã€‚å¯¹åº”çš„HTTPçŠ¶æ€ç ï¼š500ã€‚&lt;/li&gt;
&lt;li&gt;æ²¡æœ‰é”™è¯¯ï¼Œé‚£ä¹ˆå¯¹åº”çš„HTTPçŠ¶æ€ç å°±æ˜¯200ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;api-api-controllers&#34;&gt;api: api controllers&lt;/h3&gt;
&lt;p&gt;æ¥å£å±‚ã€‚å°½å¯èƒ½è½»é‡ï¼Œå°½å¯èƒ½æ²¡æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œåªè´Ÿè´£è½¬è¯‘ã€‚é€šè¿‡è°ƒç”¨ä¸šåŠ¡é€»è¾‘å±‚å®Œæˆä»»åŠ¡ã€‚å°†ä¸Šè¿°ä¸‰åˆ†ç±»é”™è¯¯æ˜ å°„åˆ°åˆé€‚çš„çŠ¶æ€ç ã€‚&lt;/p&gt;
&lt;h4 id=&#34;application-state-vs-request-state&#34;&gt;Application State vs. Request State&lt;/h4&gt;
&lt;p&gt;è¯·æ±‚å…¥å£å‡½æ•°éœ€è¦ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªcontextï¼ˆä¸Šä¸‹æ–‡ï¼‰ã€‚contextåŒ…å«å¦‚ä¸‹ï¼Œæ‘˜æŠ„åŸæ–‡ã€‚åŒ…å«çš„å­—æ®µéœ€æ»¡è¶³å®Œæˆrequestçš„æ‰€éœ€ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;../../images/image-20200320181127465.png&#34; alt=&#34;image-20200320181127465&#34;&gt;&lt;/p&gt;
&lt;h4 id=&#34;request-context-è¯·æ±‚ä¸Šä¸‹æ–‡ä¿¡æ¯&#34;&gt;(Request) Context è¯·æ±‚ä¸Šä¸‹æ–‡ä¿¡æ¯&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;Remote IPåœ°å€ï¼Œæ˜¾ç¤ºäºaccess logã€‚ä½¿ç”¨logrus.WithField()ã€‚&lt;/li&gt;
&lt;li&gt;Request IDï¼Œæ˜¾ç¤ºäºaccess logã€‚ä½¿ç”¨logrus.WithField()ã€‚&lt;/li&gt;
&lt;li&gt;Userï¼Œç”¨äºåç»­é‰´æƒã€‚å¦‚æœæœ‰è®¤è¯å¤´ä¿¡æ¯ï¼ˆAuth Tokenï¼‰ï¼Œä»æ•°æ®åº“å–å‡ºç”¨æˆ·ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;cmd-command-line-methods&#34;&gt;cmd: command line methods&lt;/h3&gt;
&lt;p&gt;ä½¿ç”¨Cobraç”Ÿæˆå­å‘½ä»¤ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;app serve &lt;/code&gt;&lt;/p&gt;
&lt;p&gt;å¯åŠ¨web serverï¼Œå¹¶åŠ å…¥web serverä¼˜é›…é€€å‡ºçš„åŠŸèƒ½ã€‚&lt;/p&gt;
- https://xujiahua.github.io/posts/20200320-go-web-project/ - </description>
        </item>
    
    
  </channel>
</rss> 